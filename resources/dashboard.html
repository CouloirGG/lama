<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LAMA</title>
  <link rel="icon" href="/favicon.ico" type="image/x-icon" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap');
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.3} }
    @keyframes spin { to { transform: rotate(360deg); } }
    /* Overlay border pulse animations */
    @keyframes borderRainbow {
      0%   { border-color: #FF4040; color: #40CCFF; }
      16%  { border-color: #FF8C00; color: #FF69B4; }
      33%  { border-color: #FFD700; color: #FF4040; }
      50%  { border-color: #40FF40; color: #FF8C00; }
      66%  { border-color: #40CCFF; color: #FFD700; }
      83%  { border-color: #FF69B4; color: #40FF40; }
      100% { border-color: #FF4040; color: #40CCFF; }
    }
    @keyframes borderGoldFast { 0%,100% { border-color: #FF4500; } 50% { border-color: #FFD700; } }
    @keyframes borderGoldMed  { 0%,100% { border-color: #FFD700; } 50% { border-color: #B8860B; } }
    @keyframes borderGoldSlow { 0%,100% { border-color: #FFD700; } 50% { border-color: #8B7536; } }
    /* POE2 Gothic blood-stained border pulse animations */
    @keyframes borderBloodRainbow {
      0%   { border-color: #8b1a1a; color: #6b5a2e; }
      16%  { border-color: #a85520; color: #7a2020; }
      33%  { border-color: #c4a456; color: #8b1a1a; }
      50%  { border-color: #5c1510; color: #a85520; }
      66%  { border-color: #6b5a2e; color: #c4a456; }
      83%  { border-color: #7a2020; color: #5c1510; }
      100% { border-color: #8b1a1a; color: #6b5a2e; }
    }
    @keyframes borderBloodFast { 0%,100% { border-color: #8b1a1a; } 50% { border-color: #a85520; } }
    @keyframes borderBloodMed  { 0%,100% { border-color: #a85520; } 50% { border-color: #6b5a2e; } }
    @keyframes borderBloodSlow { 0%,100% { border-color: #6b5a2e; } 50% { border-color: #5a4a30; } }
    /* Sheen sweep — translucent light band ping-pongs inside the overlay */
    @keyframes sheenSweep {
      0%   { left: 0%; opacity: 0.8; }
      45%  { left: 72%; opacity: 0.9; }
      50%  { left: 72%; opacity: 0.7; }
      95%  { left: 0%; opacity: 0.9; }
      100% { left: 0%; opacity: 0.8; }
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { width: 100%; height: 100%; overflow: hidden; margin: 0; padding: 0; }
    body { background: radial-gradient(ellipse at center, #1a1510 0%, #0d0b08 70%); color: #d4c9a8; font-family: 'DM Sans', 'Segoe UI', system-ui, sans-serif; }
    #root { width: 100%; height: 100%; }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #3a3128; border-radius: 3px; }
    input:focus, select:focus { outline: none; border-color: #c4a456 !important; }
    select option { background: #12100c; color: #d4c9a8; }

    /* POE2 App Frame */
    .app-frame {
      position: relative;
      border: 1px solid #6b5a3e;
      box-shadow:
        inset 0 0 60px rgba(196,164,86,0.04),
        0 0 0 4px #0d0b08,
        0 0 0 5px #3a3128,
        0 0 40px rgba(0,0,0,0.5);
      margin: 8px;
      height: calc(100vh - 16px);
      display: flex;
      flex-direction: column;
      border-radius: 10px;
      overflow: hidden;
    }

    /* Custom window title bar */
    .window-titlebar {
      display: flex;
      align-items: center;
      height: 36px;
      padding: 0 4px 0 12px;
      flex-shrink: 0;
      user-select: none;
    }
    .window-btn {
      width: 36px; height: 28px;
      border: none; background: transparent;
      color: #8c7a5c; cursor: pointer;
      display: inline-flex; align-items: center; justify-content: center;
      font-size: 14px; line-height: 1;
      transition: background 0.15s, color 0.15s;
      border-radius: 4px;
    }
    .window-btn:hover { background: rgba(196,164,86,0.12); color: #c4a456; }
    .window-btn-close:hover { background: rgba(200,50,50,0.4); color: #ff6666; }

    /* Footer branding */
    .app-footer {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 10px;
      padding: 6px 16px;
      flex-shrink: 0;
      user-select: none;
      border-top: 1px solid rgba(107,90,62,0.3);
    }
    .footer-email {
      font-size: 10px;
      color: #5c4f3d;
      text-decoration: none;
      transition: color 0.15s;
      letter-spacing: 0.03em;
    }
    .footer-email:hover { color: #c4a456; }

    /* Couloir flyout */
    @keyframes flyoutIn {
      from { opacity: 0; transform: translateY(8px) scale(0.97); }
      to   { opacity: 1; transform: translateY(0) scale(1); }
    }
    .couloir-flyout {
      position: absolute;
      bottom: calc(100% + 8px);
      right: 0;
      width: 340px;
      background: #141110;
      border: 1px solid #6b5a3e;
      border-radius: 10px;
      box-shadow: 0 -4px 30px rgba(0,0,0,0.6), 0 0 0 1px rgba(196,164,86,0.08);
      padding: 20px;
      animation: flyoutIn 0.25s ease-out;
      z-index: 100;
    }
    .couloir-flyout-link {
      color: #8c7a5c;
      text-decoration: none;
      transition: color 0.15s;
    }
    .couloir-flyout-link:hover { color: #c4a456; }

    /* Gold header divider */
    .gold-divider {
      position: relative; height: 1px;
      background: linear-gradient(90deg, transparent, #6b5a3e 20%, #6b5a3e 80%, transparent);
      margin: 0;
    }
    .gold-divider::after {
      content: ''; position: absolute;
      left: 50%; top: 50%;
      transform: translate(-50%, -50%) rotate(45deg);
      width: 6px; height: 6px;
      background: #c4a456; border: 1px solid #6b5a3e;
    }

    /* Panel corner accents */
    .panel {
      position: relative;
      transition: box-shadow 0.25s ease;
    }
    .panel:hover {
      box-shadow: 0 0 12px rgba(196,164,86,0.08);
    }
    .panel::before, .panel::after {
      content: ''; position: absolute;
      width: 10px; height: 10px;
      pointer-events: none; z-index: 1;
    }
    .panel::before {
      top: -1px; left: -1px;
      border-top: 1.5px solid #6b5a3e;
      border-left: 1.5px solid #6b5a3e;
    }
    .panel::after {
      bottom: -1px; right: -1px;
      border-bottom: 1.5px solid #6b5a3e;
      border-right: 1.5px solid #6b5a3e;
    }

    /* Tab styling */
    .poe-tab {
      position: relative;
      border-radius: 6px 6px 0 0 !important;
      transition: all 0.2s ease !important;
      border: 1px solid transparent !important;
      border-bottom: none !important;
      margin-bottom: -1px;
    }
    .poe-tab:hover { background: rgba(196,164,86,0.06) !important; }
    .poe-tab-active {
      background: rgba(196,164,86,0.15) !important;
      border-color: #3a3128 !important;
      border-bottom: 1px solid #0d0b08 !important;
    }

    /* Button hover effects */
    .btn-gold-hover:hover { box-shadow: 0 0 12px rgba(196,164,86,0.2); }
    .btn-danger-hover:hover { box-shadow: 0 0 12px rgba(168,50,50,0.25); }

    /* Accordion expanded gold accent */
    .accordion-expanded {
      border-left: 2px solid #c4a456 !important;
    }

    /* Shimmer animation */
    @keyframes goldShimmer {
      0%, 100% { box-shadow: inset 0 0 60px rgba(196,164,86,0.04), 0 0 0 4px #0d0b08, 0 0 0 5px #3a3128, 0 0 40px rgba(0,0,0,0.5); }
      50% { box-shadow: inset 0 0 60px rgba(196,164,86,0.07), 0 0 0 4px #0d0b08, 0 0 0 5px #3a3128, 0 0 40px rgba(0,0,0,0.5); }
    }
    .app-frame { animation: goldShimmer 8s ease-in-out infinite; }
    /* Hide TradingView Lightweight Charts attribution watermark */
    [class*="attribution"], a[href*="tradingview.com"] { display: none !important; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script src="https://unpkg.com/lightweight-charts@4/dist/lightweight-charts.standalone.production.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback, useMemo } = React;

    // -----------------------------------------------------------------------
    // Config
    // -----------------------------------------------------------------------
    const PORT = 8450;
    const API_BASE = `http://127.0.0.1:${PORT}`;
    const WS_URL = `ws://127.0.0.1:${PORT}/ws`;

    // -----------------------------------------------------------------------
    // POE2 Theme
    // -----------------------------------------------------------------------
    const T = {
      bg:          "#0d0b08",
      card:        "#1c1814",
      input:       "#12100c",
      border:      "#3a3128",
      borderGold:  "#6b5a3e",
      text:        "#d4c9a8",
      textSecond:  "#8c7a5c",
      textMuted:   "#5c4f3d",
      gold:        "#c4a456",
      green:       "#4a7c59",
      red:         "#a83232",
      amber:       "#b8860b",
      cyan:        "#6b8f71",
      purple:      "#9b8a6e",
    };

    const MONO = { fontFamily: "'JetBrains Mono', 'Fira Code', 'Cascadia Code', monospace" };
    const LABEL = { fontSize: 10, fontWeight: 700, color: T.textSecond, letterSpacing: "0.1em", textTransform: "uppercase" };
    const FIELD_LABEL = { fontSize: 10, fontWeight: 600, display: "block", marginBottom: 4, letterSpacing: "0.08em", color: T.textSecond };
    const FIELD_INPUT = { width: "100%", background: T.input, border: `1px solid ${T.border}`, borderRadius: 5, color: T.text, padding: "7px 10px", ...MONO, fontSize: 12 };
    const CARD = { background: T.card, border: `1px solid ${T.border}`, borderRadius: 8, padding: 16 };
    const BTN = { border: "none", borderRadius: 6, padding: "8px 18px", fontSize: 12, fontWeight: 600, cursor: "pointer", letterSpacing: "0.04em", transition: "all 0.15s ease" };
    const BTN_GOLD = { ...BTN, background: T.input, border: `1px solid ${T.borderGold}`, color: T.gold };
    const BTN_GOLD_ACTIVE = { ...BTN, background: T.gold, border: `1px solid ${T.gold}`, color: "#0d0b08" };

    const OVERLAY_STATES = {
      stopped: { label: "STOPPED", color: T.textSecond, bg: "rgba(140,122,92,0.1)" },
      starting: { label: "STARTING", color: T.amber, bg: "rgba(184,134,11,0.12)" },
      running: { label: "RUNNING", color: T.green, bg: "rgba(74,124,89,0.15)" },
      error: { label: "ERROR", color: T.red, bg: "rgba(168,50,50,0.12)" },
    };

    // -----------------------------------------------------------------------
    // Filter defaults (mirrors filter_updater.py STYLE_* constants)
    // -----------------------------------------------------------------------
    const DEFAULT_TIER_STYLES = {
      s: { font_size: 45, text_color: "#ff0000", border_color: "#ff0000", bg_color: "#ffffff", sound_enabled: true, sound_id: 6, beam_enabled: true, beam_color: "Red", minimap_enabled: true },
      a: { font_size: 45, text_color: "#ffffff", border_color: "#ffffff", bg_color: "#f5695a", sound_enabled: true, sound_id: 1, beam_enabled: true, beam_color: "Red", minimap_enabled: true },
      b: { font_size: 42, text_color: "#000000", border_color: "#000000", bg_color: "#f5695a", sound_enabled: true, sound_id: 2, beam_enabled: true, beam_color: "Yellow", minimap_enabled: true },
      c: { font_size: 38, text_color: "#000000", border_color: "#000000", bg_color: "#d2a050", sound_enabled: false, sound_id: 0, beam_enabled: false, beam_color: "Red", minimap_enabled: false },
      d: { font_size: 38, text_color: "#000000", border_color: "#000000", bg_color: "#d2a050", sound_enabled: false, sound_id: 0, beam_enabled: false, beam_color: "Red", minimap_enabled: false },
      e: { font_size: 32, text_color: "#c8c8c8", border_color: "#000000", bg_color: "#000000", sound_enabled: false, sound_id: 0, beam_enabled: false, beam_color: "Red", minimap_enabled: false },
      t1: { font_size: 45, text_color: "#ff0000", border_color: "#ff0000", bg_color: "#ffffff", sound_enabled: true, sound_id: 6, beam_enabled: true, beam_color: "Red", minimap_enabled: true },
      t2: { font_size: 45, text_color: "#ffffff", border_color: "#ffffff", bg_color: "#f5695a", sound_enabled: true, sound_id: 1, beam_enabled: true, beam_color: "Red", minimap_enabled: true },
      t3: { font_size: 38, text_color: "#bc6025", border_color: "#bc6025", bg_color: "#000000", sound_enabled: false, sound_id: 0, beam_enabled: true, beam_color: "Brown", minimap_enabled: true },
      hideable: { font_size: 32, text_color: "#c8c8c8", border_color: "#000000", bg_color: "#000000", sound_enabled: false, sound_id: 0, beam_enabled: false, beam_color: "Red", minimap_enabled: true },
    };

    // Gear style defaults per rarity (mirrors filter_updater.py STYLE_GEAR_*)
    const DEFAULT_GEAR_STYLES = {
      gear_rare:   { font_size: 28, text_color: "#dcc864", border_color: "#000000", bg_color: "#000000", sound_enabled: false, sound_id: 0, beam_enabled: false, beam_color: "Red", minimap_enabled: false },
      gear_magic:  { font_size: 28, text_color: "#8888ff", border_color: "#000000", bg_color: "#000000", sound_enabled: false, sound_id: 0, beam_enabled: false, beam_color: "Red", minimap_enabled: false },
      gear_normal: { font_size: 28, text_color: "#c8c8c8", border_color: "#000000", bg_color: "#000000", sound_enabled: false, sound_id: 0, beam_enabled: false, beam_color: "Red", minimap_enabled: false },
    };

    const GEAR_SECTIONS = [
      { id: "gear_rare", label: "Rare Gear" },
      { id: "gear_magic", label: "Magic Gear" },
      { id: "gear_normal", label: "Normal / Endgame Gear" },
    ];

    const GEAR_CLASSES = [
      { category: "Weapons", classes: [
        "Bows", "Crossbows", "One Hand Swords", "Two Hand Swords",
        "One Hand Axes", "Two Hand Axes", "One Hand Maces", "Two Hand Maces",
        "Daggers", "Claws", "Flails", "Spears", "Wands", "Staves", "Sceptres",
      ]},
      { category: "Armour", classes: [
        "Body Armours", "Helmets", "Gloves", "Boots",
        "Shields", "Bucklers", "Foci",
      ]},
      { category: "Accessories", classes: [
        "Rings", "Amulets", "Belts", "Quivers",
      ]},
    ];

    // Uniques shown in Gear card (not Economy)
    const UNIQUE_SECTION = { id: "uniques", label: "Uniques", tiers: ["t1", "t2", "t3", "hideable"], thresholdType: "unique" };

    const ECONOMY_SECTIONS = [
      { id: "currency", label: "Currency", tiers: ["s", "a", "b", "c", "d", "e"], thresholdType: "currency" },
      { id: "currency->emotions", label: "Distilled Emotions", tiers: ["s", "a", "b", "c", "d", "e"], thresholdType: "currency" },
      { id: "currency->catalysts", label: "Breach", tiers: ["s", "a", "b", "c", "d", "e"], thresholdType: "currency" },
      { id: "currency->essence", label: "Essences", tiers: ["s", "a", "b", "c", "d", "e"], thresholdType: "currency" },
      { id: "currency->omen", label: "Omens", tiers: ["s", "a", "b", "c", "d", "e"], thresholdType: "currency" },
      { id: "sockets->general", label: "Runes & Sockets", tiers: ["s", "a", "b", "c", "d", "e"], thresholdType: "currency" },
      { id: "fragments->generic", label: "Fragments", tiers: ["a", "b", "c"], thresholdType: "fragment" },
    ];

    // Base chaos thresholds (mirrors config.py FILTER_*_CHAOS_THRESHOLDS)
    const BASE_THRESHOLDS = {
      currency: { s: 25, a: 5, b: 2, c: 1, d: 1, e: 0 },
      unique:   { t1: 25, t2: 3, t3: 0.5, hideable: 0 },
      fragment: { a: 5, b: 1, c: 0 },
    };
    const STRICTNESS_MULT = { relaxed: 0.5, normal: 1.0, strict: 2.0, very_strict: 4.0 };

    function getEffectiveThreshold(tier, thresholdType, strictness) {
      const mult = STRICTNESS_MULT[strictness] || 1.0;
      const base = BASE_THRESHOLDS[thresholdType];
      if (!base || base[tier] === undefined) return null;
      return base[tier] * mult;
    }

    function formatChaos(val) {
      if (val === 0) return "all";
      if (val >= 1) return `≥${Math.round(val * 10) / 10}c`;
      return `≥${val.toFixed(1)}c`;
    }

    const TIER_LABELS = {
      s: "S Tier", a: "A Tier", b: "B Tier", c: "C Tier", d: "D Tier", e: "E Tier",
      t1: "T1", t2: "T2", t3: "T3", hideable: "Hideable",
    };

    const BEAM_COLORS = ["Red", "Yellow", "Blue", "Orange", "Brown"];
    const SOUND_IDS = Array.from({ length: 17 }, (_, i) => i);

    // Sample item names for style preview
    const TIER_PREVIEW_NAMES = {
      s: "Divine Orb", a: "Exalted Orb", b: "Chaos Orb",
      c: "Regal Orb", d: "Alchemy Orb", e: "Transmutation Orb",
      t1: "Headhunter", t2: "Goldrim", t3: "Unique Helm", hideable: "Cheap Unique",
      gear_rare: "Rare Vaal Axe", gear_magic: "Magic Corsair Sword", gear_normal: "Iron Hat",
    };

    // Sample items for strictness visualization (values chosen to shift tiers visibly)
    const STRICTNESS_SAMPLES = [
      { name: "Exalted Orb",  chaos: 30 },
      { name: "Regal Orb",    chaos: 8 },
      { name: "Chaos Orb",    chaos: 2.5 },
      { name: "Alchemy Orb",  chaos: 1.2 },
      { name: "Transmute",    chaos: 0.3 },
    ];

    function getTierForValue(chaosValue, strictness) {
      const mult = STRICTNESS_MULT[strictness] || 1.0;
      const t = BASE_THRESHOLDS.currency;
      if (chaosValue >= t.s * mult) return "s";
      if (chaosValue >= t.a * mult) return "a";
      if (chaosValue >= t.b * mult) return "b";
      if (chaosValue >= t.c * mult) return "c";
      return "e";
    }

    // -----------------------------------------------------------------------
    // Color presets (applied to tier styles on selection)
    // -----------------------------------------------------------------------
    const COLOR_PRESETS = {
      default: {
        label: "Default",
        desc: "Standard POE2 filter colors",
        tiers: {}, // empty = use DEFAULT_TIER_STYLES as-is
      },
      colorblind: {
        label: "Colorblind Safe",
        desc: "Blue-orange palette (deuteranopia/protanopia)",
        tiers: {
          s:  { text_color: "#ffffff", border_color: "#0066ff", bg_color: "#0055dd" },
          a:  { text_color: "#000000", border_color: "#ff8800", bg_color: "#ff8800" },
          b:  { text_color: "#ffffff", border_color: "#7733cc", bg_color: "#6633aa" },
          c:  { text_color: "#000000", border_color: "#ddbb00", bg_color: "#ddbb00" },
          d:  { text_color: "#ffffff", border_color: "#008888", bg_color: "#007777" },
          e:  { text_color: "#c8c8c8", border_color: "#000000", bg_color: "#000000" },
          t1: { text_color: "#ffffff", border_color: "#0066ff", bg_color: "#0055dd" },
          t2: { text_color: "#000000", border_color: "#ff8800", bg_color: "#ff8800" },
          t3: { text_color: "#bc6025", border_color: "#bc6025", bg_color: "#000000" },
          hideable: { text_color: "#c8c8c8", border_color: "#000000", bg_color: "#000000" },
        },
      },
      high_contrast: {
        label: "High Contrast",
        desc: "Maximum visibility for all tiers",
        tiers: {
          s:  { text_color: "#ffffff", border_color: "#ff0000", bg_color: "#cc0000" },
          a:  { text_color: "#000000", border_color: "#ffaa00", bg_color: "#ffaa00" },
          b:  { text_color: "#000000", border_color: "#00cc00", bg_color: "#00cc00" },
          c:  { text_color: "#ffffff", border_color: "#0088ff", bg_color: "#0066cc" },
          d:  { text_color: "#000000", border_color: "#cc66ff", bg_color: "#aa44dd" },
          e:  { text_color: "#999999", border_color: "#333333", bg_color: "#111111" },
          t1: { text_color: "#ffffff", border_color: "#ff0000", bg_color: "#cc0000" },
          t2: { text_color: "#000000", border_color: "#ffaa00", bg_color: "#ffaa00" },
          t3: { text_color: "#ffffff", border_color: "#0088ff", bg_color: "#0066cc" },
          hideable: { text_color: "#999999", border_color: "#333333", bg_color: "#111111" },
        },
      },
    };

    // Get effective tier style: preset base → user overrides on top
    function getEffectiveTierStyle(tier, tierStyles, colorPreset) {
      const presetColors = COLOR_PRESETS[colorPreset]?.tiers[tier] || {};
      return { ...DEFAULT_TIER_STYLES[tier], ...presetColors, ...(tierStyles[tier] || {}) };
    }

    // -----------------------------------------------------------------------
    // API helper
    // -----------------------------------------------------------------------
    async function api(path, method = "GET", body = null) {
      const opts = { method, headers: { "Content-Type": "application/json" } };
      if (body) opts.body = JSON.stringify(body);
      try {
        const res = await fetch(`${API_BASE}${path}`, opts);
        const raw = await res.text();
        let data = {};
        try { data = raw ? JSON.parse(raw) : {}; } catch { data = { raw }; }
        if (!res.ok) return { error: data?.error || data?.detail || `HTTP ${res.status}`, ...data };
        return data;
      } catch (e) {
        return { error: e.message };
      }
    }

    // -----------------------------------------------------------------------
    // WebSocket hook
    // -----------------------------------------------------------------------
    function useDashboardSocket(url, onMessage) {
      const wsRef = useRef(null);
      const [connected, setConnected] = useState(false);
      const reconnectRef = useRef(null);
      const disconnectTimerRef = useRef(null);
      const onMessageRef = useRef(onMessage);
      onMessageRef.current = onMessage;

      const connect = useCallback(() => {
        if (wsRef.current?.readyState === WebSocket.OPEN) return;
        const ws = new WebSocket(url);
        wsRef.current = ws;
        ws.onopen = () => {
          if (disconnectTimerRef.current) { clearTimeout(disconnectTimerRef.current); disconnectTimerRef.current = null; }
          setConnected(true);
          if (reconnectRef.current) { clearTimeout(reconnectRef.current); reconnectRef.current = null; }
        };
        ws.onmessage = (evt) => { try { onMessageRef.current(JSON.parse(evt.data)); } catch (e) { console.error("WS parse:", e); } };
        ws.onclose = () => {
          if (!disconnectTimerRef.current) {
            disconnectTimerRef.current = setTimeout(() => { setConnected(false); disconnectTimerRef.current = null; }, 800);
          }
          reconnectRef.current = setTimeout(connect, 2000);
        };
        ws.onerror = () => ws.close();
      }, [url]);

      useEffect(() => { connect(); return () => { wsRef.current?.close(); if (reconnectRef.current) clearTimeout(reconnectRef.current); if (disconnectTimerRef.current) clearTimeout(disconnectTimerRef.current); }; }, [connect]);
      return { connected };
    }

    // -----------------------------------------------------------------------
    // Time formatting
    // -----------------------------------------------------------------------
    function formatUptime(seconds) {
      if (!seconds || seconds <= 0) return "0s";
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      const s = seconds % 60;
      if (h > 0) return `${h}h ${m}m`;
      if (m > 0) return `${m}m ${s}s`;
      return `${s}s`;
    }

    // -----------------------------------------------------------------------
    // Gold Divider
    // -----------------------------------------------------------------------
    function GoldDivider({ style: extraStyle }) {
      return <div className="gold-divider" style={{ marginBottom: 20, ...extraStyle }} />;
    }

    // -----------------------------------------------------------------------
    // Flavor text constants
    // -----------------------------------------------------------------------
    const WATCHLIST_QUOTES = [
      "Still sane, Exile?",
      "The trade board awaits...",
      "Fortune favors the bold, Exile.",
      "What are you searching for?",
    ];
    const TAB_SUBTITLES = {
      overlay: "Your Eyes in Wraeclast",
      filter: "Separate Treasure from Trash",
      watchlist: "The Trade Board",
      markets: "The Exchange Floor",
    };

    // -----------------------------------------------------------------------
    // Window Title Bar (frameless mode)
    // -----------------------------------------------------------------------
    function WindowTitleBar({ wsConnected, overlayState }) {
      const minimize = () => window.pywebview?.api?.minimize();
      const toggleMax = () => window.pywebview?.api?.toggle_maximize();
      const close = () => window.pywebview?.api?.close();
      const showBadge = overlayState !== "stopped";
      const badgeConf = {
        running:  { color: T.green, label: "Scanning", pulse: true },
        starting: { color: T.amber, label: "Starting...", pulse: false },
        error:    { color: T.red, label: "Error", pulse: false },
      };
      const badge = badgeConf[overlayState];

      return (
        <div className="window-titlebar pywebview-drag-region" style={{ height: 36 }}>
          <div style={{ fontSize: 13, fontWeight: 700, color: T.gold, textShadow: "0 0 12px rgba(196,164,86,0.3)" }}>
            LAMA
          </div>
          <div style={{ display: "flex", alignItems: "center", gap: 6, marginLeft: 10 }}>
            <div style={{
              display: "inline-flex", alignItems: "center", gap: 4,
              fontSize: 9, fontWeight: 600, color: wsConnected ? T.green : T.red,
            }}>
              <span style={{ width: 5, height: 5, borderRadius: "50%", background: wsConnected ? T.green : T.red, animation: wsConnected ? "none" : "pulse 1.5s infinite" }} />
              {wsConnected ? "Connected" : "Reconnecting"}
            </div>
            {showBadge && badge && (
              <div style={{
                display: "inline-flex", alignItems: "center", gap: 4,
                fontSize: 9, fontWeight: 600, color: badge.color,
              }}>
                <span style={{ width: 5, height: 5, borderRadius: "50%", background: badge.color, animation: badge.pulse ? "pulse 2s infinite" : "none" }} />
                {badge.label}
              </div>
            )}
          </div>
          <div style={{ flex: 1 }} />
          <div style={{ display: "flex", gap: 0 }}>
            <button className="window-btn" onClick={minimize}>&#8211;</button>
            <button className="window-btn" onClick={toggleMax}>&#9633;</button>
            <button className="window-btn window-btn-close" onClick={close}>&#10005;</button>
          </div>
        </div>
      );
    }

    // Brand Footer
    // -----------------------------------------------------------------------
    function BrandFooter({ leagues, selectedLeague, onLeagueChange, onBugReport, onFeedback, onFeatureRequest, onRestartApp }) {
      const [flyoutOpen, setFlyoutOpen] = useState(false);
      const flyoutRef = useRef(null);

      useEffect(() => {
        if (!flyoutOpen) return;
        const handleClick = (e) => {
          if (flyoutRef.current && !flyoutRef.current.contains(e.target)) setFlyoutOpen(false);
        };
        document.addEventListener("mousedown", handleClick);
        return () => document.removeEventListener("mousedown", handleClick);
      }, [flyoutOpen]);

      return (
        <div className="app-footer" style={{ position: "relative" }} ref={flyoutRef}>
          <select
            value={selectedLeague || "Fate of the Vaal"}
            onChange={(e) => onLeagueChange(e.target.value)}
            style={{
              background: T.input, border: `1px solid ${T.border}`, borderRadius: 4,
              color: T.textSecond, padding: "3px 8px", fontSize: 10, ...MONO,
              appearance: "auto", cursor: "pointer",
            }}
          >
            {(leagues || []).map(lg => (
              <option key={lg.value} value={lg.value}>{lg.label}</option>
            ))}
          </select>
          <Tooltip text="Send bug report with logs to Discord">
            <button onClick={onBugReport} style={{
              background: "transparent", border: "none", color: T.textSecond,
              fontSize: 10, cursor: "pointer", padding: "2px 6px", letterSpacing: "0.04em",
              transition: "color 0.15s",
            }} onMouseEnter={e => e.target.style.color = T.amber} onMouseLeave={e => e.target.style.color = T.textSecond}>Bug Report</button>
          </Tooltip>
          <Tooltip text="Send us feedback or suggestions">
            <button onClick={onFeedback} style={{
              background: "transparent", border: "none", color: T.textSecond,
              fontSize: 10, cursor: "pointer", padding: "2px 6px", letterSpacing: "0.04em",
              transition: "color 0.15s",
            }} onMouseEnter={e => e.target.style.color = T.gold} onMouseLeave={e => e.target.style.color = T.textSecond}>Feedback</button>
          </Tooltip>
          <Tooltip text="Request a new feature">
            <button onClick={onFeatureRequest} style={{
              background: "transparent", border: "none", color: T.textSecond,
              fontSize: 10, cursor: "pointer", padding: "2px 6px", letterSpacing: "0.04em",
              transition: "color 0.15s",
            }} onMouseEnter={e => e.target.style.color = T.cyan} onMouseLeave={e => e.target.style.color = T.textSecond}>Feature Request</button>
          </Tooltip>
          <Tooltip text="Restart the entire app (server + overlay)">
            <button onClick={onRestartApp} style={{
              background: "transparent", border: "none", color: T.textSecond,
              fontSize: 10, cursor: "pointer", padding: "2px 6px", letterSpacing: "0.04em",
              transition: "color 0.15s",
            }} onMouseEnter={e => e.target.style.color = T.text} onMouseLeave={e => e.target.style.color = T.textSecond}>Restart App</button>
          </Tooltip>
          <div style={{ flex: 1 }} />
          <a className="footer-email" href="mailto:hello@couloir.gg">hello@couloir.gg</a>
          <span style={{ fontSize: 11, fontWeight: 800, color: "#5c4f3d", letterSpacing: "0.08em", textTransform: "uppercase" }}>
            Couloir
          </span>
          <img
            src="/img/couloir_avatar.png"
            alt="Couloir"
            onClick={() => setFlyoutOpen(!flyoutOpen)}
            style={{
              width: 22, height: 22, borderRadius: 4, cursor: "pointer",
              filter: flyoutOpen
                ? "sepia(0.3) saturate(1.5) brightness(1.0) hue-rotate(-5deg)"
                : "sepia(0.6) saturate(1.2) brightness(0.8) hue-rotate(-5deg)",
              opacity: flyoutOpen ? 1 : 0.7,
              transition: "filter 0.2s, opacity 0.2s",
            }}
          />
          {flyoutOpen && (
            <div className="couloir-flyout">
              {/* Header */}
              <div style={{ display: "flex", alignItems: "center", gap: 12, marginBottom: 14 }}>
                <img
                  src="/img/couloir_avatar.png"
                  alt="Couloir"
                  style={{
                    width: 40, height: 40, borderRadius: 6,
                    filter: "sepia(0.4) saturate(1.4) brightness(0.85) hue-rotate(-5deg)",
                  }}
                />
                <div>
                  <div style={{ fontSize: 15, fontWeight: 800, color: T.gold, letterSpacing: "0.06em" }}>
                    Who We Are
                  </div>
                  <div style={{ fontSize: 10, color: T.textMuted, marginTop: 1 }}>indie studio</div>
                </div>
              </div>

              {/* Divider */}
              <div style={{
                height: 1, margin: "0 0 14px",
                background: `linear-gradient(90deg, ${T.borderGold}, transparent)`,
              }} />

              {/* Body */}
              <div style={{ fontSize: 12, color: T.textSecond, lineHeight: 1.65 }}>
                <span style={{ color: T.gold }}>Couloir</span> is a small indie studio that builds
                open-source games, developer tools, and player-focused software. We believe the best software is free,
                transparent, and community-driven.
              </div>
              <div style={{ fontSize: 12, color: T.textSecond, lineHeight: 1.65, marginTop: 10 }}>
                This tool exists because we love this game, its community, and especially
                GGG — we know how hard it is to build games and ship every feature players
                want. We took the ideas we loved from other tools and put them in one place,
                for free. It's <span style={{ color: T.text, fontWeight: 600 }}>GPLv3</span> —
                the code is yours. Fork it, improve it, break it, whatever.
                No tracking, no third-party ads. Optional anonymous calibration sharing improves accuracy for everyone.
              </div>
              <div style={{ fontSize: 12, color: T.textSecond, lineHeight: 1.65, marginTop: 10 }}>
                If it supports GGG's goals and helps players, we hit the mark. If it saves
                you time or currency, consider supporting us so we can keep building.
              </div>

              {/* Divider */}
              <div style={{
                height: 1, margin: "14px 0",
                background: `linear-gradient(90deg, ${T.borderGold}, transparent)`,
              }} />

              {/* Links */}
              <div style={{ display: "flex", flexDirection: "column", gap: 6, fontSize: 11 }}>
                <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
                  <span>&#9924;</span>
                  <span style={{ color: T.textSecond }}>Built by <span style={{ color: T.text, fontWeight: 600 }}>Cal Schuss</span> & friends</span>
                </div>
                <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
                  <span>&#9993;</span>
                  <a className="couloir-flyout-link" href="mailto:hello@couloir.gg">hello@couloir.gg</a>
                </div>
                <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
                  <span>&#127760;</span>
                  <a className="couloir-flyout-link" href="https://couloir.gg" target="_blank" rel="noopener noreferrer">couloir.gg</a>
                </div>
              </div>

              {/* Credits */}
              <div style={{
                height: 1, margin: "14px 0 10px",
                background: `linear-gradient(90deg, ${T.borderGold}, transparent)`,
              }} />
              <div style={{ fontSize: 10, color: T.textMuted, lineHeight: 1.6 }}>
                <div style={{ fontWeight: 600, color: T.textSecond, marginBottom: 4, letterSpacing: "0.06em", textTransform: "uppercase", fontSize: 9 }}>Thanks To</div>
                <span style={{ color: T.textSecond }}>GGG</span> for Path of Exile 2{" "}
                &middot; <span style={{ color: T.textSecond }}>poe.ninja</span> for market data{" "}
                &middot; <span style={{ color: T.textSecond }}>NeverSink</span> for filter foundations{" "}
                &middot; <span style={{ color: T.textSecond }}>RePoE</span> for mod tier data{" "}
                &middot; The POE2 community for testing & feedback
              </div>
            </div>
          )}
        </div>
      );
    }

    // -----------------------------------------------------------------------
    // Tooltip wrapper
    // -----------------------------------------------------------------------
    function Tooltip({ text, children }) {
      const [pos, setPos] = useState(null);
      const ref = useRef(null);

      const handleEnter = () => {
        if (ref.current) {
          const rect = ref.current.getBoundingClientRect();
          const above = rect.top > 50;
          setPos({
            left: rect.left + rect.width / 2,
            top: above ? rect.top - 6 : rect.bottom + 6,
            above,
          });
        }
      };

      return (
        <div ref={ref} onMouseEnter={handleEnter} onMouseLeave={() => setPos(null)} style={{ position: "relative" }}>
          {children}
          {pos && text && (
            <div style={{
              position: "fixed",
              left: pos.left,
              top: pos.above ? "auto" : pos.top,
              bottom: pos.above ? `calc(100vh - ${pos.top}px)` : "auto",
              transform: "translateX(-50%)",
              background: T.card, border: `1px solid ${T.borderGold}`, borderRadius: 6,
              padding: "6px 10px", fontSize: 11, color: T.textSecond, whiteSpace: "nowrap",
              zIndex: 9999, pointerEvents: "none",
              boxShadow: "0 4px 12px rgba(0,0,0,0.6)",
            }}>{text}</div>
          )}
        </div>
      );
    }

    // -----------------------------------------------------------------------
    // StatCard
    // -----------------------------------------------------------------------
    function CurrencyIcon({ src, size = 24 }) {
      return <img src={src} alt="" style={{ width: size, height: size, objectFit: "contain", imageRendering: "auto", verticalAlign: "middle" }} />;
    }

    function StatCard({ label, value, sub, color, tooltip, iconLeft, iconRight }) {
      const card = (
        <div className="panel" style={{ ...CARD, padding: 10, textAlign: "center", minWidth: 0 }}>
          <div style={{ ...LABEL, marginBottom: 4, fontSize: 9 }}>{label}</div>
          <div style={{ ...MONO, fontSize: 18, fontWeight: 700, color: color || T.text, lineHeight: 1.2, display: "flex", alignItems: "center", justifyContent: "center", gap: 5 }}>
            {iconLeft && <CurrencyIcon src={iconLeft} size={22} />}
            <span>{value}</span>
            {iconRight && <CurrencyIcon src={iconRight} size={22} />}
          </div>
          {sub && <div style={{ fontSize: 9, color: T.textMuted, marginTop: 2 }}>{sub}</div>}
        </div>
      );
      return tooltip ? <Tooltip text={tooltip}>{card}</Tooltip> : card;
    }

    // -----------------------------------------------------------------------
    // StatusPanel
    // -----------------------------------------------------------------------
    // Currency icon paths (served by /img/ endpoint)
    const ICON = {
      divine: "/img/divine_orb.png",
      exalted: "/img/exalted_orb.png",
      chaos: "/img/chaos_orb.png",
      mirror: "/img/mirror_of_kalandra.png",
    };

    function StatusPanel({ status }) {
      const { stats } = status;

      const d2c = stats.divine_to_chaos || 0;
      const d2e = stats.divine_to_exalted || 0;
      const e2c = d2c > 0 ? (d2e / d2c) : 0;
      const m2d = stats.mirror_to_divine || 0;

      const refreshColor = stats.last_refresh === "never" ? T.textSecond : T.green;

      return (
        <div style={{ maxWidth: 1050, margin: "0 auto", padding: "0 24px" }}>
          <div style={{ display: "grid", gridTemplateColumns: "repeat(5, 1fr)", gap: 10, marginBottom: 8 }}>
            <StatCard label="1 Mirror" value={m2d > 0 ? `${m2d.toFixed(0)}` : "--"} sub={m2d > 0 ? "Divine" : null} color="#c084fc" iconLeft={ICON.mirror} iconRight={ICON.divine} tooltip="1 Mirror of Kalandra = X Divine Orbs" />
            <StatCard label="1 Divine" value={d2e > 0 ? `${d2e.toFixed(0)}` : "--"} sub={d2e > 0 ? "Exalted" : null} color={T.gold} iconLeft={ICON.divine} iconRight={ICON.exalted} tooltip="1 Divine Orb = X Exalted Orbs" />
            <StatCard label="1 Divine" value={d2c > 0 ? `${d2c.toFixed(0)}` : "--"} sub={d2c > 0 ? "Chaos" : null} color={T.gold} iconLeft={ICON.divine} iconRight={ICON.chaos} tooltip="1 Divine Orb = X Chaos Orbs" />
            <StatCard label="1 Chaos" value={e2c > 0 ? `${e2c.toFixed(0)}` : "--"} sub={e2c > 0 ? "Exalted" : null} color={T.amber} iconLeft={ICON.exalted} iconRight={ICON.chaos} tooltip="1 Chaos Orb = X Exalted Orbs" />
            <StatCard label="Last Refresh" value={stats.last_refresh === "never" ? "--" : stats.last_refresh} color={refreshColor} tooltip="When price data was last fetched (refreshes every 15 min)" />
          </div>
          <div style={{ display: "flex", justifyContent: "flex-end", marginBottom: 4, padding: "2px 0" }}>
            <span style={{ fontSize: 9, color: T.textMuted, fontStyle: "italic" }}>
              Prices are estimates — always verify before trading
            </span>
          </div>
        </div>
      );
    }

    // -----------------------------------------------------------------------
    // Bug Report Modal
    // -----------------------------------------------------------------------
    function BugReportModal({ open, onClose }) {
      const [title, setTitle] = useState("");
      const [desc, setDesc] = useState("");
      const [sending, setSending] = useState(false);
      const [result, setResult] = useState(null);

      if (!open) return null;

      const handleSend = async () => {
        setSending(true);
        setResult(null);
        const res = await api("/api/bug-report", "POST", { title, description: desc });
        setSending(false);
        if (res.error) {
          setResult({ ok: false, msg: res.error });
        } else {
          setResult({ ok: true, msg: "Report sent!" });
          setTimeout(() => { onClose(); setTitle(""); setDesc(""); setResult(null); }, 1200);
        }
      };

      return (
        <div style={{
          position: "fixed", inset: 0, background: "rgba(0,0,0,0.7)", zIndex: 1000,
          display: "flex", alignItems: "center", justifyContent: "center",
        }} onClick={onClose}>
          <div style={{
            background: T.card, border: `1px solid ${T.borderGold}`, borderRadius: 10,
            padding: 24, width: 420, maxWidth: "90vw",
          }} onClick={e => e.stopPropagation()}>
            <div style={{ fontSize: 16, fontWeight: 700, marginBottom: 16, color: T.gold }}>Bug Report</div>

            <label style={FIELD_LABEL}>Title</label>
            <input
              value={title}
              onChange={e => setTitle(e.target.value)}
              placeholder="Brief summary..."
              style={{ ...FIELD_INPUT, marginBottom: 12 }}
              autoFocus
              onKeyDown={e => e.key === "Enter" && document.getElementById("bug-desc")?.focus()}
            />

            <label style={FIELD_LABEL}>What happened?</label>
            <textarea
              id="bug-desc"
              value={desc}
              onChange={e => setDesc(e.target.value)}
              placeholder="Describe the issue..."
              rows={4}
              style={{ ...FIELD_INPUT, resize: "vertical", marginBottom: 8 }}
              onKeyDown={e => { if (e.ctrlKey && e.key === "Enter") handleSend(); }}
            />

            <div style={{ fontSize: 10, color: T.textMuted, marginBottom: 16 }}>
              Logs + system info attached automatically. Sent to Discord.
            </div>

            {result && (
              <div style={{ fontSize: 12, fontWeight: 600, marginBottom: 12, color: result.ok ? T.green : T.red, wordBreak: "break-word", overflowWrap: "anywhere" }}>
                {result.msg}
              </div>
            )}

            <div style={{ display: "flex", gap: 10, justifyContent: "flex-end" }}>
              <button onClick={onClose} style={{ ...BTN, background: T.input, border: `1px solid ${T.border}`, color: T.textSecond }}>Cancel</button>
              <button onClick={handleSend} disabled={sending} style={{
                ...BTN_GOLD_ACTIVE, opacity: sending ? 0.5 : 1,
              }}>{sending ? "Sending..." : "Send Report"}</button>
            </div>
          </div>
        </div>
      );
    }

    // -----------------------------------------------------------------------
    // Feedback Modal (feedback + feature requests → Discord)
    // -----------------------------------------------------------------------
    function FeedbackModal({ open, onClose, feedbackType }) {
      const [title, setTitle] = useState("");
      const [desc, setDesc] = useState("");
      const [sending, setSending] = useState(false);
      const [result, setResult] = useState(null);

      if (!open) return null;

      const isFeature = feedbackType === "feature";
      const heading = isFeature ? "Feature Request" : "Send Feedback";
      const placeholder = isFeature
        ? "Describe the feature you'd like to see..."
        : "Tell us what's on your mind...";

      const handleSend = async () => {
        setSending(true);
        setResult(null);
        const res = await api("/api/feedback", "POST", { type: feedbackType, title, description: desc });
        setSending(false);
        if (res.error) {
          setResult({ ok: false, msg: res.error });
        } else {
          setResult({ ok: true, msg: isFeature ? "Request submitted!" : "Feedback sent!" });
          setTimeout(() => { onClose(); setTitle(""); setDesc(""); setResult(null); }, 1200);
        }
      };

      return (
        <div style={{
          position: "fixed", inset: 0, background: "rgba(0,0,0,0.7)", zIndex: 1000,
          display: "flex", alignItems: "center", justifyContent: "center",
        }} onClick={onClose}>
          <div style={{
            background: T.card, border: `1px solid ${T.borderGold}`, borderRadius: 10,
            padding: 24, width: 420, maxWidth: "90vw",
          }} onClick={e => e.stopPropagation()}>
            <div style={{ fontSize: 16, fontWeight: 700, marginBottom: 16, color: isFeature ? T.cyan : T.gold }}>
              {heading}
            </div>

            <label style={FIELD_LABEL}>Title</label>
            <input
              value={title}
              onChange={e => setTitle(e.target.value)}
              placeholder={isFeature ? "Feature name..." : "Brief summary..."}
              style={{ ...FIELD_INPUT, marginBottom: 12 }}
              autoFocus
              onKeyDown={e => e.key === "Enter" && document.getElementById("feedback-desc")?.focus()}
            />

            <label style={FIELD_LABEL}>{isFeature ? "What would this do?" : "Details"}</label>
            <textarea
              id="feedback-desc"
              value={desc}
              onChange={e => setDesc(e.target.value)}
              placeholder={placeholder}
              rows={4}
              style={{ ...FIELD_INPUT, resize: "vertical", marginBottom: 8 }}
              onKeyDown={e => { if (e.ctrlKey && e.key === "Enter") handleSend(); }}
            />

            <div style={{ fontSize: 10, color: T.textMuted, marginBottom: 16 }}>
              Sent to our Discord. We read everything.
            </div>

            {result && (
              <div style={{ fontSize: 12, fontWeight: 600, marginBottom: 12, color: result.ok ? T.green : T.red, wordBreak: "break-word", overflowWrap: "anywhere" }}>
                {result.msg}
              </div>
            )}

            <div style={{ display: "flex", gap: 10, justifyContent: "flex-end" }}>
              <button onClick={onClose} style={{ ...BTN, background: T.input, border: `1px solid ${T.border}`, color: T.textSecond }}>Cancel</button>
              <button onClick={handleSend} disabled={sending || !title.trim()} style={{
                ...BTN_GOLD_ACTIVE, opacity: (sending || !title.trim()) ? 0.5 : 1,
              }}>{sending ? "Sending..." : "Submit"}</button>
            </div>
          </div>
        </div>
      );
    }

    // -----------------------------------------------------------------------
    // ScannerStatusCard — hero card at top of Overlay tab
    // -----------------------------------------------------------------------
    function ScannerStatusCard({ status, onStart, onStop, onRestart }) {
      const { state, stats, uptime } = status;
      const isRunning = state === "running" || state === "starting";
      const calSamples = stats.calibration_samples || 0;

      if (state === "stopped") {
        return (
          <div className="panel" style={{ ...CARD, padding: 10, marginBottom: 12 }}>
            <div style={{ display: "flex", alignItems: "center", gap: 12 }}>
              <div style={{ width: 8, height: 8, borderRadius: "50%", background: T.red, flexShrink: 0 }} />
              <span style={{ fontSize: 12, color: T.textSecond }}>Scanner offline</span>
              <button onClick={onStart} className="btn-gold-hover" style={{
                ...BTN, background: T.green, color: "#fff", padding: "5px 16px", fontSize: 11,
                border: `1px solid ${T.green}`, marginLeft: "auto",
              }}>&#9654; Start</button>
            </div>
          </div>
        );
      }

      if (state === "starting") {
        return (
          <div className="panel" style={{ ...CARD, padding: 10, marginBottom: 12 }}>
            <div style={{ display: "flex", alignItems: "center", gap: 10 }}>
              <div style={{ width: 12, height: 12, border: `2px solid ${T.amber}`, borderTop: "2px solid transparent", borderRadius: "50%", animation: "spin 0.8s linear infinite" }} />
              <span style={{ fontSize: 11, fontWeight: 600, color: T.amber }}>Starting...</span>
            </div>
          </div>
        );
      }

      if (state === "error") {
        return (
          <div className="panel" style={{ ...CARD, padding: 16, marginBottom: 12, borderColor: T.red + "44" }}>
            <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between" }}>
              <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                <span style={{ color: T.red, fontSize: 14, fontWeight: 700 }}>Scanner Error</span>
                <span style={{ fontSize: 11, color: T.textSecond }}>Check console for details</span>
              </div>
              <button onClick={onRestart} className="btn-gold-hover" style={{
                ...BTN, background: T.input, border: `1px solid ${T.borderGold}`, color: T.gold, padding: "6px 16px",
              }}>&#8635; Restart</button>
            </div>
          </div>
        );
      }

      // Running state — compact card with health stats
      return (
        <div className="panel" style={{ ...CARD, padding: 12, marginBottom: 12 }}>
          <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between" }}>
            <div style={{ display: "flex", alignItems: "center", gap: 16 }}>
              <Tooltip text="Number of item tooltips scanned via Ctrl+C">
                <span style={{ fontSize: 10, color: T.textMuted, ...MONO, cursor: "default" }}>Scans: <span style={{ color: T.textSecond, fontWeight: 600 }}>{stats.triggers}</span></span>
              </Tooltip>
              <Tooltip text="Percentage of scans that found a price">
                <span style={{ fontSize: 10, color: T.textMuted, ...MONO, cursor: "default" }}>Hit Rate: <span style={{ color: stats.success_rate >= 50 ? T.green : stats.success_rate > 0 ? T.amber : T.textSecond, fontWeight: 600 }}>{stats.success_rate}%</span></span>
              </Tooltip>
              <Tooltip text="Calibration data points for score-to-price estimation">
                <span style={{ fontSize: 10, color: T.textMuted, ...MONO, cursor: "default" }}>Calibration: <span style={{ color: calSamples >= 1000 ? T.green : calSamples > 0 ? T.amber : T.textSecond, fontWeight: 600 }}>{calSamples > 0 ? calSamples.toLocaleString() : "--"}</span></span>
              </Tooltip>
              <Tooltip text="Time since overlay was started">
                <span style={{ fontSize: 10, color: T.textMuted, ...MONO, cursor: "default" }}>Uptime: <span style={{ color: T.green, fontWeight: 600 }}>{formatUptime(uptime)}</span></span>
              </Tooltip>
            </div>
            <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
              <button onClick={onStop} className="btn-danger-hover" style={{
                ...BTN, background: T.red, color: "#fff", padding: "5px 14px", fontSize: 10,
                border: `1px solid ${T.red}`,
              }}>&#9632; Stop</button>
              <Tooltip text="Restart overlay">
                <button onClick={onRestart} style={{
                  ...BTN, background: "transparent", color: T.textSecond, padding: "5px 10px", fontSize: 10,
                  border: `1px solid ${T.border}`,
                }}>&#8635;</button>
              </Tooltip>
            </div>
          </div>
        </div>
      );
    }

    // -----------------------------------------------------------------------
    // TabBar
    // -----------------------------------------------------------------------
    function TabBar({ activeTab, onTabChange }) {
      const tabs = [
        { id: "overlay", label: "Overlay" },
        { id: "filter", label: "Loot Filter" },
        { id: "watchlist", label: "Watchlist" },
        { id: "markets", label: "Markets" },
      ];

      return (
        <div style={{ display: "flex", gap: 2, marginBottom: 0, borderBottom: `1px solid ${T.border}` }}>
          {tabs.map(tab => {
            const active = activeTab === tab.id;
            return (
              <button
                key={tab.id}
                className={`poe-tab ${active ? "poe-tab-active" : ""}`}
                onClick={() => onTabChange(tab.id)}
                style={{
                  background: active ? "rgba(196,164,86,0.15)" : "transparent",
                  border: "none",
                  color: active ? T.gold : T.textSecond,
                  padding: "10px 24px 8px", fontSize: 13, fontWeight: 600,
                  cursor: "pointer", letterSpacing: "0.04em",
                  borderRadius: "6px 6px 0 0",
                }}
              >
                <div>{tab.label}</div>
                <div style={{ fontSize: 8, color: active ? T.textSecond : T.textMuted, marginTop: 2, fontWeight: 400, letterSpacing: "0.06em" }}>
                  {TAB_SUBTITLES[tab.id]}
                </div>
              </button>
            );
          })}
        </div>
      );
    }

    // -----------------------------------------------------------------------
    // OverlaySettingsTab (consolidated overlay + detection settings)
    // -----------------------------------------------------------------------
    // Price color constants for preview
    const PRICE_COLOR_HIGH = "#ff6b35";
    const PRICE_COLOR_GOOD = "#ffd700";
    const PRICE_COLOR_DECENT = "#4ecdc4";
    const PRICE_COLOR_LOW = "#95a5a6";

    // Overlay display presets — maps preset id to toggle states
    const OVERLAY_PRESETS = [
      { id: "minimal",  label: "Minimal",  desc: "Price only",      toggles: { overlay_show_grade: false, overlay_show_price: true,  overlay_show_stars: false, overlay_show_mods: false, overlay_show_dps: false } },
      { id: "quick",    label: "Quick",    desc: "Grade + price",   toggles: { overlay_show_grade: true,  overlay_show_price: true,  overlay_show_stars: false, overlay_show_mods: false, overlay_show_dps: false } },
      { id: "standard", label: "Standard", desc: "Default",         toggles: { overlay_show_grade: true,  overlay_show_price: true,  overlay_show_stars: true,  overlay_show_mods: false, overlay_show_dps: true  } },
      { id: "expert",   label: "Expert",   desc: "Full mod detail", toggles: { overlay_show_grade: true,  overlay_show_price: true,  overlay_show_stars: true,  overlay_show_mods: true,  overlay_show_dps: true  } },
    ];

    // Detect which preset matches current toggle states (or "custom")
    function detectOverlayPreset(settings) {
      for (const preset of OVERLAY_PRESETS) {
        const match = Object.entries(preset.toggles).every(
          ([key, val]) => (settings[key] !== false) === val
        );
        if (match) return preset.id;
      }
      return "custom";
    }

    // -----------------------------------------------------------------------
    // OverlayPreview — visual mock of in-game tooltip
    // -----------------------------------------------------------------------
    // Default overlay tier styles — matches overlay.py _VALUE_TIERS (Classic theme)
    const CLASSIC_DEFAULT_OVERLAY_TIER_STYLES = {
      mirror:      { text_color: "#ff6b35", border_color: "#FF4040", bg_color: "#1a1a2e", border_width: 4, sound_enabled: false },
      jackpot:     { text_color: "#ff6b35", border_color: "#FF4500", bg_color: "#1a1a2e", border_width: 3, sound_enabled: false },
      big_hit:     { text_color: "#ff6b35", border_color: "#FFD700", bg_color: "#1a1a2e", border_width: 3, sound_enabled: false },
      great_find:  { text_color: "#ff6b35", border_color: "#DAA520", bg_color: "#1a1a2e", border_width: 2, sound_enabled: false },
      good_find:   { text_color: "#ffd700", border_color: "#A0A0B0", bg_color: "#1a1a2e", border_width: 2, sound_enabled: false },
      worth_sell:  { text_color: "#ffd700", border_color: "#333355", bg_color: "#1a1a2e", border_width: 2, sound_enabled: false },
      marginal:    { text_color: "#4ecdc4", border_color: "#333355", bg_color: "#1a1a2e", border_width: 2, sound_enabled: false },
      vendor:      { text_color: "#95a5a6", border_color: null,      bg_color: null,      border_width: 0, sound_enabled: false },
    };

    // POE2 Gothic theme defaults — blood-stained borders, aged parchment
    const POE2_DEFAULT_OVERLAY_TIER_STYLES = {
      mirror:      { text_color: "#ff6b35", border_color: "#8b1a1a", bg_color: "#1a120c", border_width: 4, sound_enabled: false },
      jackpot:     { text_color: "#ff6b35", border_color: "#7a2020", bg_color: "#1a120c", border_width: 3, sound_enabled: false },
      big_hit:     { text_color: "#ff6b35", border_color: "#a85520", bg_color: "#1a120c", border_width: 3, sound_enabled: false },
      great_find:  { text_color: "#ff6b35", border_color: "#6b5a2e", bg_color: "#1a120c", border_width: 2, sound_enabled: false },
      good_find:   { text_color: "#ffd700", border_color: "#5a4a30", bg_color: "#1a120c", border_width: 2, sound_enabled: false },
      worth_sell:  { text_color: "#ffd700", border_color: "#3d2e1e", bg_color: "#1a120c", border_width: 2, sound_enabled: false },
      marginal:    { text_color: "#4ecdc4", border_color: "#3d2e1e", bg_color: "#1a120c", border_width: 2, sound_enabled: false },
      vendor:      { text_color: "#7a6b55", border_color: null,      bg_color: null,      border_width: 0, sound_enabled: false },
    };

    // Alias for backward-compat — callers just use DEFAULT_OVERLAY_TIER_STYLES
    const DEFAULT_OVERLAY_TIER_STYLES = CLASSIC_DEFAULT_OVERLAY_TIER_STYLES;

    function getEffectiveOverlayTierStyle(tierId, overlayTierStyles, theme) {
      const base = (theme === "poe2" ? POE2_DEFAULT_OVERLAY_TIER_STYLES : CLASSIC_DEFAULT_OVERLAY_TIER_STYLES)[tierId] || {};
      return { ...base, ...(overlayTierStyles?.[tierId] || {}) };
    }

    // Sample items representing each overlay value tier
    // Each has: grade, price text, divine value, stars, mods summary, dps tag,
    //           tierId for style lookup, animation, and a label for the legend
    const OVERLAY_SAMPLES = [
      { tierId: "mirror",     label: "Mirror-tier",  desc: "\u226550,000d",  grade: "S", price: "~52,000d", stars: 6, mods: "T1 SpellDmg, T1 CritMulti, T1 CastSpd", dps: "",
        borderWidth: 4, animation: "borderRainbow 0.9s linear infinite", poe2Animation: "borderBloodRainbow 0.9s linear infinite", textAnim: true },
      { tierId: "jackpot",    label: "Jackpot",     desc: "\u22651,000d",   grade: "S", price: "~1,200d",  stars: 5, mods: "T1 CritMulti, T1 AtkSpd, T1 PhysDmg",  dps: "",
        borderWidth: 3, animation: "borderGoldFast 0.5s ease-in-out infinite", poe2Animation: "borderBloodFast 0.5s ease-in-out infinite", textAnim: false },
      { tierId: "big_hit",    label: "Big hit",     desc: "\u2265250d",     grade: "S", price: "~310d",    stars: 4, mods: "T1 Life, T1 CritChance, T2 ES",        dps: "",
        borderWidth: 3, animation: "borderGoldMed 0.9s ease-in-out infinite", poe2Animation: "borderBloodMed 0.9s ease-in-out infinite", textAnim: false },
      { tierId: "great_find", label: "Great find",  desc: "\u226550d",      grade: "A", price: "~65d",     stars: 3, mods: "T1 Life, T2 Crit, T1 ES",              dps: "380dps",
        borderWidth: 2, animation: "none", textAnim: false },
      { tierId: "good_find",  label: "Good find",   desc: "\u226525d",      grade: "A", price: "~30d",     stars: 2, mods: "T2 Life, T2 MoveSpd",                  dps: "",
        borderWidth: 2, animation: "none", textAnim: false },
      { tierId: "worth_sell", label: "Worth selling",desc: "\u22655d",      grade: "B", price: "~8d",      stars: 1, mods: "T2 Life, T3 ColdRes",                  dps: "",
        borderWidth: 2, animation: "none", textAnim: false },
      { tierId: "marginal",   label: "Marginal",    desc: "\u22651d",       grade: "B", price: "~2d",      stars: 1, mods: "T3 Life, T4 FireRes",                  dps: "",
        borderWidth: 2, animation: "none", textAnim: false },
      { tierId: "vendor",     label: "Vendor / skip",desc: "<1d",           grade: "C", price: null,        stars: 0, mods: "",                                     dps: "",
        borderWidth: 0, animation: "none", textAnim: false, isJunk: true },
    ];

    // Build overlay text for a sample item based on current toggle settings
    function buildSampleText(sample, settings, theme) {
      if (sample.isJunk) return "\u2717";
      const showGrade = settings.overlay_show_grade !== false;
      const showPrice = settings.overlay_show_price !== false;
      const showStars = settings.overlay_show_stars !== false;
      const showMods  = settings.overlay_show_mods !== false;
      const showDps   = settings.overlay_show_dps !== false;
      const isPoe2 = theme === "poe2";
      const parts = [];
      if (showGrade) parts.push(sample.grade);
      if (showPrice && sample.price) parts.push(sample.price);
      const starStr = sample.stars > 0 ? "\u2605".repeat(sample.stars) : "";
      const dpsStr = (showDps && sample.dps) ? sample.dps : "";
      if (dpsStr) parts.push(dpsStr);
      // POE2 theme: stars shown as pips, not inline text
      else if (showStars && starStr && !isPoe2) parts.push(starStr);
      let text = parts.join(" ");
      if (showMods && sample.mods) {
        text = text ? text + ": " + sample.mods : sample.mods;
      }
      return text || "\u2605";
    }

    // Mock POE2 item tooltips for in-game preview (keyed by tierId)
    // slotW/slotH = inventory cell size (1=1x1, 2=2x1, etc.), col/row = grid position of highlighted item
    const MOCK_TOOLTIPS = {
      mirror:     { name: "Entropy Weaver", base: "Vaal Sceptre", rarity: "rare", itemClass: "Sceptres", ilvl: 86, slotW: 1, slotH: 3, col: 4, row: 0,
        mods: ["+184% Spell Damage", "+52% Critical Strike Multiplier", "+28% Cast Speed", "+112 Maximum Mana", "+42% Lightning Resistance", "+18% Quality"] },
      jackpot:    { name: "Havoc Edge", base: "Deicide Sword", rarity: "rare", itemClass: "Two Hand Swords", ilvl: 83, slotW: 2, slotH: 4, col: 8, row: 0,
        mods: ["+178% Physical Damage", "+28% Attack Speed", "+42% Critical Strike Chance", "+95 Maximum Life", "+38% Accuracy Rating"] },
      big_hit:    { name: "Glyph Ward", base: "Astral Plate", rarity: "rare", itemClass: "Body Armours", ilvl: 84, slotW: 2, slotH: 3, col: 5, row: 0,
        mods: ["+118 Maximum Life", "+42% Critical Strike Chance", "+156 Energy Shield", "+38% Fire Resistance", "+32% Cold Resistance"] },
      great_find: { name: "Storm Loop", base: "Sapphire Ring", rarity: "rare", itemClass: "Rings", ilvl: 80, slotW: 1, slotH: 1, col: 3, row: 3,
        mods: ["+89 Maximum Life", "+35% Critical Strike Multiplier", "+72 Energy Shield", "+380 DPS (Elemental)", "+28% Lightning Damage"] },
      good_find:  { name: "Rune Treads", base: "Titan Greaves", rarity: "rare", itemClass: "Boots", ilvl: 78, slotW: 2, slotH: 2, col: 0, row: 3,
        mods: ["+82 Maximum Life", "+25% Movement Speed", "+36% Fire Resistance", "+28% Cold Resistance"] },
      worth_sell: { name: "Dusk Grip", base: "Spiked Gloves", rarity: "rare", itemClass: "Gloves", ilvl: 75, slotW: 2, slotH: 2, col: 2, row: 0,
        mods: ["+74 Maximum Life", "+18% Cold Resistance", "+22% Lightning Resistance", "+15 Dexterity"] },
      marginal:   { name: "Ash Coil", base: "Coral Amulet", rarity: "rare", itemClass: "Amulets", ilvl: 72, slotW: 1, slotH: 1, col: 7, row: 4,
        mods: ["+48 Maximum Life", "+12% Fire Resistance", "+8 Strength", "+14 Intelligence"] },
      vendor:     { name: "Briar Helm", base: "Iron Hat", rarity: "rare", itemClass: "Helmets", ilvl: 45, slotW: 2, slotH: 2, col: 0, row: 0,
        mods: ["+22 Maximum Life", "+8% Fire Resistance", "+6 Armour", "+4 Strength"] },
    };

    // Inventory filler items — static background items that fill other cells
    // Each: { col, row, w, h, color, rarity } — rarity drives the border tint
    const INV_FILLER_ITEMS = [
      { col: 0, row: 0, w: 2, h: 2, color: "#1a1520", rarity: "rare" },
      { col: 2, row: 0, w: 2, h: 2, color: "#151820", rarity: "rare" },
      { col: 4, row: 0, w: 1, h: 3, color: "#18141e", rarity: "rare" },
      { col: 5, row: 0, w: 2, h: 3, color: "#141a1e", rarity: "rare" },
      { col: 7, row: 0, w: 1, h: 1, color: "#181518", rarity: "magic" },
      { col: 8, row: 0, w: 2, h: 4, color: "#1a1418", rarity: "rare" },
      { col: 10, row: 0, w: 1, h: 1, color: "#151218", rarity: "normal" },
      { col: 11, row: 0, w: 1, h: 1, color: "#18181a", rarity: "magic" },
      { col: 7, row: 1, w: 1, h: 2, color: "#161420", rarity: "rare" },
      { col: 10, row: 1, w: 2, h: 2, color: "#14161a", rarity: "magic" },
      { col: 0, row: 2, w: 1, h: 1, color: "#1a1518", rarity: "normal" },
      { col: 1, row: 2, w: 1, h: 1, color: "#161618", rarity: "magic" },
      { col: 2, row: 2, w: 2, h: 1, color: "#181216", rarity: "rare" },
      { col: 0, row: 3, w: 2, h: 2, color: "#151a18", rarity: "rare" },
      { col: 2, row: 3, w: 1, h: 1, color: "#181518", rarity: "normal" },
      { col: 3, row: 3, w: 1, h: 1, color: "#141820", rarity: "rare" },
      { col: 4, row: 3, w: 2, h: 2, color: "#1a141e", rarity: "rare" },
      { col: 6, row: 3, w: 1, h: 2, color: "#161a16", rarity: "magic" },
      { col: 7, row: 3, w: 1, h: 1, color: "#18161a", rarity: "normal" },
      { col: 7, row: 4, w: 1, h: 1, color: "#151518", rarity: "rare" },
      { col: 8, row: 4, w: 2, h: 1, color: "#14181a", rarity: "magic" },
      { col: 10, row: 3, w: 1, h: 2, color: "#181418", rarity: "normal" },
      { col: 11, row: 3, w: 1, h: 1, color: "#161616", rarity: "normal" },
      { col: 11, row: 4, w: 1, h: 1, color: "#1a1a16", rarity: "magic" },
    ];

    // Simple item silhouette SVGs for inventory filler cells
    function FillerItemIcon({ w, h, tintColor }) {
      const opacity = 0.25;
      const fill = tintColor;
      if (w === 1 && h === 1) {
        return (
          <svg viewBox="0 0 20 20" style={{ width: "60%", height: "60%", opacity }}>
            <circle cx="10" cy="10" r="7" fill={fill} />
          </svg>
        );
      }
      if (w === 1 && h === 2) {
        return (
          <svg viewBox="0 0 16 34" style={{ width: "50%", height: "70%", opacity }}>
            <path d="M5 2h6v2h2v8l-2 2v14c0 2-1 4-3 4h0c-2 0-3-2-3-4V14L3 12V4h2z" fill={fill} />
          </svg>
        );
      }
      if (w === 1 && h === 3) {
        return (
          <svg viewBox="0 0 14 50" style={{ width: "45%", height: "80%", opacity }}>
            <circle cx="7" cy="6" r="5" fill={fill} />
            <rect x="5" y="10" width="4" height="30" rx="1" fill={fill} />
            <rect x="3" y="38" width="8" height="6" rx="2" fill={fill} />
          </svg>
        );
      }
      if (w === 2 && h === 1) {
        return (
          <svg viewBox="0 0 40 16" style={{ width: "80%", height: "55%", opacity }}>
            <rect x="2" y="4" width="36" height="8" rx="3" fill={fill} />
            <rect x="15" y="2" width="10" height="12" rx="2" fill={fill} />
          </svg>
        );
      }
      if (w === 2 && h === 2) {
        return (
          <svg viewBox="0 0 36 36" style={{ width: "65%", height: "65%", opacity }}>
            <path d="M18 3C10 3 5 9 5 17v13c0 2 1 3 3 3h20c2 0 3-1 3-3V17c0-8-5-14-13-14z" fill={fill} />
            <rect x="5" y="26" width="26" height="3" rx="1" fill={fill} />
          </svg>
        );
      }
      if (w === 2 && h === 3) {
        return (
          <svg viewBox="0 0 36 52" style={{ width: "65%", height: "78%", opacity }}>
            <path d="M10 2h16l6 8v12l-3 3v19c0 3-2 6-5 6H12c-3 0-5-3-5-6V25l-3-3V10z" fill={fill} />
          </svg>
        );
      }
      if (w === 2 && h === 4) {
        return (
          <svg viewBox="0 0 24 76" style={{ width: "40%", height: "85%", opacity }}>
            <polygon points="12,0 16,6 14,6 14,50 10,50 10,6 8,6" fill={fill} />
            <rect x="4" y="50" width="16" height="4" rx="1" fill={fill} />
            <rect x="7" y="54" width="10" height="16" rx="3" fill={fill} />
          </svg>
        );
      }
      return null;
    }

    // In-game mockup: POE2 inventory grid with items, highlighted item, tooltip + LAMA overlay
    function InGameMockup({ sample, settings }) {
      const tooltip = MOCK_TOOLTIPS[sample.tierId] || MOCK_TOOLTIPS.great_find;
      const isPoe2 = settings.overlay_theme === "poe2";
      const text = buildSampleText(sample, settings, settings.overlay_theme);
      const tierStyle = getEffectiveOverlayTierStyle(sample.tierId, settings.overlay_tier_styles, settings.overlay_theme);
      const isBorderless = text === "\u2605";
      const isJunk = sample.isJunk;
      const fontSize = settings.font_size || 14;
      const fs = Math.max(9, Math.round(fontSize * 0.65));
      const rarityColors = { rare: "#ff7", unique: "#af6", magic: "#88f", normal: "#aaa" };
      const rarityBorders = { rare: "#665522", unique: "#336633", magic: "#333366", normal: "#333" };
      const nameColor = rarityColors[tooltip.rarity] || "#ff7";
      const CELL = 22; // px per inventory cell
      const GAP = 2;
      const COLS = 12;
      const ROWS = 5;
      const gridW = COLS * (CELL + GAP) - GAP;
      const gridH = ROWS * (CELL + GAP) - GAP;

      return (
        <div style={{
          position: "relative", background: "#08080e", borderRadius: 6,
          padding: "10px 12px", overflow: "hidden",
        }}>
          {/* Game-like ambient light */}
          <div style={{ position: "absolute", inset: 0, opacity: 0.06, pointerEvents: "none",
            backgroundImage: "radial-gradient(ellipse at 40% 30%, #886633 0%, transparent 50%), radial-gradient(ellipse at 80% 70%, #334466 0%, transparent 40%)",
          }} />
          <div style={{ position: "relative", display: "flex", alignItems: "flex-start", gap: 12 }}>
            {/* Inventory panel */}
            <div style={{
              background: "#0c0c14", border: "1px solid #2a2520", borderRadius: 3,
              padding: 6, flexShrink: 0,
              boxShadow: "inset 0 1px 4px rgba(0,0,0,0.5), 0 0 12px rgba(0,0,0,0.4)",
            }}>
              {/* Inventory title bar */}
              <div style={{ fontSize: 7, color: "#665544", textAlign: "center", marginBottom: 4, letterSpacing: 1, ...MONO }}>INVENTORY</div>
              {/* Grid */}
              <div style={{ position: "relative", width: gridW, height: gridH }}>
                {/* Empty cell grid */}
                {Array.from({ length: ROWS }, (_, r) =>
                  Array.from({ length: COLS }, (_, c) => (
                    <div key={`${c}-${r}`} style={{
                      position: "absolute",
                      left: c * (CELL + GAP), top: r * (CELL + GAP),
                      width: CELL, height: CELL,
                      background: "#0f0f18", border: "1px solid #1a1a22",
                      borderRadius: 1,
                    }} />
                  ))
                )}
                {/* Filler items */}
                {INV_FILLER_ITEMS.map((item, i) => {
                  // Skip cells that overlap with the highlighted item
                  const hc = tooltip.col, hr = tooltip.row, hw = tooltip.slotW, hh = tooltip.slotH;
                  const overlaps = item.col < hc + hw && item.col + item.w > hc && item.row < hr + hh && item.row + item.h > hr;
                  if (overlaps) return null;
                  const borderTint = rarityBorders[item.rarity] || "#222";
                  return (
                    <div key={`f${i}`} style={{
                      position: "absolute",
                      left: item.col * (CELL + GAP), top: item.row * (CELL + GAP),
                      width: item.w * (CELL + GAP) - GAP, height: item.h * (CELL + GAP) - GAP,
                      background: item.color, border: `1px solid ${borderTint}`,
                      borderRadius: 1,
                      backgroundImage: `linear-gradient(135deg, ${item.color} 40%, ${borderTint}22 100%)`,
                      display: "flex", alignItems: "center", justifyContent: "center",
                    }}>
                      <FillerItemIcon w={item.w} h={item.h} tintColor={borderTint} />
                    </div>
                  );
                })}
                {/* Highlighted item (hovered by cursor) */}
                <div style={{
                  position: "absolute",
                  left: tooltip.col * (CELL + GAP), top: tooltip.row * (CELL + GAP),
                  width: tooltip.slotW * (CELL + GAP) - GAP, height: tooltip.slotH * (CELL + GAP) - GAP,
                  background: "#1a1828", border: `1px solid ${nameColor}88`,
                  borderRadius: 1,
                  boxShadow: `0 0 8px ${nameColor}33, inset 0 0 6px ${nameColor}11`,
                  backgroundImage: `linear-gradient(135deg, #1a1828 30%, ${nameColor}0a 100%)`,
                }} />
                {/* Cursor arrow on the highlighted item */}
                <div style={{
                  position: "absolute",
                  left: tooltip.col * (CELL + GAP) + (tooltip.slotW * (CELL + GAP) - GAP) / 2 - 3,
                  top: tooltip.row * (CELL + GAP) + (tooltip.slotH * (CELL + GAP) - GAP) / 2 - 4,
                  pointerEvents: "none",
                }}>
                  <svg width="12" height="16" viewBox="0 0 12 16" fill="none">
                    <path d="M1 1L1 13L4.5 9.5L7.5 15L9.5 14L6.5 8L11 7.5L1 1Z" fill="#ffffffcc" stroke="#00000088" strokeWidth="0.5"/>
                  </svg>
                </div>
              </div>
            </div>

            {/* Tooltip + overlay — floats right of inventory */}
            <div style={{ display: "flex", flexDirection: "column", gap: 6, paddingTop: 2, minWidth: 0 }}>
              {/* Mock POE2 item tooltip */}
              <div style={{
                background: "#111118ee", border: "1px solid #33334488", borderRadius: 2,
                padding: "6px 10px", minWidth: 160, maxWidth: 200,
                boxShadow: "0 2px 12px rgba(0,0,0,0.6)",
              }}>
                <div style={{ fontSize: 7, color: "#555", marginBottom: 2, ...MONO }}>{tooltip.itemClass}</div>
                <div style={{ height: 1, background: nameColor, opacity: 0.3, marginBottom: 3 }} />
                <div style={{ fontSize: 10, fontWeight: 700, color: nameColor, marginBottom: 1, ...MONO }}>{tooltip.name}</div>
                <div style={{ fontSize: 8, color: nameColor, opacity: 0.7, marginBottom: 4, ...MONO }}>{tooltip.base}</div>
                <div style={{ height: 1, background: "#333", marginBottom: 4 }} />
                {tooltip.mods.map((mod, i) => (
                  <div key={i} style={{ fontSize: 7, color: "#8888cc", lineHeight: 1.5, ...MONO }}>{mod}</div>
                ))}
                <div style={{ height: 1, background: "#333", margin: "4px 0 2px" }} />
                <div style={{ fontSize: 7, color: "#444", ...MONO }}>Item Level: {tooltip.ilvl}</div>
              </div>
              {/* LAMA overlay tag */}
              {(() => {
                const isPoe2 = settings.overlay_theme === "poe2";
                const defaultBg = isPoe2 ? "#1a120c" : "#1a1a2e";
                const defaultBorder = isPoe2 ? "#3d2e1e" : "#333355";
                const fontFam = isPoe2 ? "'Palatino Linotype', 'Book Antiqua', Georgia, serif" : undefined;
                const showGrunge = isPoe2 && !isBorderless && !isJunk;
                const mbw = tierStyle.border_width || sample.borderWidth || 2;
                const poe2Shadow = showGrunge
                  ? `inset 0 0 0 ${mbw}px rgba(107,85,48,0.35), inset 2px 1px 3px rgba(58,10,8,0.5), inset -2px -1px 3px rgba(58,10,8,0.3), inset 0 0 6px rgba(13,8,4,0.6), 0 1px 6px rgba(0,0,0,0.5)`
                  : (isBorderless || isJunk) ? "none" : "0 1px 6px rgba(0,0,0,0.5)";
                const mSheenOnly = isPoe2 && (settings.overlay_pulse_style || "sheen") === "sheen";
                const mEffBorderColor = (mSheenOnly && sample.poe2Animation) ? defaultBorder : (tierStyle.border_color || defaultBorder);
                const mEffBorderWidth = (mSheenOnly && sample.poe2Animation) ? 2 : (tierStyle.border_width || sample.borderWidth);
                return (
                  <div style={{
                    display: "inline-flex", alignItems: "center", alignSelf: "flex-start",
                    position: "relative", overflow: "hidden",
                    padding: isBorderless ? "1px 4px" : isJunk ? "2px 6px" : isPoe2 ? "3px 8px" : "2px 6px",
                    background: (isBorderless || isJunk) ? "transparent" : (tierStyle.bg_color || defaultBg),
                    border: (isBorderless || isJunk) ? "none" : `${mEffBorderWidth}px solid ${mEffBorderColor}`,
                    borderRadius: isPoe2 ? 1 : 3,
                    color: sample.textAnim ? undefined : (tierStyle.text_color || "#95a5a6"),
                    fontSize: fs,
                    fontWeight: 700,
                    fontFamily: fontFam,
                    ...(!isPoe2 ? MONO : {}),
                    whiteSpace: "nowrap",
                    animation: (() => {
                      if (isBorderless || isJunk) return "none";
                      const ps = settings.overlay_pulse_style || "sheen";
                      const wantBorder = ps === "border" || ps === "both";
                      if (!wantBorder) return "none";
                      return isPoe2 && sample.poe2Animation ? sample.poe2Animation : sample.animation;
                    })(),
                    boxShadow: poe2Shadow,
                  }}>
                    {showGrunge && (
                      <React.Fragment>
                        {/* Edge vignette */}
                        <div style={{ position: "absolute", inset: 0, pointerEvents: "none", borderRadius: 1,
                          backgroundImage: "linear-gradient(90deg, rgba(13,8,4,0.45) 0%, transparent 14%, transparent 86%, rgba(13,8,4,0.45) 100%)" }} />
                        {/* Decorative rule lines */}
                        <div style={{ position: "absolute", top: 3, left: 6, right: 6, height: 1, background: "#6b5530", opacity: 0.8 }} />
                        <div style={{ position: "absolute", bottom: 3, left: 6, right: 6, height: 1, background: "#6b5530", opacity: 0.8 }} />
                        {/* Corner diamonds */}
                        <svg style={{ position: "absolute", top: -1, left: -1, width: 5, height: 5, overflow: "visible" }}><polygon points="2.5,0 5,2.5 2.5,5 0,2.5" fill="#c4a456" /></svg>
                        <svg style={{ position: "absolute", top: -1, right: -1, width: 5, height: 5, overflow: "visible" }}><polygon points="2.5,0 5,2.5 2.5,5 0,2.5" fill="#c4a456" /></svg>
                        <svg style={{ position: "absolute", bottom: -1, left: -1, width: 5, height: 5, overflow: "visible" }}><polygon points="2.5,0 5,2.5 2.5,5 0,2.5" fill="#c4a456" /></svg>
                        <svg style={{ position: "absolute", bottom: -1, right: -1, width: 5, height: 5, overflow: "visible" }}><polygon points="2.5,0 5,2.5 2.5,5 0,2.5" fill="#c4a456" /></svg>
                        {/* Blood splatter marks (6 ovals matching overlay) */}
                        <div style={{ position: "absolute", top: "15%", left: "8%", width: 3, height: 2, background: "#3a0a08", borderRadius: "50%", opacity: 0.7 }} />
                        <div style={{ position: "absolute", top: "20%", right: "10%", width: 2, height: 3, background: "#3a0a08", borderRadius: "50%", opacity: 0.5 }} />
                        <div style={{ position: "absolute", bottom: "20%", left: "12%", width: 2, height: 2, background: "#3a0a08", borderRadius: "50%", opacity: 0.6 }} />
                        <div style={{ position: "absolute", bottom: "25%", right: "8%", width: 3, height: 2, background: "#3a0a08", borderRadius: "50%", opacity: 0.5 }} />
                        <div style={{ position: "absolute", top: "10%", left: "45%", width: 2, height: 2, background: "#3a0a08", borderRadius: "50%", opacity: 0.5 }} />
                        <div style={{ position: "absolute", bottom: "10%", left: "55%", width: 2, height: 2, background: "#3a0a08", borderRadius: "50%", opacity: 0.5 }} />
                        {/* Scratch marks */}
                        <div style={{ position: "absolute", top: "12%", left: "5%", width: 8, height: 1, background: "#5c1510", transform: "rotate(-15deg)", opacity: 0.5 }} />
                        <div style={{ position: "absolute", top: "10%", right: "7%", width: 6, height: 1, background: "#5c1510", transform: "rotate(20deg)", opacity: 0.4 }} />
                        <div style={{ position: "absolute", bottom: "14%", left: "15%", width: 7, height: 1, background: "#5c1510", transform: "rotate(10deg)", opacity: 0.4 }} />
                        <div style={{ position: "absolute", bottom: "12%", right: "5%", width: 5, height: 1, background: "#5c1510", transform: "rotate(-25deg)", opacity: 0.5 }} />
                        {/* Sheen sweep band */}
                        {(() => {
                          const ps = settings.overlay_pulse_style || "sheen";
                          const wantSheen = ps === "sheen" || ps === "both";
                          if (!wantSheen || !sample.poe2Animation) return null;
                          const sheenColor = "#c4a456";
                          return (
                            <div style={{
                              position: "absolute", top: 2, bottom: 2, width: "28%",
                              background: `linear-gradient(90deg, transparent, ${sheenColor}44, ${sheenColor}88, ${sheenColor}44, transparent)`,
                              animation: "sheenSweep 3.6s ease-in-out infinite",
                              pointerEvents: "none", borderRadius: 1,
                            }} />
                          );
                        })()}
                        {/* Star pips — small gold diamonds on bottom rule line */}
                        {settings.overlay_show_stars !== false && sample.stars > 0 && (
                          <div style={{ position: "absolute", bottom: 1, left: 0, right: 0, display: "flex", justifyContent: "center", gap: 3, pointerEvents: "none" }}>
                            {Array.from({ length: sample.stars }, (_, i) => (
                              <svg key={i} width="5" height="5" viewBox="0 0 5 5" style={{ display: "block" }}>
                                <polygon points="2.5,0 5,2.5 2.5,5 0,2.5" fill="#c4a456" />
                              </svg>
                            ))}
                          </div>
                        )}
                      </React.Fragment>
                    )}
                    {text}
                  </div>
                );
              })()}
            </div>
          </div>
        </div>
      );
    }

    // POE2 item art from official CDN (web.poecdn.com)
    const PREVIEW_ITEM_ART = {
      sword2h: "https://web.poecdn.com/gen/image/WzI1LDE0LHsiZiI6IjJESXRlbXMvV2VhcG9ucy9Ud29IYW5kV2VhcG9ucy9Ud29IYW5kU3dvcmRzL0Jhc2V0eXBlcy8ySFN3b3JkMDEiLCJ3IjoyLCJoIjo0LCJzY2FsZSI6MSwicmVhbG0iOiJwb2UyIn1d/00f6c5db86/2HSword01.png",
      bodyArmor: "https://web.poecdn.com/gen/image/WzI1LDE0LHsiZiI6IjJESXRlbXMvQXJtb3Vycy9Cb2R5QXJtb3Vycy9CYXNldHlwZXMvQm9keVN0cjA3IiwidyI6MiwiaCI6Mywic2NhbGUiOjEsInJlYWxtIjoicG9lMiJ9XQ/4e67af290e/BodyStr07.png",
      helmet: "https://web.poecdn.com/gen/image/WzI1LDE0LHsiZiI6IjJESXRlbXMvQXJtb3Vycy9IZWxtZXRzL0Jhc2V0eXBlcy9IZWxtZXRTdHIwMSIsInciOjIsImgiOjIsInNjYWxlIjoxLCJyZWFsbSI6InBvZTIifV0/43e780c05c/HelmetStr01.png",
      ring: "https://web.poecdn.com/gen/image/WzI1LDE0LHsiZiI6IjJESXRlbXMvUmluZ3MvQmFzZXR5cGVzL1NhcHBoaXJlUmluZyIsInciOjEsImgiOjEsInNjYWxlIjoxLCJyZWFsbSI6InBvZTIifV0/14608c24b1/SapphireRing.png",
      boots: "https://web.poecdn.com/gen/image/WzI1LDE0LHsiZiI6IjJESXRlbXMvQXJtb3Vycy9Cb290cy9CYXNldHlwZXMvQm9vdHNTdHIwMiIsInciOjIsImgiOjIsInNjYWxlIjoxLCJyZWFsbSI6InBvZTIifV0/70eea32d34/BootsStr02.png",
      gloves: "https://web.poecdn.com/gen/image/WzI1LDE0LHsiZiI6IjJESXRlbXMvQXJtb3Vycy9HbG92ZXMvQmFzZXR5cGVzL0dsb3Zlc1N0cjAxIiwidyI6MiwiaCI6Miwic2NhbGUiOjEsInJlYWxtIjoicG9lMiJ9XQ/9087556afe/GlovesStr01.png",
    };

    // Preview grid items — fills 8×4 grid, each with optional item art + overlay tier
    // Layout:  col 0-1: sword(2×4)  col 2-3: armor(2×3)+belt  col 4-5: helm(2×2)+boots(2×2)  col 6-7: ring+amulet+gloves(2×2)+belt
    const PREVIEW_GRID_ITEMS = [
      { col: 0, row: 0, w: 2, h: 4, rarity: "rare",   art: PREVIEW_ITEM_ART.sword2h,   tierId: "jackpot" },
      { col: 2, row: 0, w: 2, h: 3, rarity: "rare",   art: PREVIEW_ITEM_ART.bodyArmor, tierId: "big_hit" },
      { col: 4, row: 0, w: 2, h: 2, rarity: "rare",   art: PREVIEW_ITEM_ART.helmet,    tierId: "vendor" },
      { col: 6, row: 0, w: 1, h: 1, rarity: "rare",   art: PREVIEW_ITEM_ART.ring,      tierId: "great_find" },
      { col: 7, row: 0, w: 1, h: 1, rarity: "magic",  art: null,                        tierId: null },
      { col: 6, row: 1, w: 2, h: 2, rarity: "rare",   art: PREVIEW_ITEM_ART.gloves,    tierId: "worth_sell" },
      { col: 4, row: 2, w: 2, h: 2, rarity: "rare",   art: PREVIEW_ITEM_ART.boots,     tierId: "good_find" },
      { col: 2, row: 3, w: 2, h: 1, rarity: "magic",  art: null,                        tierId: null },
      { col: 6, row: 3, w: 2, h: 1, rarity: "normal", art: null,                        tierId: null },
    ];

    // Inventory preview: POE2-style grid with real item art + overlay price bars
    function InventoryPreview({ settings }) {
      const CELL = 40, GAP = 2, COLS = 8, ROWS = 4;
      const gridW = COLS * (CELL + GAP) - GAP;
      const gridH = ROWS * (CELL + GAP) - GAP;
      const rarityColors = { rare: "#ff7", unique: "#af6", magic: "#88f", normal: "#aaa" };
      const rarityBorders = { rare: "#665522", unique: "#336633", magic: "#333366", normal: "#333" };

      return (
        <div style={{
          position: "relative", background: "#08080e", borderRadius: 6,
          padding: "8px 10px", overflow: "hidden",
        }}>
          {/* Game-like ambient light */}
          <div style={{ position: "absolute", inset: 0, opacity: 0.06, pointerEvents: "none",
            backgroundImage: "radial-gradient(ellipse at 40% 30%, #886633 0%, transparent 50%), radial-gradient(ellipse at 80% 70%, #334466 0%, transparent 40%)",
          }} />
          <div style={{ position: "relative" }}>
            <div style={{
              background: "#0c0c14", border: "1px solid #2a2520", borderRadius: 3,
              padding: 5, boxShadow: "inset 0 1px 4px rgba(0,0,0,0.5), 0 0 12px rgba(0,0,0,0.4)",
            }}>
              <div style={{ fontSize: 7, color: "#665544", textAlign: "center", marginBottom: 3, letterSpacing: 1, ...MONO }}>INVENTORY</div>
              <div style={{ position: "relative", width: gridW, height: gridH }}>
                {/* Empty cell grid */}
                {Array.from({ length: ROWS }, (_, r) =>
                  Array.from({ length: COLS }, (_, c) => (
                    <div key={`${c}-${r}`} style={{
                      position: "absolute",
                      left: c * (CELL + GAP), top: r * (CELL + GAP),
                      width: CELL, height: CELL,
                      background: "#0f0f18", border: "1px solid #1a1a22", borderRadius: 1,
                    }} />
                  ))
                )}
                {/* Items with real art */}
                {PREVIEW_GRID_ITEMS.map((item, i) => {
                  const nameColor = rarityColors[item.rarity] || "#aaa";
                  const borderTint = rarityBorders[item.rarity] || "#222";
                  const hasOverlay = !!item.tierId;
                  const cellW = item.w * (CELL + GAP) - GAP;
                  const cellH = item.h * (CELL + GAP) - GAP;
                  return (
                    <div key={`item${i}`} style={{
                      position: "absolute",
                      left: item.col * (CELL + GAP), top: item.row * (CELL + GAP),
                      width: cellW, height: cellH,
                      background: hasOverlay ? "#1a1828" : "#12121a",
                      border: `1px solid ${hasOverlay ? nameColor + "88" : borderTint}`,
                      borderRadius: 1,
                      backgroundImage: hasOverlay
                        ? `linear-gradient(135deg, #1a1828 30%, ${nameColor}0a 100%)`
                        : `linear-gradient(135deg, #12121a 40%, ${borderTint}22 100%)`,
                      boxShadow: hasOverlay ? `0 0 8px ${nameColor}22` : undefined,
                      display: "flex", alignItems: "center", justifyContent: "center",
                      overflow: "hidden",
                    }}>
                      {item.art ? (
                        <img src={item.art} alt="" style={{
                          width: "92%", height: "92%", objectFit: "contain",
                          imageRendering: "auto", opacity: 0.85, pointerEvents: "none",
                        }} />
                      ) : (
                        <FillerItemIcon w={item.w} h={item.h} tintColor={borderTint} />
                      )}
                    </div>
                  );
                })}
                {/* Overlay price bars — reuse OverlaySampleChip for 1:1 match */}
                {PREVIEW_GRID_ITEMS.filter(item => item.tierId).map(item => {
                  const sample = OVERLAY_SAMPLES.find(s => s.tierId === item.tierId);
                  if (!sample) return null;
                  const cellW = item.w * (CELL + GAP) - GAP;
                  const cx = item.col * (CELL + GAP) + cellW / 2;
                  const by = (item.row + item.h) * (CELL + GAP) - GAP - 3;
                  return (
                    <div key={`bar-${item.tierId}`} style={{
                      position: "absolute", left: cx, top: by, zIndex: 3,
                      transform: "translate(-50%, -100%)",
                    }}>
                      <OverlaySampleChip sample={sample} settings={settings} compact={false} />
                    </div>
                  );
                })}
              </div>
            </div>
          </div>
        </div>
      );
    }

    // Render a single overlay sample chip using effective tier style
    function OverlaySampleChip({ sample, settings, compact }) {
      const isPoe2 = settings.overlay_theme === "poe2";
      const text = buildSampleText(sample, settings, settings.overlay_theme);
      const isBorderless = text === "\u2605";
      const isJunk = sample.isJunk;
      const fontSize = settings.font_size || 14;
      const fs = Math.max(9, Math.round(fontSize * 0.7));
      const tierStyle = getEffectiveOverlayTierStyle(sample.tierId, settings.overlay_tier_styles, settings.overlay_theme);
      const defaultBg = isPoe2 ? "#1a120c" : "#1a1a2e";
      const defaultBorder = isPoe2 ? "#3d2e1e" : "#333355";
      const fontFamily = isPoe2 ? "'Palatino Linotype', 'Book Antiqua', Georgia, serif" : "'JetBrains Mono', 'Fira Code', monospace";
      const showGrunge = isPoe2 && !isBorderless && !isJunk;
      // Grunge: inner accent border ring + blood-stained inset shadows + edge darkening
      const bw = tierStyle.border_width || sample.borderWidth || 2;
      const poe2Shadow = showGrunge
        ? `inset 0 0 0 ${bw}px rgba(107,85,48,0.35), inset 2px 1px 4px rgba(58,10,8,0.6), inset -2px -1px 4px rgba(58,10,8,0.4), inset 0 0 8px rgba(13,8,4,0.7)`
        : undefined;

      const sheenOnly = isPoe2 && (settings.overlay_pulse_style || "sheen") === "sheen";
      const effectiveBorderColor = (sheenOnly && sample.poe2Animation) ? defaultBorder : (tierStyle.border_color || defaultBorder);
      const effectiveBorderWidth = (sheenOnly && sample.poe2Animation) ? 2 : (tierStyle.border_width || sample.borderWidth);

      return (
        <div style={{
          display: "inline-flex", alignItems: "center", position: "relative",
          overflow: "hidden",
          padding: isBorderless ? "1px 4px" : isJunk ? "2px 8px" : isPoe2 ? "3px 10px" : "2px 8px",
          background: (isBorderless || isJunk) ? "transparent" : (tierStyle.bg_color || defaultBg),
          border: (isBorderless || isJunk) ? "none" : `${effectiveBorderWidth}px solid ${effectiveBorderColor}`,
          borderRadius: isPoe2 ? 1 : 3,
          color: sample.textAnim ? undefined : (tierStyle.text_color || "#95a5a6"),
          fontSize: compact ? Math.max(8, fs - 1) : (isBorderless ? Math.round(fs * 1.3) : fs),
          fontWeight: 700,
          fontFamily,
          whiteSpace: "nowrap",
          animation: (() => {
            if (isBorderless || isJunk) return "none";
            const ps = settings.overlay_pulse_style || "sheen";
            const wantBorder = ps === "border" || ps === "both";
            if (!wantBorder) return "none";
            return isPoe2 && sample.poe2Animation ? sample.poe2Animation : sample.animation;
          })(),
          transition: "all 0.2s ease",
          minWidth: compact ? 18 : 24,
          justifyContent: "center",
          boxShadow: poe2Shadow,
        }}>
          {showGrunge && (
            <React.Fragment>
              {/* Edge vignette — dark gradient on left/right edges */}
              <div style={{ position: "absolute", inset: 0, pointerEvents: "none", borderRadius: 1,
                backgroundImage: "linear-gradient(90deg, rgba(13,8,4,0.45) 0%, transparent 14%, transparent 86%, rgba(13,8,4,0.45) 100%)" }} />
              {/* Decorative rule lines — thin gold accent near top/bottom */}
              <div style={{ position: "absolute", top: 3, left: 6, right: 6, height: 1, background: "#6b5530", opacity: 0.8 }} />
              <div style={{ position: "absolute", bottom: 3, left: 6, right: 6, height: 1, background: "#6b5530", opacity: 0.8 }} />
              {/* Corner diamonds (SVG) */}
              <svg style={{ position: "absolute", top: -1, left: -1, width: 6, height: 6, overflow: "visible" }}>
                <polygon points="3,0 6,3 3,6 0,3" fill="#c4a456" />
              </svg>
              <svg style={{ position: "absolute", top: -1, right: -1, width: 6, height: 6, overflow: "visible" }}>
                <polygon points="3,0 6,3 3,6 0,3" fill="#c4a456" />
              </svg>
              <svg style={{ position: "absolute", bottom: -1, left: -1, width: 6, height: 6, overflow: "visible" }}>
                <polygon points="3,0 6,3 3,6 0,3" fill="#c4a456" />
              </svg>
              <svg style={{ position: "absolute", bottom: -1, right: -1, width: 6, height: 6, overflow: "visible" }}>
                <polygon points="3,0 6,3 3,6 0,3" fill="#c4a456" />
              </svg>
              {/* Blood splatter marks (6 ovals matching overlay) */}
              <div style={{ position: "absolute", top: "15%", left: "8%", width: 3, height: 2, background: "#3a0a08", borderRadius: "50%", opacity: 0.7 }} />
              <div style={{ position: "absolute", top: "20%", right: "10%", width: 2, height: 3, background: "#3a0a08", borderRadius: "50%", opacity: 0.5 }} />
              <div style={{ position: "absolute", bottom: "20%", left: "12%", width: 2, height: 2, background: "#3a0a08", borderRadius: "50%", opacity: 0.6 }} />
              <div style={{ position: "absolute", bottom: "25%", right: "8%", width: 3, height: 2, background: "#3a0a08", borderRadius: "50%", opacity: 0.5 }} />
              <div style={{ position: "absolute", top: "10%", left: "45%", width: 2, height: 2, background: "#3a0a08", borderRadius: "50%", opacity: 0.5 }} />
              <div style={{ position: "absolute", bottom: "10%", left: "55%", width: 2, height: 2, background: "#3a0a08", borderRadius: "50%", opacity: 0.5 }} />
              {/* Scratch marks (4 angled lines matching overlay) */}
              <div style={{ position: "absolute", top: "12%", left: "5%", width: 8, height: 1, background: "#5c1510", transform: "rotate(-15deg)", opacity: 0.5 }} />
              <div style={{ position: "absolute", top: "10%", right: "7%", width: 6, height: 1, background: "#5c1510", transform: "rotate(20deg)", opacity: 0.4 }} />
              <div style={{ position: "absolute", bottom: "14%", left: "15%", width: 7, height: 1, background: "#5c1510", transform: "rotate(10deg)", opacity: 0.4 }} />
              <div style={{ position: "absolute", bottom: "12%", right: "5%", width: 5, height: 1, background: "#5c1510", transform: "rotate(-25deg)", opacity: 0.5 }} />
              {/* Sheen sweep band */}
              {(() => {
                const ps = settings.overlay_pulse_style || "sheen";
                const wantSheen = ps === "sheen" || ps === "both";
                if (!wantSheen || !sample.poe2Animation) return null;
                const sheenColor = "#c4a456";
                return (
                  <div style={{
                    position: "absolute", top: 2, bottom: 2, width: "28%",
                    background: `linear-gradient(90deg, transparent, ${sheenColor}44, ${sheenColor}88, ${sheenColor}44, transparent)`,
                    animation: "sheenSweep 3.6s ease-in-out infinite",
                    pointerEvents: "none", borderRadius: 1,
                  }} />
                );
              })()}
              {/* Star pips — small gold diamonds on bottom rule line */}
              {settings.overlay_show_stars !== false && sample.stars > 0 && (
                <div style={{ position: "absolute", bottom: -2, left: 0, right: 0, display: "flex", justifyContent: "center", gap: 2, pointerEvents: "none" }}>
                  {Array.from({ length: sample.stars }, (_, i) => (
                    <svg key={i} width="4" height="4" viewBox="0 0 4 4" style={{ display: "block" }}>
                      <polygon points="2,0 4,2 2,4 0,2" fill="#c4a456" />
                    </svg>
                  ))}
                </div>
              )}
            </React.Fragment>
          )}
          {text}
        </div>
      );
    }

    // Single tier editor row with color pickers and sound toggle
    function OverlayTierRow({ sample, settings, onUpdate }) {
      const tierStyle = getEffectiveOverlayTierStyle(sample.tierId, settings.overlay_tier_styles, settings.overlay_theme);
      const isJunk = sample.isJunk;

      const updateField = (field, value) => {
        const current = settings.overlay_tier_styles || {};
        const tierCurrent = current[sample.tierId] || {};
        onUpdate({
          overlay_tier_styles: { ...current, [sample.tierId]: { ...tierCurrent, [field]: value } }
        });
      };

      return (
        <div style={{
          display: "grid",
          gridTemplateColumns: "40px 1fr 24px 24px 24px 28px",
          alignItems: "center",
          gap: 8,
          padding: "3px 0",
        }}>
          {/* Live preview chip */}
          <OverlaySampleChip sample={sample} settings={settings} compact={true} />
          {/* Tier label */}
          <div style={{ overflow: "hidden", whiteSpace: "nowrap", textOverflow: "ellipsis" }}>
            <span style={{ fontSize: 10, color: T.textSecond, fontWeight: 600 }}>{sample.label}</span>
            <span style={{ fontSize: 9, color: T.textMuted, marginLeft: 4 }}>{sample.desc}</span>
          </div>
          {/* Text color picker */}
          <Tooltip text="Text color">
            <input type="color" value={tierStyle.text_color || "#95a5a6"}
              onChange={(e) => updateField("text_color", e.target.value)}
              style={{ width: 24, height: 24, border: `1px solid ${T.border}`, borderRadius: 3, padding: 0, cursor: "pointer", background: "transparent" }}
            />
          </Tooltip>
          {/* Border color picker */}
          <Tooltip text="Border color">
            <input type="color" value={tierStyle.border_color || "#333355"}
              onChange={(e) => updateField("border_color", e.target.value)}
              disabled={isJunk}
              style={{ width: 24, height: 24, border: `1px solid ${T.border}`, borderRadius: 3, padding: 0, cursor: isJunk ? "not-allowed" : "pointer", background: "transparent", opacity: isJunk ? 0.3 : 1 }}
            />
          </Tooltip>
          {/* BG color picker */}
          <Tooltip text="Background color">
            <input type="color" value={tierStyle.bg_color || "#1a1a2e"}
              onChange={(e) => updateField("bg_color", e.target.value)}
              disabled={isJunk}
              style={{ width: 24, height: 24, border: `1px solid ${T.border}`, borderRadius: 3, padding: 0, cursor: isJunk ? "not-allowed" : "pointer", background: "transparent", opacity: isJunk ? 0.3 : 1 }}
            />
          </Tooltip>
          {/* Sound toggle (UI only) */}
          <Toggle value={tierStyle.sound_enabled || false}
            onChange={(v) => updateField("sound_enabled", v)}
            size="small" />
        </div>
      );
    }

    function OverlayPreview({ settings, onUpdate }) {
      const [expanded, setExpanded] = useState(false);
      const [selectedTierId, setSelectedTierId] = useState("great_find");
      const showStars = settings.overlay_show_stars !== false;
      const fontSize = settings.font_size || 14;
      const fs = Math.max(9, Math.round(fontSize * 0.7));
      // Representative samples for collapsed view
      const collapsedSamples = OVERLAY_SAMPLES.filter(s =>
        s.tierId === "mirror" || s.tierId === "great_find" || s.tierId === "vendor"
      );
      const selectedSample = OVERLAY_SAMPLES.find(s => s.tierId === selectedTierId) || OVERLAY_SAMPLES[3];

      return (
        <div style={{ marginTop: 12 }}>
          <div
            onClick={() => setExpanded(!expanded)}
            style={{ ...LABEL, marginBottom: 8, cursor: "pointer", display: "flex", alignItems: "center", gap: 6, userSelect: "none" }}
          >
            <span style={{ fontSize: 9, color: T.textMuted, transition: "transform 0.2s", transform: expanded ? "rotate(90deg)" : "none" }}>{"\u25B6"}</span>
            Overlay Preview
          </div>

          {!expanded ? (
            /* Collapsed: compact row of representative chips */
            <div
              onClick={() => setExpanded(true)}
              style={{
                background: T.input, border: `1px solid ${T.border}`, borderRadius: 6,
                padding: "8px 12px", display: "flex", alignItems: "center", gap: 10, cursor: "pointer",
              }}
            >
              {collapsedSamples.map(sample => (
                <OverlaySampleChip key={sample.tierId} sample={sample} settings={settings} compact={true} />
              ))}
              <span style={{ fontSize: 9, color: T.textMuted, marginLeft: "auto" }}>Click to expand</span>
            </div>
          ) : (
            /* Expanded: full preview + tier editor */
            <div style={{
              background: T.input, border: `1px solid ${T.border}`, borderRadius: 6,
              padding: 14, display: "flex", flexDirection: "column", gap: 10,
            }}>
              {/* Tier selector chips — click to change the mockup */}
              <div style={{ display: "flex", flexWrap: "wrap", gap: 4 }}>
                {OVERLAY_SAMPLES.map(sample => (
                  <div
                    key={sample.tierId}
                    onClick={() => setSelectedTierId(sample.tierId)}
                    style={{
                      display: "flex", alignItems: "center", gap: 6,
                      padding: "3px 8px", borderRadius: 3, cursor: "pointer",
                      background: sample.tierId === selectedTierId ? T.border + "44" : "transparent",
                      border: `1px solid ${sample.tierId === selectedTierId ? T.border : "transparent"}`,
                      transition: "all 0.15s ease",
                    }}
                  >
                    <OverlaySampleChip sample={sample} settings={settings} compact={true} />
                    <span style={{ fontSize: 9, color: sample.tierId === selectedTierId ? T.textSecond : T.textMuted, fontWeight: sample.tierId === selectedTierId ? 600 : 400 }}>{sample.label}</span>
                  </div>
                ))}
              </div>
              {/* Stars legend */}
              {showStars && (
                <div style={{ fontSize: 9, color: T.textMuted, borderTop: `1px solid ${T.border}33`, paddingTop: 8 }}>
                  {"\u2605"} = top-tier mod rolls (T1{"\u2013"}T2)
                </div>
              )}
              {/* Tier color editor */}
              <div style={{ borderTop: `1px solid ${T.border}33`, paddingTop: 10 }}>
                <div style={{
                  display: "grid", gridTemplateColumns: "40px 1fr 24px 24px 24px 28px",
                  gap: 8, alignItems: "center", marginBottom: 4,
                }}>
                  <div />
                  <div style={{ ...LABEL, fontSize: 9 }}>Tier Colors</div>
                  <span style={{ fontSize: 8, color: T.textMuted, textAlign: "center" }}>Text</span>
                  <span style={{ fontSize: 8, color: T.textMuted, textAlign: "center" }}>Border</span>
                  <span style={{ fontSize: 8, color: T.textMuted, textAlign: "center" }}>BG</span>
                  <span style={{ fontSize: 8, color: T.textMuted, textAlign: "center" }}>Sound</span>
                </div>
                {OVERLAY_SAMPLES.map(sample => (
                  <OverlayTierRow key={sample.tierId} sample={sample} settings={settings} onUpdate={onUpdate} />
                ))}
                {/* Reset to defaults link */}
                {Object.keys(settings.overlay_tier_styles || {}).length > 0 && (
                  <div style={{ marginTop: 6, textAlign: "right" }}>
                    <span
                      onClick={() => onUpdate({ overlay_tier_styles: {} })}
                      style={{ fontSize: 9, color: T.textMuted, cursor: "pointer", textDecoration: "underline" }}
                    >Reset to defaults</span>
                  </div>
                )}
              </div>
              {/* Detection settings — moved from main grid */}
              <div style={{ borderTop: `1px solid ${T.border}33`, paddingTop: 10, marginTop: 4 }}>
                <div style={{ ...LABEL, marginBottom: 8, fontSize: 9 }}>Detection</div>
                <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "6px 12px" }}>
                  <SettingsField label="Scan FPS" field="scan_fps" value={settings.scan_fps} onUpdate={onUpdate} min={1} max={30} step={1} helpText="Checks/sec" />
                  <SettingsField label="Cooldown" field="detection_cooldown" value={settings.detection_cooldown} onUpdate={onUpdate} min={0.1} max={5} step={0.1} helpText="Sec between" />
                  <SettingsField label="Still Radius" field="cursor_still_radius" value={settings.cursor_still_radius} onUpdate={onUpdate} min={5} max={50} step={1} helpText="Max px" />
                  <SettingsField label="Still Frames" field="cursor_still_frames" value={settings.cursor_still_frames} onUpdate={onUpdate} min={1} max={10} step={1} helpText="Frames" />
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    // -----------------------------------------------------------------------
    // ItemLookupCard — paste item text, get parsed results
    // -----------------------------------------------------------------------
    function ItemLookupCard() {
      const [text, setText] = useState("");
      const [result, setResult] = useState(null);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState(null);
      const [collapsed, setCollapsed] = useState(false);

      const doLookup = async (itemText) => {
        if (!itemText || !itemText.trim()) return;
        setLoading(true);
        setError(null);
        setResult(null);
        const res = await api("/api/item-lookup", "POST", { text: itemText.trim() });
        setLoading(false);
        if (res.error) {
          setError(res.error);
        } else {
          setResult(res);
        }
      };

      const handlePaste = async () => {
        try {
          const clip = await navigator.clipboard.readText();
          if (clip) {
            setText(clip);
            doLookup(clip);
          }
        } catch (e) {
          setError("Clipboard access denied");
        }
      };

      const handleKeyDown = (e) => {
        if (e.ctrlKey && e.key === "Enter") doLookup(text);
      };

      const gradeColor = (grade) => {
        if (grade === "S") return PRICE_COLOR_HIGH;
        if (grade === "A") return PRICE_COLOR_GOOD;
        if (grade === "B") return PRICE_COLOR_DECENT;
        return PRICE_COLOR_LOW;
      };

      return (
        <div className="panel" style={{ ...CARD, padding: 12, marginBottom: 12 }}>
          <div
            style={{ display: "flex", justifyContent: "space-between", alignItems: "center", cursor: "pointer", userSelect: "none" }}
            onClick={() => setCollapsed(!collapsed)}
          >
            <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
              <span style={LABEL}>Item Lookup</span>
              <span style={{ fontSize: 10, color: T.textMuted }}>Paste item text to analyze</span>
            </div>
            <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
              {!collapsed && (
                <button onClick={(e) => { e.stopPropagation(); handlePaste(); }} style={{
                  background: "transparent", border: "none", fontSize: 10, fontWeight: 600,
                  cursor: "pointer", letterSpacing: "0.06em", color: T.gold, transition: "color 0.15s",
                }}>PASTE FROM CLIPBOARD</button>
              )}
              <div style={{
                fontSize: 11, color: T.textSecond,
                transform: collapsed ? "rotate(0deg)" : "rotate(180deg)",
                transition: "transform 0.15s",
              }}>&#9660;</div>
            </div>
          </div>
          {!collapsed && (
            <div style={{ marginTop: 10 }}>
              <textarea
                value={text}
                onChange={(e) => setText(e.target.value)}
                onKeyDown={handleKeyDown}
                onPaste={(e) => {
                  setTimeout(() => {
                    const pasted = e.target.value;
                    if (pasted.trim()) doLookup(pasted.trim());
                  }, 50);
                }}
                placeholder="Paste item text here (Ctrl+C on any item in-game)..."
                rows={4}
                style={{ ...FIELD_INPUT, resize: "vertical", marginBottom: 8, fontSize: 11 }}
              />
              <div style={{ display: "flex", justifyContent: "center", marginBottom: 8 }}>
                <button onClick={() => doLookup(text)} disabled={loading || !text.trim()} style={{
                  ...BTN_GOLD_ACTIVE, opacity: (loading || !text.trim()) ? 0.5 : 1,
                  padding: "8px 24px",
                }}>{loading ? "Looking up..." : "Lookup"}</button>
              </div>

              {error && (
                <div style={{ fontSize: 11, color: T.red, marginBottom: 8, padding: "6px 10px", background: "rgba(168,50,50,0.1)", borderRadius: 4 }}>
                  {error}
                </div>
              )}

              {result && result.item && (
                <div style={{ background: T.input, border: `1px solid ${T.border}`, borderRadius: 6, padding: 12 }}>
                  {/* Item header */}
                  <div style={{ marginBottom: 8 }}>
                    <span style={{ fontSize: 13, fontWeight: 700, color: T.text }}>
                      {result.item.name || result.item.base_type}
                    </span>
                    {result.item.name && result.item.base_type && (
                      <span style={{ fontSize: 11, color: T.textSecond, marginLeft: 8 }}>
                        {result.item.base_type}
                      </span>
                    )}
                    <span style={{ fontSize: 10, color: T.textMuted, marginLeft: 8 }}>
                      ({result.item.rarity}{result.item.item_level ? `, ilvl ${result.item.item_level}` : ""})
                    </span>
                  </div>

                  {/* Score summary */}
                  {result.score && (
                    <div style={{ display: "flex", alignItems: "center", gap: 12, marginBottom: 10, padding: "6px 10px", background: "rgba(196,164,86,0.06)", borderRadius: 4 }}>
                      <span style={{ fontSize: 16, fontWeight: 800, color: gradeColor(result.score.grade), ...MONO }}>{result.score.grade}</span>
                      <span style={{ fontSize: 11, color: T.textSecond }}>Score: <span style={{ color: T.text, fontWeight: 600 }}>{(result.score.normalized_score * 100).toFixed(0)}%</span></span>
                      {result.estimate && result.estimate.divine_value != null && (
                        <span style={{ fontSize: 11, color: T.textSecond }}>Est: <span style={{ color: T.gold, fontWeight: 600 }}>~{result.estimate.divine_value >= 1 ? result.estimate.divine_value.toFixed(1) + "d" : (result.estimate.chaos_value || 0).toFixed(0) + "c"}</span></span>
                      )}
                    </div>
                  )}

                  {/* Mods list */}
                  {result.mods && result.mods.length > 0 && (
                    <div>
                      <div style={{ ...LABEL, marginBottom: 4, fontSize: 9 }}>Mods</div>
                      {result.mods.map((mod, i) => (
                        <div key={i} style={{ fontSize: 11, color: T.textSecond, padding: "2px 0", display: "flex", alignItems: "baseline", gap: 6 }}>
                          <span style={{
                            fontSize: 9, fontWeight: 700, color: mod.tier_label?.startsWith("T1") ? T.gold : mod.tier_label?.startsWith("T2") ? T.amber : T.textMuted,
                            minWidth: 22, ...MONO,
                          }}>{mod.tier_label || "--"}</span>
                          <span>{mod.text}</span>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              )}
            </div>
          )}
        </div>
      );
    }

    function SettingsField({ label, field, value, onUpdate, type = "number", step, min, max, helpText }) {
      return (
        <div>
          <label style={FIELD_LABEL}>{label}</label>
          <input
            type={type}
            value={value ?? ""}
            onChange={(e) => {
              const val = type === "number" ? parseFloat(e.target.value) : e.target.value;
              onUpdate({ [field]: val });
            }}
            step={step}
            min={min}
            max={max}
            style={FIELD_INPUT}
          />
          {helpText && <div style={{ fontSize: 10, color: T.textMuted, marginTop: 3 }}>{helpText}</div>}
        </div>
      );
    }

    function OverlaySettingsTab({ settings, onUpdate, overlayState, telemetryStatus, onTelemetryUpload }) {
      const isRunning = overlayState === "running";
      const telEnabled = settings.telemetry_enabled === true;
      const telPending = telemetryStatus?.pending_samples || 0;
      const telLast = telemetryStatus?.last_upload;
      const telLastStr = telLast ? (() => {
        const ago = Math.floor((Date.now() / 1000 - telLast) / 60);
        if (ago < 60) return `${ago}m ago`;
        if (ago < 1440) return `${Math.floor(ago / 60)}h ago`;
        return `${Math.floor(ago / 1440)}d ago`;
      })() : "never";
      return (
        <div style={{ marginTop: 12, marginBottom: 12 }}>
          {/* Toggles row */}
          <div style={{ display: "flex", alignItems: "center", gap: 20, marginBottom: 4, flexWrap: "wrap" }}>
            <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
              <Toggle value={settings.auto_start !== false} onChange={(v) => onUpdate({ auto_start: v })} size="small" />
              <span style={{ fontSize: 11, color: T.textSecond }}>Auto-start overlay on launch</span>
            </div>
            <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
              <Toggle value={settings.start_with_windows === true} onChange={(v) => onUpdate({ start_with_windows: v })} size="small" />
              <span style={{ fontSize: 11, color: T.textSecond }}>Launch LAMA on Windows startup</span>
            </div>
            <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
              <Toggle value={telEnabled} onChange={(v) => onUpdate({ telemetry_enabled: v })} size="small" />
              <span style={{ fontSize: 11, color: T.textSecond }}>Share anonymous data to improve accuracy</span>
            </div>
            {isRunning && (
              <span style={{ fontSize: 10, color: T.amber, fontWeight: 500, marginLeft: "auto" }}>
                Restart to apply setting changes
              </span>
            )}
          </div>
          {/* Telemetry status line */}
          {telEnabled && (
            <div style={{ fontSize: 10, color: T.textSecond, marginBottom: 12, marginLeft: 2 }}>
              Last upload: {telLastStr} &middot; {telPending} pending &middot;{" "}
              <span
                style={{ color: T.borderGold, cursor: "pointer", textDecoration: "underline" }}
                onClick={onTelemetryUpload}
              >Upload Now</span>
            </div>
          )}
          {!telEnabled && <div style={{ height: 8 }} />}
          {/* Display & Detection settings — two grouped columns */}
          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 12 }}>
            <div className="panel" style={{ ...CARD, padding: 12 }}>
              <div style={{ ...LABEL, marginBottom: 8 }}>Display</div>
              <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "10px 16px" }}>
                <SettingsField label="Font Size" field="font_size" value={settings.font_size} onUpdate={onUpdate} min={8} max={24} step={1} helpText="Text size (px)" />
                <SettingsField label="Duration" field="overlay_duration" value={settings.overlay_duration} onUpdate={onUpdate} min={0.5} max={10} step={0.5} helpText="Seconds shown" />
              </div>
              {/* Theme selector */}
              <div style={{ marginTop: 12, paddingTop: 10, borderTop: `1px solid ${T.border}33` }}>
                <div style={{ ...LABEL, marginBottom: 8, fontSize: 9 }}>Theme</div>
                <div style={{ display: "flex", gap: 6 }}>
                  {[
                    { id: "poe2", label: "POE2 Gothic", desc: "Dark parchment, serif" },
                    { id: "classic", label: "Classic", desc: "Original style" },
                  ].map(t => {
                    const active = (settings.overlay_theme || "poe2") === t.id;
                    return (
                      <button key={t.id}
                        onClick={() => onUpdate({ overlay_theme: t.id })}
                        style={{
                          ...BTN, flex: 1,
                          background: active ? (t.id === "poe2" ? "#2a1f14" : T.gold) : T.input,
                          color: active ? (t.id === "poe2" ? "#c4a456" : "#0d0b08") : T.textSecond,
                          border: `1px solid ${active ? (t.id === "poe2" ? "#8b7536" : T.gold) : T.border}`,
                          padding: "6px 8px",
                        }}
                      >
                        <div style={{ fontWeight: 600, fontSize: 11,
                          fontFamily: t.id === "poe2" ? "'Palatino Linotype', Georgia, serif" : undefined,
                        }}>{t.label}</div>
                        <div style={{ fontSize: 8, opacity: 0.7, marginTop: 1 }}>{t.desc}</div>
                      </button>
                    );
                  })}
                </div>
              </div>
              {/* Pulse Style selector */}
              <div style={{ marginTop: 12, paddingTop: 10, borderTop: `1px solid ${T.border}33` }}>
                <div style={{ ...LABEL, marginBottom: 8, fontSize: 9 }}>Pulse Style</div>
                <div style={{ display: "flex", gap: 4 }}>
                  {[
                    { id: "sheen", label: "Sheen", desc: "Light sweep", poe2Only: true },
                    { id: "border", label: "Border", desc: "Color cycle" },
                    { id: "both", label: "Both", desc: "Sheen + border", poe2Only: true },
                    { id: "none", label: "None", desc: "No animation" },
                  ].map(p => {
                    const curStyle = settings.overlay_pulse_style || "sheen";
                    const active = curStyle === p.id;
                    const isClassic = (settings.overlay_theme || "poe2") === "classic";
                    const disabled = isClassic && p.poe2Only;
                    return (
                      <button key={p.id}
                        disabled={disabled}
                        onClick={() => !disabled && onUpdate({ overlay_pulse_style: p.id })}
                        title={disabled ? "Sheen requires POE2 Gothic theme" : ""}
                        style={{
                          ...BTN, flex: 1,
                          background: active ? T.gold : T.input,
                          color: active ? "#0d0b08" : T.textSecond,
                          border: `1px solid ${active ? T.gold : T.border}`,
                          padding: "4px 4px",
                          opacity: disabled ? 0.4 : 1,
                          cursor: disabled ? "not-allowed" : "pointer",
                        }}
                      >
                        <div style={{ fontWeight: 600, fontSize: 10 }}>{p.label}</div>
                        <div style={{ fontSize: 7, opacity: 0.7, marginTop: 1 }}>{p.desc}</div>
                      </button>
                    );
                  })}
                </div>
                {(settings.overlay_theme || "poe2") === "classic" && (
                  <div style={{ fontSize: 8, color: T.textSecond, marginTop: 4, opacity: 0.7 }}>
                    Sheen effect requires POE2 Gothic theme
                  </div>
                )}
              </div>
              {/* Display Preset selector */}
              <div style={{ marginTop: 12, paddingTop: 10, borderTop: `1px solid ${T.border}33` }}>
                <div style={{ ...LABEL, marginBottom: 8, fontSize: 9 }}>Display Preset</div>
                <div style={{ display: "flex", gap: 6 }}>
                  {OVERLAY_PRESETS.map(p => {
                    const activePreset = detectOverlayPreset(settings);
                    const active = activePreset === p.id;
                    return (
                      <button
                        key={p.id}
                        onClick={() => onUpdate({ ...p.toggles, overlay_display_preset: p.id })}
                        style={{
                          ...BTN,
                          flex: 1,
                          background: active ? T.gold : T.input,
                          color: active ? "#0d0b08" : T.textSecond,
                          border: `1px solid ${active ? T.gold : T.border}`,
                          padding: "6px 8px",
                        }}
                      >
                        <div style={{ fontWeight: 600, fontSize: 11 }}>{p.label}</div>
                        <div style={{ fontSize: 8, opacity: 0.7, marginTop: 1 }}>{p.desc}</div>
                      </button>
                    );
                  })}
                </div>
                {detectOverlayPreset(settings) === "custom" && (
                  <div style={{ fontSize: 9, color: T.amber, marginTop: 4 }}>Custom (toggles don't match any preset)</div>
                )}
              </div>
              {/* Individual toggle overrides */}
              <div style={{ marginTop: 10 }}>
                <div style={{ ...LABEL, marginBottom: 6, fontSize: 9 }}>Toggle Overrides</div>
                <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: "8px 12px" }}>
                  {[
                    ["Grade", "overlay_show_grade"],
                    ["Price", "overlay_show_price"],
                    ["Stars", "overlay_show_stars"],
                    ["Top Mods", "overlay_show_mods"],
                    ["DPS/Defense", "overlay_show_dps"],
                  ].map(([label, field]) => (
                    <div key={field} style={{ display: "flex", alignItems: "center", gap: 6 }}>
                      <Toggle value={settings[field] !== false} onChange={(v) => onUpdate({ [field]: v, overlay_display_preset: "custom" })} size="small" />
                      <span style={{ fontSize: 11, color: T.textSecond }}>{label}</span>
                    </div>
                  ))}
                </div>
              </div>
            </div>
            <div className="panel" style={{ ...CARD, padding: 8 }}>
              <div style={{ ...LABEL, marginBottom: 6 }}>Preview</div>
              <InventoryPreview settings={settings} />
            </div>
          </div>
          {/* Overlay Preview */}
          <OverlayPreview settings={settings} onUpdate={onUpdate} />
        </div>
      );
    }

    // -----------------------------------------------------------------------
    // StrictnessSelector
    // -----------------------------------------------------------------------
    function StrictnessSelector({ value, onChange, colorPreset, tierStyles }) {
      const presets = [
        { id: "relaxed", label: "Relaxed", desc: "Show more items" },
        { id: "normal", label: "Normal", desc: "Default" },
        { id: "strict", label: "Strict", desc: "Higher value only" },
        { id: "very_strict", label: "Very Strict", desc: "Top items only" },
      ];

      return (
        <div style={{ marginBottom: 20 }}>
          <div style={{ ...LABEL, marginBottom: 10 }}>Strictness</div>
          <div style={{ display: "flex", gap: 8 }}>
            {presets.map(p => {
              const active = value === p.id;
              return (
                <button
                  key={p.id}
                  onClick={() => onChange(p.id)}
                  style={{
                    ...BTN,
                    flex: 1,
                    background: active ? T.gold : T.input,
                    color: active ? "#0d0b08" : T.textSecond,
                    border: `1px solid ${active ? T.gold : T.border}`,
                    padding: "8px 12px",
                  }}
                >
                  <div style={{ fontWeight: 600, fontSize: 12 }}>{p.label}</div>
                  <div style={{ fontSize: 9, opacity: 0.7, marginTop: 2 }}>{p.desc}</div>
                </button>
              );
            })}
          </div>

          {/* Dynamic sample items — items shift tiers as strictness changes */}
          <div style={{
            marginTop: 12, padding: "10px 14px",
            background: T.input, border: `1px solid ${T.border}`, borderRadius: 6,
          }}>
            <div style={{ fontSize: 9, color: T.textMuted, letterSpacing: "0.08em", textTransform: "uppercase", marginBottom: 8 }}>
              How items are classified at {presets.find(p => p.id === value)?.label || "Normal"}
            </div>
            <div style={{ display: "flex", gap: 12, flexWrap: "wrap" }}>
              {STRICTNESS_SAMPLES.map(item => {
                const tier = getTierForValue(item.chaos, value);
                const s = getEffectiveTierStyle(tier, tierStyles || {}, colorPreset || "default");
                const scaledFont = Math.max(9, Math.round(s.font_size * 0.32));
                return (
                  <div key={item.name} style={{ display: "flex", flexDirection: "column", alignItems: "center", gap: 2 }}>
                    <div style={{
                      display: "inline-flex", alignItems: "center",
                      padding: "1px 8px",
                      backgroundColor: s.bg_color || "#000",
                      border: `2px solid ${s.border_color || "#000"}`,
                      borderRadius: 2,
                      color: s.text_color || "#fff",
                      fontSize: scaledFont,
                      fontWeight: 600,
                      fontFamily: "'JetBrains Mono', monospace",
                      whiteSpace: "nowrap", lineHeight: 1.4,
                      transition: "all 0.2s ease",
                    }}>{item.name}</div>
                    <div style={{ display: "flex", gap: 4, alignItems: "center" }}>
                      <span style={{ fontSize: 9, color: T.gold, fontWeight: 600 }}>{TIER_LABELS[tier]}</span>
                      <span style={{ fontSize: 9, color: T.textMuted, ...MONO, display: "inline-flex", alignItems: "center", gap: 1 }}>~{item.chaos}<CurrencyIcon src={ICON.chaos} size={9} /></span>
                    </div>
                  </div>
                );
              })}
            </div>

            {/* Threshold reference row */}
            <div style={{ display: "flex", gap: 8, flexWrap: "wrap", marginTop: 10, paddingTop: 8, borderTop: `1px solid ${T.border}33` }}>
              {["s", "a", "b", "c", "e"].map(tier => {
                const threshold = getEffectiveThreshold(tier, "currency", value);
                return (
                  <span key={tier} style={{ fontSize: 9, color: T.textMuted, ...MONO, display: "inline-flex", alignItems: "center", gap: 2 }}>
                    {TIER_LABELS[tier]}: {threshold === 0 ? "all" : (<><CurrencyIcon src={ICON.chaos} size={11} /> {formatChaos(threshold).replace(/^≥/, "")}</>)}
                  </span>
                );
              })}
            </div>
          </div>
        </div>
      );
    }

    // -----------------------------------------------------------------------
    // Toggle component (reusable)
    // -----------------------------------------------------------------------
    function Toggle({ value, onChange, size = "normal" }) {
      const w = size === "small" ? 28 : 36;
      const h = size === "small" ? 16 : 20;
      const dot = size === "small" ? 12 : 16;
      const goldDot = size === "small" ? 4 : 5;
      return (
        <div
          onClick={() => onChange(!value)}
          style={{
            width: w, height: h, borderRadius: h / 2, cursor: "pointer",
            background: value ? T.gold : T.border,
            position: "relative", transition: "background 0.2s",
            flexShrink: 0,
          }}
        >
          <div style={{
            width: dot, height: dot, borderRadius: "50%", background: T.text,
            position: "absolute", top: (h - dot) / 2,
            left: value ? w - dot - (h - dot) / 2 : (h - dot) / 2,
            transition: "left 0.2s",
            display: "flex", alignItems: "center", justifyContent: "center",
          }}>
            {value && <div style={{ width: goldDot, height: goldDot, borderRadius: "50%", background: T.gold }} />}
          </div>
        </div>
      );
    }

    // -----------------------------------------------------------------------
    // StylePreview — mimics a POE2 ground label with current style settings
    // -----------------------------------------------------------------------
    function StylePreview({ style: s, label }) {
      // Scale font: filter uses 18-45, preview scales to ~40% for compact display
      const scaledFont = Math.max(9, Math.round(s.font_size * 0.38));

      return (
        <div style={{ display: "flex", flexDirection: "column", alignItems: "flex-start", gap: 3 }}>
          <div style={{
            display: "inline-flex", alignItems: "center",
            padding: "1px 8px",
            backgroundColor: s.bg_color || "#000",
            border: `2px solid ${s.border_color || "#000"}`,
            borderRadius: 2,
            color: s.text_color || "#fff",
            fontSize: scaledFont,
            fontWeight: 600,
            fontFamily: "'JetBrains Mono', monospace",
            whiteSpace: "nowrap",
            lineHeight: 1.4,
            minWidth: 60,
          }}>
            {label}
          </div>
          <div style={{ display: "flex", gap: 4, alignItems: "center", height: 12 }}>
            {s.sound_enabled && (
              <Tooltip text={`Sound #${s.sound_id}`}>
                <span style={{ fontSize: 10, cursor: "default" }}>&#128264;</span>
              </Tooltip>
            )}
            {s.beam_enabled && (
              <Tooltip text={`${s.beam_color} beam`}>
                <span style={{
                  display: "inline-block", width: 3, height: 10, borderRadius: 1,
                  background: s.beam_color === "Red" ? "#ff4444" : s.beam_color === "Yellow" ? "#ffdd44" :
                    s.beam_color === "Blue" ? "#4488ff" : s.beam_color === "Orange" ? "#ff8844" :
                    s.beam_color === "Brown" ? "#aa7744" : "#888",
                  boxShadow: `0 0 4px ${s.beam_color === "Red" ? "#ff4444" : s.beam_color === "Yellow" ? "#ffdd44" :
                    s.beam_color === "Blue" ? "#4488ff" : s.beam_color === "Orange" ? "#ff8844" :
                    s.beam_color === "Brown" ? "#aa7744" : "#888"}`,
                }} />
              </Tooltip>
            )}
            {s.minimap_enabled && (
              <Tooltip text="Minimap icon">
                <span style={{ fontSize: 8, color: T.textSecond }}>&#9670;</span>
              </Tooltip>
            )}
          </div>
        </div>
      );
    }

    // -----------------------------------------------------------------------
    // TierRow — per-tier controls within a section accordion
    // -----------------------------------------------------------------------
    function TierRow({ tier, style: tierStyle, onChange, thresholdType, strictness, colorPreset }) {
      const s = getEffectiveTierStyle(tier, { [tier]: tierStyle }, colorPreset || "default");

      const updateField = (field, val) => {
        onChange({ ...tierStyle, [field]: val });
      };

      const threshold = thresholdType ? getEffectiveThreshold(tier, thresholdType, strictness || "normal") : null;
      const cellStyle = { display: "flex", alignItems: "center", gap: 6, minWidth: 0 };
      const miniLabel = { fontSize: 9, color: T.textMuted, letterSpacing: "0.05em", textTransform: "uppercase" };

      return (
        <div style={{
          display: "grid",
          gridTemplateColumns: "55px minmax(80px, auto) 60px 1fr 1fr 1fr 50px",
          gap: 10, alignItems: "center",
          padding: "8px 0",
          borderBottom: `1px solid ${T.border}22`,
        }}>
          {/* Tier label + threshold */}
          <div>
            <div style={{ fontWeight: 600, fontSize: 12, color: T.gold }}>{TIER_LABELS[tier] || tier}</div>
            {threshold !== null && (
              <div style={{ fontSize: 9, color: T.textMuted, ...MONO, display: "flex", alignItems: "center", gap: 2 }}>
                {threshold === 0 ? "all" : (<><CurrencyIcon src={ICON.chaos} size={10} /> {formatChaos(threshold).replace(/^≥/, "")}</>)}
              </div>
            )}
          </div>

          {/* Preview */}
          <StylePreview style={s} label={TIER_PREVIEW_NAMES[tier] || "Item"} />

          {/* Font size */}
          <div>
            <input
              type="number" min={18} max={45} value={s.font_size}
              onChange={e => updateField("font_size", parseInt(e.target.value) || 32)}
              style={{ ...FIELD_INPUT, width: 52, padding: "4px 6px", fontSize: 11, textAlign: "center" }}
            />
          </div>

          {/* Sound */}
          <div style={cellStyle}>
            <Toggle size="small" value={s.sound_enabled} onChange={v => updateField("sound_enabled", v)} />
            <select
              value={s.sound_id}
              onChange={e => updateField("sound_id", parseInt(e.target.value))}
              disabled={!s.sound_enabled}
              style={{ ...FIELD_INPUT, width: 52, padding: "3px 4px", fontSize: 10, opacity: s.sound_enabled ? 1 : 0.4 }}
            >
              {SOUND_IDS.map(id => <option key={id} value={id}>#{id}</option>)}
            </select>
            <span style={miniLabel}>Sound</span>
          </div>

          {/* Beam */}
          <div style={cellStyle}>
            <Toggle size="small" value={s.beam_enabled} onChange={v => updateField("beam_enabled", v)} />
            <select
              value={s.beam_color}
              onChange={e => updateField("beam_color", e.target.value)}
              disabled={!s.beam_enabled}
              style={{ ...FIELD_INPUT, width: 70, padding: "3px 4px", fontSize: 10, opacity: s.beam_enabled ? 1 : 0.4 }}
            >
              {BEAM_COLORS.map(c => <option key={c} value={c}>{c}</option>)}
            </select>
            <span style={miniLabel}>Beam</span>
          </div>

          {/* Colors */}
          <div style={{ display: "flex", gap: 4, alignItems: "center" }}>
            <Tooltip text="Text color">
              <input type="color" value={s.text_color} onChange={e => updateField("text_color", e.target.value)}
                style={{ width: 24, height: 24, border: `1px solid ${T.border}`, borderRadius: 3, cursor: "pointer", padding: 0, background: "transparent" }} />
            </Tooltip>
            <Tooltip text="Border color">
              <input type="color" value={s.border_color} onChange={e => updateField("border_color", e.target.value)}
                style={{ width: 24, height: 24, border: `1px solid ${T.border}`, borderRadius: 3, cursor: "pointer", padding: 0, background: "transparent" }} />
            </Tooltip>
            <Tooltip text="Background color">
              <input type="color" value={s.bg_color} onChange={e => updateField("bg_color", e.target.value)}
                style={{ width: 24, height: 24, border: `1px solid ${T.border}`, borderRadius: 3, cursor: "pointer", padding: 0, background: "transparent" }} />
            </Tooltip>
            <span style={miniLabel}>Colors</span>
          </div>

          {/* Minimap */}
          <div style={{ display: "flex", alignItems: "center", gap: 4 }}>
            <Toggle size="small" value={s.minimap_enabled} onChange={v => updateField("minimap_enabled", v)} />
            <span style={miniLabel}>Map</span>
          </div>
        </div>
      );
    }

    // -----------------------------------------------------------------------
    // SectionRow — accordion for one economy category
    // -----------------------------------------------------------------------
    function SectionRow({ section, visible, tierStyles, onVisibilityChange, onTierStyleChange, strictness, colorPreset, items }) {
      const [expanded, setExpanded] = useState(false);

      // Count total items across all tiers
      const totalItems = items ? Object.values(items).reduce((sum, arr) => sum + arr.length, 0) : 0;

      return (
        <div className={expanded ? "accordion-expanded" : ""} style={{ border: `1px solid ${T.border}`, borderRadius: 6, marginBottom: 8, overflow: "hidden", transition: "border-color 0.2s" }}>
          {/* Header row */}
          <div
            style={{
              display: "flex", alignItems: "center", gap: 10, padding: "10px 14px",
              background: expanded ? T.input : "transparent",
              cursor: "pointer", userSelect: "none",
            }}
            onClick={() => setExpanded(!expanded)}
          >
            <Toggle size="small" value={visible !== false}
              onChange={(v) => { onVisibilityChange(v); }}
            />
            <div style={{ flex: 1, fontWeight: 600, fontSize: 13, color: visible !== false ? T.text : T.textMuted }}>
              {section.label}
            </div>
            {totalItems > 0 && <div style={{ fontSize: 10, color: T.textMuted }}>{totalItems} items</div>}
            <div style={{ fontSize: 10, color: T.textMuted }}>{section.tiers.length} tiers</div>
            <div style={{
              fontSize: 11, color: T.textSecond,
              transform: expanded ? "rotate(180deg)" : "rotate(0deg)",
              transition: "transform 0.15s",
            }}>&#9660;</div>
          </div>

          {/* Expanded tier controls */}
          {expanded && (
            <div style={{ padding: "4px 14px 10px", borderTop: `1px solid ${T.border}` }}>
              {/* Column headers */}
              <div style={{
                display: "grid",
                gridTemplateColumns: "55px minmax(80px, auto) 60px 1fr 1fr 1fr 50px",
                gap: 10, padding: "4px 0 6px",
                fontSize: 9, color: T.textMuted, letterSpacing: "0.08em", textTransform: "uppercase",
              }}>
                <div>Tier</div>
                <div>Preview</div>
                <div>Font</div>
                <div>Sound</div>
                <div>Beam</div>
                <div>Colors</div>
                <div>Map</div>
              </div>

              {section.tiers.map(tier => {
                const tierItems = items ? (items[tier] || []) : [];
                return (
                  <React.Fragment key={tier}>
                    <TierRow
                      tier={tier}
                      style={tierStyles[tier] || {}}
                      onChange={(newStyle) => onTierStyleChange(tier, newStyle)}
                      thresholdType={section.thresholdType}
                      strictness={strictness}
                      colorPreset={colorPreset}
                    />
                    {tierItems.length > 0 && (
                      <div style={{ padding: "2px 0 8px 55px", display: "flex", flexWrap: "wrap", gap: 4 }}>
                        {tierItems.map(item => (
                          <span key={item.name} style={{
                            fontSize: 10, color: T.textSecond, background: T.input,
                            padding: "2px 6px", borderRadius: 3, border: `1px solid ${T.border}44`,
                            whiteSpace: "nowrap",
                          }}>
                            {item.name} <span style={{ color: T.textMuted, fontSize: 9 }}>{item.chaos >= 1 ? `${item.chaos.toFixed(0)}c` : "<1c"}</span>
                          </span>
                        ))}
                      </div>
                    )}
                  </React.Fragment>
                );
              })}
            </div>
          )}
        </div>
      );
    }

    // -----------------------------------------------------------------------
    // GearRow — accordion with style controls + per-class toggles
    // -----------------------------------------------------------------------
    function GearRow({ section, visible, style: gearStyle, classVisibility, onVisibilityChange, onStyleChange, onClassToggle }) {
      const [expanded, setExpanded] = useState(false);
      const s = { ...(DEFAULT_GEAR_STYLES[section.id] || DEFAULT_GEAR_STYLES.gear_rare), ...gearStyle };

      const updateField = (field, val) => {
        onStyleChange({ ...gearStyle, [field]: val });
      };

      const cellStyle = { display: "flex", alignItems: "center", gap: 6, minWidth: 0 };
      const miniLabel = { fontSize: 9, color: T.textMuted, letterSpacing: "0.05em", textTransform: "uppercase" };

      const hiddenCount = GEAR_CLASSES.reduce((sum, cat) =>
        sum + cat.classes.filter(c => classVisibility[c] === false).length, 0);

      return (
        <div className={expanded ? "accordion-expanded" : ""} style={{ border: `1px solid ${T.border}`, borderRadius: 6, marginBottom: 8, overflow: "hidden", transition: "border-color 0.2s" }}>
          {/* Header row */}
          <div
            style={{
              display: "flex", alignItems: "center", gap: 10, padding: "10px 14px",
              background: expanded ? T.input : "transparent",
              cursor: "pointer", userSelect: "none",
            }}
            onClick={() => setExpanded(!expanded)}
          >
            <div onClick={e => e.stopPropagation()}>
              <Toggle size="small" value={visible !== false}
                onChange={(v) => onVisibilityChange(v)} />
            </div>
            <div style={{ fontWeight: 600, fontSize: 13, color: visible !== false ? T.text : T.textMuted, minWidth: 160 }}>
              {section.label}
            </div>
            {hiddenCount > 0 && (
              <div style={{ fontSize: 10, color: T.amber, fontWeight: 500 }}>
                {hiddenCount} class{hiddenCount > 1 ? "es" : ""} hidden
              </div>
            )}
            <div style={{ flex: 1 }} />
            <div style={{
              fontSize: 11, color: T.textSecond,
              transform: expanded ? "rotate(180deg)" : "rotate(0deg)",
              transition: "transform 0.15s",
            }}>&#9660;</div>
          </div>

          {/* Expanded content */}
          {expanded && (
            <div style={{ borderTop: `1px solid ${T.border}`, padding: "12px 14px" }}>
              {/* Style controls row */}
              <div style={{
                display: "grid",
                gridTemplateColumns: "minmax(80px, auto) 60px 1fr 1fr 1fr 50px",
                gap: 10, alignItems: "center",
                padding: "0 0 12px",
                borderBottom: `1px solid ${T.border}22`,
                marginBottom: 12,
              }}>
                <div>
                  <div style={miniLabel}>Preview</div>
                  <StylePreview style={s} label={TIER_PREVIEW_NAMES[section.id] || "Item"} />
                </div>
                <div>
                  <div style={miniLabel}>Font</div>
                  <input
                    type="number" min={18} max={45} value={s.font_size}
                    onChange={e => updateField("font_size", parseInt(e.target.value) || 28)}
                    style={{ ...FIELD_INPUT, width: 52, padding: "4px 6px", fontSize: 11, textAlign: "center" }}
                  />
                </div>

                <div style={cellStyle}>
                  <Toggle size="small" value={s.sound_enabled} onChange={v => updateField("sound_enabled", v)} />
                  <select
                    value={s.sound_id}
                    onChange={e => updateField("sound_id", parseInt(e.target.value))}
                    disabled={!s.sound_enabled}
                    style={{ ...FIELD_INPUT, width: 52, padding: "3px 4px", fontSize: 10, opacity: s.sound_enabled ? 1 : 0.4 }}
                  >
                    {SOUND_IDS.map(id => <option key={id} value={id}>#{id}</option>)}
                  </select>
                  <span style={miniLabel}>Sound</span>
                </div>

                <div style={cellStyle}>
                  <Toggle size="small" value={s.beam_enabled} onChange={v => updateField("beam_enabled", v)} />
                  <select
                    value={s.beam_color}
                    onChange={e => updateField("beam_color", e.target.value)}
                    disabled={!s.beam_enabled}
                    style={{ ...FIELD_INPUT, width: 70, padding: "3px 4px", fontSize: 10, opacity: s.beam_enabled ? 1 : 0.4 }}
                  >
                    {BEAM_COLORS.map(c => <option key={c} value={c}>{c}</option>)}
                  </select>
                  <span style={miniLabel}>Beam</span>
                </div>

                <div style={{ display: "flex", gap: 4, alignItems: "center" }}>
                  <Tooltip text="Text color">
                    <input type="color" value={s.text_color} onChange={e => updateField("text_color", e.target.value)}
                      style={{ width: 24, height: 24, border: `1px solid ${T.border}`, borderRadius: 3, cursor: "pointer", padding: 0, background: "transparent" }} />
                  </Tooltip>
                  <Tooltip text="Border color">
                    <input type="color" value={s.border_color} onChange={e => updateField("border_color", e.target.value)}
                      style={{ width: 24, height: 24, border: `1px solid ${T.border}`, borderRadius: 3, cursor: "pointer", padding: 0, background: "transparent" }} />
                  </Tooltip>
                  <Tooltip text="Background color">
                    <input type="color" value={s.bg_color} onChange={e => updateField("bg_color", e.target.value)}
                      style={{ width: 24, height: 24, border: `1px solid ${T.border}`, borderRadius: 3, cursor: "pointer", padding: 0, background: "transparent" }} />
                  </Tooltip>
                </div>

                <div style={{ display: "flex", alignItems: "center", gap: 4 }}>
                  <Toggle size="small" value={s.minimap_enabled} onChange={v => updateField("minimap_enabled", v)} />
                  <span style={miniLabel}>Map</span>
                </div>
              </div>

              {/* Per-class toggles */}
              {GEAR_CLASSES.map(cat => (
                <div key={cat.category} style={{ marginBottom: 10 }}>
                  <div style={{ fontSize: 10, fontWeight: 600, color: T.textSecond, letterSpacing: "0.06em", marginBottom: 6 }}>{cat.category}</div>
                  <div style={{ display: "flex", flexWrap: "wrap", gap: "4px 12px" }}>
                    {cat.classes.map(cls => {
                      const isVisible = classVisibility[cls] !== false;
                      return (
                        <label key={cls} style={{
                          display: "flex", alignItems: "center", gap: 5, cursor: "pointer",
                          fontSize: 11, color: isVisible ? T.text : T.textMuted,
                          padding: "3px 0", minWidth: 140,
                        }}>
                          <input
                            type="checkbox"
                            checked={isVisible}
                            onChange={e => onClassToggle(cls, e.target.checked)}
                            style={{ accentColor: T.gold, cursor: "pointer" }}
                          />
                          {cls}
                        </label>
                      );
                    })}
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      );
    }

    // -----------------------------------------------------------------------
    // FilterTab
    // -----------------------------------------------------------------------
    function FilterTab({ settings, onUpdate, onUpdateFilter, filterUpdating }) {
      const strictness = settings.filter_strictness || "normal";
      const tierStyles = settings.filter_tier_styles || {};
      const sectionVisibility = settings.filter_section_visibility || {};
      const gearClasses = settings.filter_gear_classes || {};
      const colorPreset = settings.filter_color_preset || "default";

      // Fetch item-tier assignments from price cache
      const [filterItems, setFilterItems] = useState({});
      useEffect(() => {
        api("/api/filter-items").then(data => {
          if (data && data.items) setFilterItems(data.items);
        }).catch(() => {});
      }, []);

      const handleStrictnessChange = (val) => {
        onUpdate({ filter_strictness: val });
      };

      const handleSectionVisibility = (sectionId, visible) => {
        onUpdate({ filter_section_visibility: { ...sectionVisibility, [sectionId]: visible } });
      };

      const handleTierStyleChange = (tier, style) => {
        onUpdate({ filter_tier_styles: { ...tierStyles, [tier]: style } });
      };

      const handleGearClassToggle = (gearId, className, visible) => {
        const current = gearClasses[gearId] || {};
        onUpdate({ filter_gear_classes: { ...gearClasses, [gearId]: { ...current, [className]: visible } } });
      };

      const handleColorPreset = (presetId) => {
        const preset = COLOR_PRESETS[presetId];
        if (!preset) return;
        const newStyles = { ...tierStyles };
        if (presetId === "default") {
          // Clear color overrides, keep sound/beam/minimap/font settings
          for (const tier of Object.keys(newStyles)) {
            if (!newStyles[tier]) continue;
            const { text_color, border_color, bg_color, ...rest } = newStyles[tier];
            newStyles[tier] = Object.keys(rest).length > 0 ? rest : undefined;
          }
          // Remove undefined entries
          for (const k of Object.keys(newStyles)) { if (!newStyles[k]) delete newStyles[k]; }
        } else {
          // Apply preset colors on top of existing settings
          for (const [tier, colors] of Object.entries(preset.tiers)) {
            newStyles[tier] = { ...(tierStyles[tier] || {}), ...colors };
          }
        }
        onUpdate({ filter_tier_styles: newStyles, filter_color_preset: presetId });
      };

      return (
        <div>
          <div style={{ fontSize: 10, color: T.textMuted, fontStyle: "italic", padding: "8px 0 4px", borderBottom: `1px solid ${T.border}22`, marginBottom: 12 }}>
            Filter tiers are based on poe.ninja market data and may not reflect real-time prices. Strictness thresholds are chaos-based estimates.
          </div>
          {/* Strictness + Color Preset */}
          <div className="panel" style={{ ...CARD, marginBottom: 20 }}>
            <StrictnessSelector value={strictness} onChange={handleStrictnessChange} colorPreset={colorPreset} tierStyles={tierStyles} />

            {/* Color preset selector */}
            <div style={{ marginBottom: 16 }}>
              <div style={{ ...LABEL, marginBottom: 10 }}>Color Preset</div>
              <div style={{ display: "flex", gap: 8 }}>
                {Object.entries(COLOR_PRESETS).map(([id, preset]) => {
                  const active = colorPreset === id;
                  return (
                    <button
                      key={id}
                      onClick={() => handleColorPreset(id)}
                      style={{
                        ...BTN,
                        background: active ? T.gold : T.input,
                        color: active ? "#0d0b08" : T.textSecond,
                        border: `1px solid ${active ? T.gold : T.border}`,
                        padding: "6px 14px",
                      }}
                    >
                      <div style={{ fontWeight: 600, fontSize: 11 }}>{preset.label}</div>
                      <div style={{ fontSize: 9, opacity: 0.7, marginTop: 1 }}>{preset.desc}</div>
                    </button>
                  );
                })}
              </div>
              {/* Mini preview of preset colors */}
              <div style={{ display: "flex", gap: 6, marginTop: 8 }}>
                {["s", "a", "b", "c", "d", "e"].map(tier => {
                  const s = getEffectiveTierStyle(tier, tierStyles, colorPreset);
                  return (
                    <div key={tier} style={{
                      padding: "1px 6px", borderRadius: 2,
                      backgroundColor: s.bg_color, border: `2px solid ${s.border_color}`,
                      color: s.text_color, fontSize: 9, fontWeight: 600,
                      fontFamily: "'JetBrains Mono', monospace", lineHeight: 1.5,
                    }}>{TIER_LABELS[tier]}</div>
                  );
                })}
              </div>
            </div>

            {/* Auto-update toggle */}
            <div style={{ display: "flex", alignItems: "center", gap: 10 }}>
              <Toggle value={settings.no_filter_update || false}
                onChange={(v) => onUpdate({ no_filter_update: v })} />
              <div>
                <span style={{ fontSize: 12, fontWeight: 500, color: T.text }}>Disable auto-updates</span>
                <div style={{ fontSize: 10, color: T.textMuted }}>Don't auto-update loot filter on overlay startup</div>
              </div>
            </div>
          </div>

          {/* Gear & Uniques */}
          <div className="panel" style={{ ...CARD, marginBottom: 20 }}>
            <div style={{ ...LABEL, marginBottom: 12 }}>Gear & Uniques</div>

            {/* Uniques — tier accordion like economy sections */}
            <SectionRow
              section={UNIQUE_SECTION}
              visible={sectionVisibility[UNIQUE_SECTION.id]}
              tierStyles={tierStyles}
              onVisibilityChange={(v) => handleSectionVisibility(UNIQUE_SECTION.id, v)}
              onTierStyleChange={handleTierStyleChange}
              strictness={strictness}
              colorPreset={colorPreset}
              items={filterItems[UNIQUE_SECTION.id] || {}}
            />

            {/* Gear categories — accordion with class toggles */}
            {GEAR_SECTIONS.map(section => (
              <GearRow
                key={section.id}
                section={section}
                visible={sectionVisibility[section.id]}
                style={tierStyles[section.id] || {}}
                classVisibility={gearClasses[section.id] || {}}
                onVisibilityChange={(v) => handleSectionVisibility(section.id, v)}
                onStyleChange={(style) => handleTierStyleChange(section.id, style)}
                onClassToggle={(cls, vis) => handleGearClassToggle(section.id, cls, vis)}
              />
            ))}
          </div>

          {/* Economy section accordions */}
          <div className="panel" style={{ ...CARD, marginBottom: 20 }}>
            <div style={{ ...LABEL, marginBottom: 12 }}>Economy Sections</div>
            {ECONOMY_SECTIONS.map(section => (
              <SectionRow
                key={section.id}
                section={section}
                visible={sectionVisibility[section.id]}
                tierStyles={tierStyles}
                onVisibilityChange={(v) => handleSectionVisibility(section.id, v)}
                onTierStyleChange={handleTierStyleChange}
                strictness={strictness}
                colorPreset={colorPreset}
                items={filterItems[section.id] || {}}
              />
            ))}
          </div>

          {/* Update button */}
          <div className="panel" style={{ ...CARD }}>
            <div style={{ display: "flex", alignItems: "center", gap: 12 }}>
              <Tooltip text="Update loot filter tiers from current prices + your customizations">
                <button
                  onClick={onUpdateFilter}
                  disabled={filterUpdating}
                  className="btn-gold-hover"
                  style={{
                    ...BTN_GOLD_ACTIVE,
                    opacity: filterUpdating ? 0.5 : 1,
                    cursor: filterUpdating ? "default" : "pointer",
                    padding: "10px 28px",
                  }}
                >{filterUpdating ? "Updating..." : "Update Filter Now"}</button>
              </Tooltip>
              <div style={{ fontSize: 11, color: T.textMuted }}>
                Applies strictness, section visibility, and tier styling to your .filter file
              </div>
            </div>
          </div>
        </div>
      );
    }

    // -----------------------------------------------------------------------
    // Watchlist — BaseTypeDropdown
    // -----------------------------------------------------------------------
    function BaseTypeDropdown({ categories, value, onChange }) {
      const [search, setSearch] = useState("");
      const [open, setOpen] = useState(false);
      const ref = useRef(null);

      useEffect(() => {
        const handler = (e) => { if (ref.current && !ref.current.contains(e.target)) setOpen(false); };
        document.addEventListener("mousedown", handler);
        return () => document.removeEventListener("mousedown", handler);
      }, []);

      const matches = [];
      if (search.length >= 1) {
        const lower = search.toLowerCase();
        for (const cat of categories) {
          for (const entry of cat.entries) {
            const label = entry.name ? `${entry.name} ${entry.type}` : entry.type;
            if (label.toLowerCase().includes(lower)) {
              matches.push({ label, type: entry.type, name: entry.name, category: cat.label });
              if (matches.length >= 30) break;
            }
          }
          if (matches.length >= 30) break;
        }
      }

      return (
        <div ref={ref} style={{ position: "relative" }}>
          <input
            value={search || value || ""}
            onChange={(e) => { setSearch(e.target.value); setOpen(true); if (!e.target.value) onChange("", ""); }}
            onFocus={() => { if (search.length >= 1) setOpen(true); }}
            placeholder="Search base types..."
            style={FIELD_INPUT}
          />
          {open && matches.length > 0 && (
            <div style={{
              position: "absolute", top: "100%", left: 0, right: 0, zIndex: 200,
              background: T.card, border: `1px solid ${T.borderGold}`, borderRadius: 6,
              maxHeight: 250, overflowY: "auto", marginTop: 2,
              boxShadow: "0 8px 24px rgba(0,0,0,0.7)",
            }}>
              {matches.map((m, i) => (
                <div key={i}
                  onClick={() => { onChange(m.type, m.name || ""); setSearch(m.label); setOpen(false); }}
                  style={{
                    padding: "6px 12px", cursor: "pointer", fontSize: 12,
                    borderBottom: `1px solid ${T.border}22`,
                    color: T.text,
                  }}
                  onMouseEnter={(e) => e.target.style.background = T.input}
                  onMouseLeave={(e) => e.target.style.background = "transparent"}
                >
                  <span>{m.label}</span>
                  <span style={{ float: "right", fontSize: 10, color: T.textMuted }}>{m.category}</span>
                </div>
              ))}
            </div>
          )}
        </div>
      );
    }

    // -----------------------------------------------------------------------
    // Watchlist — StatFilterAutocomplete
    // -----------------------------------------------------------------------
    function StatFilterAutocomplete({ stats, filters, onChange }) {
      const [search, setSearch] = useState("");
      const [open, setOpen] = useState(false);
      const ref = useRef(null);

      useEffect(() => {
        const handler = (e) => { if (ref.current && !ref.current.contains(e.target)) setOpen(false); };
        document.addEventListener("mousedown", handler);
        return () => document.removeEventListener("mousedown", handler);
      }, []);

      const matches = [];
      if (search.length >= 2) {
        const lower = search.toLowerCase();
        const usedIds = new Set(filters.map(f => f.id));
        for (const stat of stats) {
          if (usedIds.has(stat.id)) continue;
          if (stat.text.toLowerCase().includes(lower)) {
            matches.push(stat);
            if (matches.length >= 20) break;
          }
        }
      }

      const addFilter = (stat) => {
        if (filters.length >= 5) return;
        onChange([...filters, { id: stat.id, text: stat.text, min: "", max: "" }]);
        setSearch("");
        setOpen(false);
      };

      const removeFilter = (idx) => {
        onChange(filters.filter((_, i) => i !== idx));
      };

      const updateFilter = (idx, field, value) => {
        const updated = [...filters];
        updated[idx] = { ...updated[idx], [field]: value };
        onChange(updated);
      };

      return (
        <div>
          {/* Existing filters */}
          {filters.map((f, i) => (
            <div key={f.id} style={{
              display: "flex", alignItems: "center", gap: 8, marginBottom: 6,
              background: T.input, border: `1px solid ${T.border}`, borderRadius: 5, padding: "5px 10px",
            }}>
              <span style={{ flex: 1, fontSize: 11, color: T.text, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>
                {f.text}
              </span>
              <input
                type="number" placeholder="min" value={f.min}
                onChange={(e) => updateFilter(i, "min", e.target.value)}
                style={{ ...FIELD_INPUT, width: 60, padding: "3px 6px", fontSize: 11, textAlign: "center" }}
              />
              <input
                type="number" placeholder="max" value={f.max}
                onChange={(e) => updateFilter(i, "max", e.target.value)}
                style={{ ...FIELD_INPUT, width: 60, padding: "3px 6px", fontSize: 11, textAlign: "center" }}
              />
              <button onClick={() => removeFilter(i)} style={{
                background: "transparent", border: "none", color: T.red, cursor: "pointer",
                fontSize: 14, fontWeight: 700, padding: "0 4px", lineHeight: 1,
              }}>×</button>
            </div>
          ))}

          {/* Search input */}
          {filters.length < 5 && (
            <div ref={ref} style={{ position: "relative" }}>
              <input
                value={search}
                onChange={(e) => { setSearch(e.target.value); setOpen(true); }}
                onFocus={() => { if (search.length >= 2) setOpen(true); }}
                placeholder="Search stat filters... (min 2 chars)"
                style={FIELD_INPUT}
              />
              {open && matches.length > 0 && (
                <div style={{
                  position: "absolute", top: "100%", left: 0, right: 0, zIndex: 200,
                  background: T.card, border: `1px solid ${T.borderGold}`, borderRadius: 6,
                  maxHeight: 200, overflowY: "auto", marginTop: 2,
                  boxShadow: "0 8px 24px rgba(0,0,0,0.7)",
                }}>
                  {matches.map((stat) => (
                    <div key={stat.id}
                      onClick={() => addFilter(stat)}
                      style={{
                        padding: "6px 12px", cursor: "pointer", fontSize: 11,
                        borderBottom: `1px solid ${T.border}22`, color: T.text,
                      }}
                      onMouseEnter={(e) => e.target.style.background = T.input}
                      onMouseLeave={(e) => e.target.style.background = "transparent"}
                    >
                      <span>{stat.text}</span>
                      <span style={{ float: "right", fontSize: 9, color: T.textMuted }}>{stat.type}</span>
                    </div>
                  ))}
                </div>
              )}
            </div>
          )}
        </div>
      );
    }

    // -----------------------------------------------------------------------
    // Watchlist — WatchlistQueryEditor
    // -----------------------------------------------------------------------
    function WatchlistQueryEditor({ query, tradeStats, tradeItems, onSave, onCancel }) {
      const [label, setLabel] = useState(query?.label || "");
      const [itemName, setItemName] = useState(query?.item_name || "");
      const [baseType, setBaseType] = useState(query?.base_type || "");
      const [rarity, setRarity] = useState(query?.rarity || "any");
      const [ilvlMin, setIlvlMin] = useState(query?.ilvl_min || "");
      const [qualityMin, setQualityMin] = useState(query?.quality_min || "");
      const [socketsMin, setSocketsMin] = useState(query?.sockets_min || "");
      const [onlineOnly, setOnlineOnly] = useState(query?.online_only !== false);
      const [statFilters, setStatFilters] = useState(query?.stat_filters || []);

      const buildQueryBody = () => {
        const q = { status: { option: onlineOnly ? "online" : "any" } };
        const filters = {};

        if (itemName) q.name = itemName;
        if (baseType) q.type = baseType;

        // Rarity filter
        if (rarity !== "any") {
          filters.type_filters = { filters: { rarity: { option: rarity === "unique" ? "unique" : rarity } } };
        }

        // Equipment filters
        const equipFilters = {};
        if (socketsMin) equipFilters.rune_sockets = { min: parseInt(socketsMin) };
        if (Object.keys(equipFilters).length > 0) {
          filters.equipment_filters = { filters: equipFilters };
        }

        // Misc filters
        const miscFilters = {};
        if (ilvlMin) miscFilters.ilvl = { min: parseInt(ilvlMin) };
        if (qualityMin) miscFilters.quality = { min: parseInt(qualityMin) };
        if (Object.keys(miscFilters).length > 0) {
          filters.misc_filters = { filters: miscFilters };
        }

        if (Object.keys(filters).length > 0) q.filters = filters;

        // Stat filters
        if (statFilters.length > 0) {
          const statGroup = { type: "and", filters: [] };
          for (const sf of statFilters) {
            const val = {};
            if (sf.min !== "" && sf.min !== undefined) val.min = parseFloat(sf.min);
            if (sf.max !== "" && sf.max !== undefined) val.max = parseFloat(sf.max);
            if (Object.keys(val).length > 0) {
              statGroup.filters.push({ id: sf.id, value: val });
            } else {
              statGroup.filters.push({ id: sf.id });
            }
          }
          q.stats = [statGroup];
        }

        return { query: q, sort: { price: "asc" } };
      };

      const handleSave = () => {
        const body = buildQueryBody();
        onSave({
          id: query?.id || crypto.randomUUID(),
          label: label || "Untitled Query",
          enabled: query?.enabled !== false,
          item_name: itemName,
          base_type: baseType,
          rarity,
          ilvl_min: ilvlMin,
          quality_min: qualityMin,
          sockets_min: socketsMin,
          online_only: onlineOnly,
          stat_filters: statFilters,
          body,
        });
      };

      return (
        <div style={{ padding: "12px 0" }}>
          {/* Row 1: Label */}
          <div style={{ marginBottom: 10 }}>
            <label style={FIELD_LABEL}>Label</label>
            <input value={label} onChange={(e) => setLabel(e.target.value)} placeholder="e.g. Headhunter, ilvl 82 bases..."
              style={FIELD_INPUT} autoFocus />
          </div>

          {/* Row 2: Item Name + Base Type */}
          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 12, marginBottom: 10 }}>
            <div>
              <label style={FIELD_LABEL}>Item Name (for uniques)</label>
              <input value={itemName} onChange={(e) => setItemName(e.target.value)} placeholder="e.g. Headhunter"
                style={FIELD_INPUT} />
            </div>
            <div>
              <label style={FIELD_LABEL}>Base Type</label>
              <BaseTypeDropdown categories={tradeItems} value={baseType}
                onChange={(type, name) => { setBaseType(type); if (name && !itemName) setItemName(name); }} />
            </div>
          </div>

          {/* Row 3: Rarity, ilvl, Quality, Sockets */}
          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr 1fr", gap: 12, marginBottom: 10 }}>
            <div>
              <label style={FIELD_LABEL}>Rarity</label>
              <select value={rarity} onChange={(e) => setRarity(e.target.value)} style={{ ...FIELD_INPUT, appearance: "auto" }}>
                <option value="any">Any</option>
                <option value="unique">Unique</option>
                <option value="rare">Rare</option>
                <option value="magic">Magic</option>
                <option value="normal">Normal</option>
              </select>
            </div>
            <div>
              <label style={FIELD_LABEL}>Min Item Level</label>
              <input type="number" value={ilvlMin} onChange={(e) => setIlvlMin(e.target.value)} placeholder="--"
                min={1} max={100} style={FIELD_INPUT} />
            </div>
            <div>
              <label style={FIELD_LABEL}>Min Quality</label>
              <input type="number" value={qualityMin} onChange={(e) => setQualityMin(e.target.value)} placeholder="--"
                min={0} max={30} style={FIELD_INPUT} />
            </div>
            <div>
              <label style={FIELD_LABEL}>Min Sockets</label>
              <input type="number" value={socketsMin} onChange={(e) => setSocketsMin(e.target.value)} placeholder="--"
                min={1} max={3} style={FIELD_INPUT} />
            </div>
          </div>

          {/* Row 4: Online toggle */}
          <div style={{ display: "flex", alignItems: "center", gap: 10, marginBottom: 14 }}>
            <Toggle value={onlineOnly} onChange={setOnlineOnly} size="small" />
            <span style={{ fontSize: 12, color: T.text }}>Online only</span>
          </div>

          {/* Row 5: Stat Filters */}
          <div style={{ marginBottom: 14 }}>
            <label style={FIELD_LABEL}>Stat Filters (up to 5)</label>
            <StatFilterAutocomplete stats={tradeStats} filters={statFilters} onChange={setStatFilters} />
          </div>

          {/* Row 6: Save / Cancel */}
          <div style={{ display: "flex", gap: 10, justifyContent: "flex-end" }}>
            <button onClick={onCancel} style={{ ...BTN, background: T.input, border: `1px solid ${T.border}`, color: T.textSecond }}>Cancel</button>
            <button onClick={handleSave} style={BTN_GOLD_ACTIVE}>Save Query</button>
          </div>
        </div>
      );
    }

    // -----------------------------------------------------------------------
    // Watchlist — WatchlistListingsTable
    // -----------------------------------------------------------------------
    function WatchlistListingsTable({ listings, tradeUrl }) {
      const [copiedIdx, setCopiedIdx] = useState(null);

      if (!listings || listings.length === 0) return null;

      const copyWhisper = (whisper, idx) => {
        navigator.clipboard.writeText(whisper).then(() => {
          setCopiedIdx(idx);
          setTimeout(() => setCopiedIdx(null), 1200);
        }).catch(() => {});
      };

      const formatTime = (indexed) => {
        if (!indexed) return "--";
        try {
          const d = new Date(indexed);
          const now = new Date();
          const diffMs = now - d;
          const diffH = Math.floor(diffMs / 3600000);
          if (diffH < 1) return `${Math.floor(diffMs / 60000)}m ago`;
          if (diffH < 24) return `${diffH}h ago`;
          return `${Math.floor(diffH / 24)}d ago`;
        } catch { return "--"; }
      };

      return (
        <div style={{ maxHeight: 220, overflowY: "auto" }}>
          <table style={{ width: "100%", borderCollapse: "collapse", fontSize: 11, ...MONO }}>
            <thead>
              <tr style={{ borderBottom: `1px solid ${T.border}`, color: T.textMuted, fontSize: 9, letterSpacing: "0.06em", textTransform: "uppercase" }}>
                <th style={{ textAlign: "left", padding: "4px 6px", fontWeight: 600 }}>Price</th>
                <th style={{ textAlign: "left", padding: "4px 6px", fontWeight: 600 }}>Item</th>
                <th style={{ textAlign: "left", padding: "4px 6px", fontWeight: 600 }}>Account</th>
                <th style={{ textAlign: "left", padding: "4px 6px", fontWeight: 600 }}>Listed</th>
                <th style={{ textAlign: "right", padding: "4px 6px", fontWeight: 600 }}>Actions</th>
              </tr>
            </thead>
            <tbody>
              {listings.map((l, i) => (
                <tr key={i} style={{ borderBottom: `1px solid ${T.border}22` }}>
                  <td style={{ padding: "4px 6px", color: T.gold, fontWeight: 600, whiteSpace: "nowrap" }}>
                    <span style={{ display: "inline-flex", alignItems: "center", gap: 3 }}>
                      {l.price && l.price.toLowerCase().includes("divine") && <CurrencyIcon src={ICON.divine} size={14} />}
                      {l.price && l.price.toLowerCase().includes("exalted") && <CurrencyIcon src={ICON.exalted} size={14} />}
                      {l.price && l.price.toLowerCase().includes("chaos") && <CurrencyIcon src={ICON.chaos} size={14} />}
                      {l.price ? l.price.replace(/\s*(divine|exalted|chaos)\s*/gi, " ").trim() : "--"}
                    </span>
                  </td>
                  <td style={{ padding: "4px 6px", color: T.text, maxWidth: 140, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>
                    {l.item_name || "--"}
                  </td>
                  <td style={{ padding: "4px 6px", color: T.textSecond, maxWidth: 100, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>{l.account}</td>
                  <td style={{ padding: "4px 6px", color: T.textMuted, whiteSpace: "nowrap" }}>{formatTime(l.indexed)}</td>
                  <td style={{ padding: "4px 6px", textAlign: "right", whiteSpace: "nowrap" }}>
                    <div style={{ display: "inline-flex", gap: 4 }}>
                      {tradeUrl && (
                        <Tooltip text="Open on trade site to visit hideout">
                          <a href={tradeUrl} target="_blank" rel="noopener noreferrer" style={{
                            ...BTN, padding: "2px 8px", fontSize: 10, textDecoration: "none",
                            background: T.input, color: T.gold,
                            border: `1px solid ${T.borderGold}`,
                            display: "inline-block",
                          }}>Buy</a>
                        </Tooltip>
                      )}
                      {l.whisper && (
                        <Tooltip text="Copy whisper message to clipboard">
                          <button onClick={() => copyWhisper(l.whisper, i)} style={{
                            ...BTN, padding: "2px 8px", fontSize: 10,
                            background: copiedIdx === i ? T.green : T.input,
                            color: copiedIdx === i ? "#fff" : T.textSecond,
                            border: `1px solid ${copiedIdx === i ? T.green : T.border}`,
                          }}>{copiedIdx === i ? "Copied" : "Whisper"}</button>
                        </Tooltip>
                      )}
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      );
    }

    // -----------------------------------------------------------------------
    // Watchlist — WatchlistQueryCard
    // -----------------------------------------------------------------------
    // -----------------------------------------------------------------------
    // Watchlist — QueryStatusBadge
    // -----------------------------------------------------------------------
    function QueryStatusBadge({ queryState }) {
      const st = queryState?.state || "idle";
      const [countdown, setCountdown] = useState("");

      useEffect(() => {
        if (st !== "cooldown" || !queryState?.next_poll) { setCountdown(""); return; }
        const tick = () => {
          const remaining = Math.max(0, Math.floor(queryState.next_poll - Date.now() / 1000));
          if (remaining <= 0) { setCountdown("Soon"); return; }
          const m = Math.floor(remaining / 60);
          const s = remaining % 60;
          setCountdown(`${m}:${s.toString().padStart(2, "0")}`);
        };
        tick();
        const iv = setInterval(tick, 1000);
        return () => clearInterval(iv);
      }, [st, queryState?.next_poll]);

      const configs = {
        querying: { label: "Querying...", color: T.amber, bg: "rgba(184,134,11,0.15)", animate: true },
        cooldown: { label: countdown ? `Next: ${countdown}` : "Cooldown", color: T.cyan, bg: "rgba(107,143,113,0.12)", animate: false },
        idle:     { label: "Idle", color: T.textMuted, bg: "rgba(92,79,61,0.1)", animate: false },
        error:    { label: "Error", color: T.red, bg: "rgba(168,50,50,0.12)", animate: false },
        disabled: { label: "Disabled", color: T.textMuted, bg: "rgba(92,79,61,0.08)", animate: false },
      };
      const c = configs[st] || configs.idle;

      return (
        <div style={{
          display: "inline-flex", alignItems: "center", gap: 5,
          background: c.bg, border: `1px solid ${c.color}33`,
          borderRadius: 12, padding: "2px 8px", fontSize: 10, fontWeight: 600,
          color: c.color, whiteSpace: "nowrap",
        }}>
          <span style={{
            width: 5, height: 5, borderRadius: "50%", background: c.color,
            animation: c.animate ? "pulse 1.2s infinite" : "none",
            flexShrink: 0,
          }} />
          {c.label}
        </div>
      );
    }

    function WatchlistQueryCard({ query, result, queryState, tradeStats, tradeItems, onUpdate, onDelete, onRefresh }) {
      const [editing, setEditing] = useState(false);

      const r = result || {};
      const hasResult = !!r.last_checked;
      const hasError = !!r.error;
      const lastChecked = r.last_checked ? new Date(r.last_checked * 1000).toLocaleTimeString() : "";
      const isDisabled = query.enabled === false;

      const priceRange = r.price_low && r.price_high
        ? (r.price_low === r.price_high ? r.price_low : `${r.price_low} — ${r.price_high}`)
        : null;

      const handleSave = (updated) => {
        onUpdate(updated);
        setEditing(false);
      };

      return (
        <div className="panel" style={{
          ...CARD, padding: 0, overflow: "hidden",
          opacity: isDisabled ? 0.6 : 1,
          display: "flex", flexDirection: "column", height: "100%",
        }}>
          {/* Header row */}
          <div style={{
            display: "flex", alignItems: "center", gap: 8, padding: "10px 12px",
            borderBottom: `1px solid ${T.border}`,
            background: T.input,
          }}>
            <div onClick={(e) => e.stopPropagation()}>
              <Toggle size="small" value={query.enabled !== false}
                onChange={(v) => onUpdate({ ...query, enabled: v })} />
            </div>

            <div style={{ flex: 1, minWidth: 0 }}>
              <div style={{ fontWeight: 600, fontSize: 13, color: isDisabled ? T.textMuted : T.text, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>
                {query.label || "Untitled Query"}
              </div>
            </div>

            {r.trade_url && (
              <Tooltip text="Open on trade site">
                <a href={r.trade_url} target="_blank" rel="noopener noreferrer" style={{
                  color: T.cyan, fontSize: 14, textDecoration: "none", lineHeight: 1,
                  display: "inline-flex", alignItems: "center",
                }}>&#8599;</a>
              </Tooltip>
            )}

            <Tooltip text="Refresh now">
              <button onClick={() => onRefresh(query.id)} style={{
                ...BTN, padding: "3px 7px", fontSize: 12, background: "transparent",
                border: `1px solid ${T.border}`, color: T.textSecond, lineHeight: 1,
              }}>&#8635;</button>
            </Tooltip>
            <Tooltip text="Edit query">
              <button onClick={() => setEditing(!editing)} style={{
                ...BTN, padding: "3px 7px", fontSize: 11, background: editing ? T.gold + "22" : "transparent",
                border: `1px solid ${editing ? T.gold : T.border}`, color: editing ? T.gold : T.textSecond, lineHeight: 1,
              }}>&#9998;</button>
            </Tooltip>
            <Tooltip text="Delete query">
              <button onClick={() => onDelete(query.id)} className="btn-danger-hover" style={{
                ...BTN, padding: "3px 7px", fontSize: 12, background: "transparent",
                border: `1px solid ${T.border}`, color: T.red, lineHeight: 1,
              }}>&#10005;</button>
            </Tooltip>
          </div>

          {/* Editor */}
          {editing && (
            <div style={{ padding: "8px 12px 12px", borderBottom: `1px solid ${T.border}` }}>
              <WatchlistQueryEditor
                query={query}
                tradeStats={tradeStats}
                tradeItems={tradeItems}
                onSave={handleSave}
                onCancel={() => setEditing(false)}
              />
            </div>
          )}

          {/* Price summary + status badge — always visible */}
          {!editing && (
            <div style={{ padding: "8px 12px", display: "flex", alignItems: "center", gap: 10, borderBottom: `1px solid ${T.border}22` }}>
              <div style={{ flex: 1, minWidth: 0 }}>
                {priceRange ? (
                  <div style={{ fontSize: 14, fontWeight: 700, color: T.gold, ...MONO, display: "flex", alignItems: "center", gap: 4 }}>
                    {priceRange.toLowerCase().includes("divine") && <CurrencyIcon src={ICON.divine} size={16} />}
                    {priceRange.toLowerCase().includes("exalted") && <CurrencyIcon src={ICON.exalted} size={16} />}
                    {priceRange.toLowerCase().includes("chaos") && <CurrencyIcon src={ICON.chaos} size={16} />}
                    {priceRange.replace(/\s*(divine|exalted|chaos)\s*/gi, " ").trim()}
                  </div>
                ) : hasError ? (
                  <div style={{ fontSize: 12, fontWeight: 600, color: T.red }}>{r.error}</div>
                ) : hasResult ? (
                  <div style={{ fontSize: 12, color: T.textMuted, ...MONO }}>No results</div>
                ) : (
                  <div style={{ fontSize: 12, color: T.textMuted }}>Waiting for first poll...</div>
                )}
                {hasResult && r.total !== undefined && (
                  <div style={{ fontSize: 10, color: T.textMuted }}>
                    {r.total} listed{lastChecked && ` · checked ${lastChecked}`}
                  </div>
                )}
              </div>
              <QueryStatusBadge queryState={queryState} />
            </div>
          )}

          {/* Listings — always expanded when available */}
          {!editing && r.listings && r.listings.length > 0 && (
            <div style={{ padding: "0 12px 8px", flex: 1, minHeight: 0 }}>
              <WatchlistListingsTable listings={r.listings} tradeUrl={r.trade_url} />
            </div>
          )}
        </div>
      );
    }

    // -----------------------------------------------------------------------
    // Watchlist — WatchlistTab
    // -----------------------------------------------------------------------
    function WatchlistTab({ settings, watchlistResults, queryStates, onSettingsUpdate, onRefresh }) {
      const [tradeStats, setTradeStats] = useState([]);
      const [tradeItems, setTradeItems] = useState([]);
      const [loaded, setLoaded] = useState(false);
      const [addingSlot, setAddingSlot] = useState(null); // index of slot being added to

      const queries = settings.watchlist_queries || [];
      const pollInterval = settings.watchlist_poll_interval || 300;
      const TOTAL_SLOTS = 6;

      // Lazy-load trade data on first render
      useEffect(() => {
        if (loaded) return;
        setLoaded(true);
        Promise.all([
          api("/api/trade-data/stats"),
          api("/api/trade-data/items"),
        ]).then(([stats, items]) => {
          if (Array.isArray(stats)) setTradeStats(stats);
          if (Array.isArray(items)) setTradeItems(items);
        });
      }, [loaded]);

      const saveQueries = (newQueries) => {
        onSettingsUpdate({ watchlist_queries: newQueries });
      };

      const handleUpdate = (updated) => {
        const newQueries = queries.map(q => q.id === updated.id ? updated : q);
        saveQueries(newQueries);
      };

      const handleDelete = (id) => {
        saveQueries(queries.filter(q => q.id !== id));
      };

      const handleAdd = (newQuery) => {
        saveQueries([...queries, newQuery]);
        setAddingSlot(null);
      };

      const handlePollIntervalChange = (val) => {
        const clamped = Math.max(60, Math.min(3600, parseInt(val) || 300));
        onSettingsUpdate({ watchlist_poll_interval: clamped });
      };

      // Build slots: active queries first, then empty slots, then "adding" slot if any
      const slots = [];
      for (let i = 0; i < TOTAL_SLOTS; i++) {
        if (i < queries.length) {
          slots.push({ type: "query", query: queries[i] });
        } else if (addingSlot === i) {
          slots.push({ type: "adding" });
        } else {
          slots.push({ type: "empty", index: i });
        }
      }

      return (
        <div>
          <div style={{ fontSize: 10, color: T.textMuted, fontStyle: "italic", padding: "8px 0 4px", borderBottom: `1px solid ${T.border}22`, marginBottom: 12 }}>
            Watchlist prices are from the trade API and reflect current listings, not completed sales. Prices may include price-fixers.
          </div>
          {/* Settings row */}
          <div className="panel" style={{ ...CARD, marginBottom: 16, display: "flex", alignItems: "center", gap: 16 }}>
            <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
              <span style={FIELD_LABEL}>Poll Interval</span>
              <select value={pollInterval} onChange={(e) => handlePollIntervalChange(e.target.value)}
                style={{ ...FIELD_INPUT, width: "auto", minWidth: 120, padding: "5px 10px", appearance: "auto" }}>
                <option value={60}>1 minute</option>
                <option value={120}>2 minutes</option>
                <option value={300}>5 minutes</option>
                <option value={600}>10 minutes</option>
                <option value={900}>15 minutes</option>
              </select>
            </div>
            <div style={{ flex: 1 }} />
            <div style={{ fontSize: 11, color: T.textMuted }}>
              {queries.length} / {TOTAL_SLOTS} queries
            </div>
          </div>

          {/* 6-slot grid */}
          <div style={{
            display: "grid",
            gridTemplateColumns: "repeat(2, 1fr)",
            gap: 12,
          }}>
            {slots.map((slot, idx) => {
              if (slot.type === "query") {
                return (
                  <WatchlistQueryCard
                    key={slot.query.id}
                    query={slot.query}
                    result={watchlistResults[slot.query.id]}
                    queryState={queryStates[slot.query.id]}
                    tradeStats={tradeStats}
                    tradeItems={tradeItems}
                    onUpdate={handleUpdate}
                    onDelete={handleDelete}
                    onRefresh={onRefresh}
                  />
                );
              } else if (slot.type === "adding") {
                return (
                  <div key={`add-${idx}`} style={{ ...CARD, padding: 12 }}>
                    <div style={{ fontWeight: 600, fontSize: 13, marginBottom: 8, color: T.gold }}>New Query</div>
                    <WatchlistQueryEditor
                      query={null}
                      tradeStats={tradeStats}
                      tradeItems={tradeItems}
                      onSave={handleAdd}
                      onCancel={() => setAddingSlot(null)}
                    />
                  </div>
                );
              } else {
                // Empty slot with rotating POE2 quote
                const quote = WATCHLIST_QUOTES[(idx - queries.length) % WATCHLIST_QUOTES.length];
                return (
                  <div
                    key={`empty-${idx}`}
                    onClick={() => { if (queries.length < TOTAL_SLOTS) setAddingSlot(slot.index); }}
                    style={{
                      border: `2px dashed ${T.border}`,
                      borderRadius: 8,
                      display: "flex", alignItems: "center", justifyContent: "center",
                      minHeight: 120,
                      cursor: queries.length < TOTAL_SLOTS ? "pointer" : "default",
                      transition: "border-color 0.15s, background 0.15s",
                    }}
                    onMouseEnter={(e) => { e.currentTarget.style.borderColor = T.borderGold; e.currentTarget.style.background = T.card; }}
                    onMouseLeave={(e) => { e.currentTarget.style.borderColor = T.border; e.currentTarget.style.background = "transparent"; }}
                  >
                    <div style={{ textAlign: "center" }}>
                      <div style={{ fontSize: 24, color: T.textMuted, lineHeight: 1 }}>+</div>
                      <div style={{ fontSize: 11, color: T.textMuted, marginTop: 6, fontStyle: "italic" }}>{quote}</div>
                    </div>
                  </div>
                );
              }
            })}
          </div>
        </div>
      );
    }

    // -----------------------------------------------------------------------
    // LogPanel
    // -----------------------------------------------------------------------
    function LogPanel({ logs, logRef, onClear }) {
      const [copyLabel, setCopyLabel] = useState("COPY");
      const [collapsed, setCollapsed] = useState(true);

      const copyLogs = () => {
        const text = logs.map(l => `${l.time || ""} ${l.message}`.trim()).join("\n");
        navigator.clipboard.writeText(text).then(() => {
          setCopyLabel("COPIED!");
          setTimeout(() => setCopyLabel("COPY"), 1500);
        }).catch(() => {
          const ta = document.createElement("textarea");
          ta.value = text;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand("copy");
          document.body.removeChild(ta);
          setCopyLabel("COPIED!");
          setTimeout(() => setCopyLabel("COPY"), 1500);
        });
      };

      return (
        <div className="panel" style={{ ...CARD, padding: 12, marginTop: 0, marginBottom: 0 }}>
          <div
            style={{
              display: "flex", justifyContent: "space-between", alignItems: "center",
              cursor: "pointer", userSelect: "none",
            }}
            onClick={() => setCollapsed(!collapsed)}
          >
            <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
              <span style={LABEL}>Console Output</span>
              {logs.length > 0 && (
                <span style={{ fontSize: 10, color: T.textMuted, ...MONO }}>{logs.length} lines</span>
              )}
            </div>
            <div style={{ display: "flex", alignItems: "center", gap: 10 }}>
              {!collapsed && (
                <>
                  <button onClick={(e) => { e.stopPropagation(); copyLogs(); }} disabled={logs.length === 0} style={{
                    background: "transparent", border: "none", fontSize: 10, fontWeight: 600,
                    cursor: logs.length > 0 ? "pointer" : "default", letterSpacing: "0.06em",
                    color: copyLabel === "COPIED!" ? T.green : (logs.length > 0 ? T.gold : T.border),
                    transition: "color 0.15s",
                  }}>{copyLabel}</button>
                  <button onClick={(e) => { e.stopPropagation(); onClear(); }} disabled={logs.length === 0} style={{
                    background: "transparent", border: "none", color: logs.length > 0 ? T.textMuted : T.border,
                    fontSize: 10, fontWeight: 600, cursor: logs.length > 0 ? "pointer" : "default", letterSpacing: "0.06em",
                  }}>CLEAR</button>
                </>
              )}
              <div style={{
                fontSize: 11, color: T.textSecond,
                transform: collapsed ? "rotate(0deg)" : "rotate(180deg)",
                transition: "transform 0.15s",
              }}>&#9660;</div>
            </div>
          </div>
          {!collapsed && (
            <div ref={logRef} style={{
              background: T.input, border: `1px solid ${T.border}`, borderRadius: 6,
              ...MONO, fontSize: 11.5, lineHeight: 1.7, height: 280, overflowY: "auto", padding: "12px 16px",
              marginTop: 8,
            }}>
              {logs.length === 0 && <div style={{ color: T.textMuted, fontStyle: "italic" }}>The Atlas is quiet... for now.</div>}
              {logs.map((log, i) => (
                <div key={i} style={{ color: log.color || T.textSecond }}>
                  <span style={{ color: T.textMuted }}>{log.time}</span>{" "}
                  {log.message}
                </div>
              ))}
            </div>
          )}
        </div>
      );
    }

    // -----------------------------------------------------------------------
    // Markets Tab — Currency exchange rates, sparklines, TradingView chart
    // -----------------------------------------------------------------------
    const MARKET_CATEGORIES = [
      { label: "All", value: "all" },
      { label: "Currency", value: "currency" },
      { label: "Fragments", value: "fragments" },
      { label: "Essences", value: "essences" },
      { label: "Runes", value: "runes" },
      { label: "Expedition", value: "expedition" },
      { label: "Soul Cores", value: "idol" },
      { label: "Uncut Gems", value: "uncutgems" },
      { label: "Ultimatum", value: "ultimatum" },
      { label: "Catalysts", value: "breach" },
      { label: "Delirium", value: "delirium" },
      { label: "Ritual", value: "ritual" },
    ];

    function SparklineSVG({ data, width = 80, height = 24, color = T.gold }) {
      if (!data || data.length < 2) return null;
      // data is cumulative % changes — convert to relative values
      const values = data.map((d, i) => 100 + (d || 0));
      const min = Math.min(...values);
      const max = Math.max(...values);
      const range = max - min || 1;
      const points = values.map((v, i) => {
        const x = (i / (values.length - 1)) * width;
        const y = height - ((v - min) / range) * (height - 2) - 1;
        return `${x.toFixed(1)},${y.toFixed(1)}`;
      }).join(" ");
      const fillPoints = `0,${height} ${points} ${width},${height}`;
      const gradId = `sg${Math.random().toString(36).slice(2, 8)}`;
      return (
        <svg width={width} height={height} style={{ display: "block" }}>
          <defs>
            <linearGradient id={gradId} x1="0" y1="0" x2="0" y2="1">
              <stop offset="0%" stopColor={color} stopOpacity="0.3" />
              <stop offset="100%" stopColor={color} stopOpacity="0.02" />
            </linearGradient>
          </defs>
          <polygon points={fillPoints} fill={`url(#${gradId})`} />
          <polyline points={points} fill="none" stroke={color} strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" />
        </svg>
      );
    }

    function MarketKPICard({ label, value, sub, change, sparklineData, color = T.gold, iconLeft, iconRight }) {
      const isUp = change > 0;
      const isDown = change < 0;
      const changeColor = isUp ? "#4ade80" : isDown ? "#ef4444" : T.textMuted;
      const arrow = isUp ? "\u25B2" : isDown ? "\u25BC" : "";
      return (
        <div className="panel" style={{ ...CARD, padding: 12, display: "flex", alignItems: "center", gap: 10, minWidth: 0 }}>
          <div style={{ flex: 1, minWidth: 0 }}>
            <div style={{ ...LABEL, marginBottom: 4, fontSize: 9 }}>{label}</div>
            <div style={{ ...MONO, fontSize: 20, fontWeight: 700, color, lineHeight: 1.2, display: "flex", alignItems: "center", gap: 4 }}>
              {iconLeft && <CurrencyIcon src={iconLeft} size={20} />}
              <span>{value}</span>
              {iconRight && <CurrencyIcon src={iconRight} size={20} />}
            </div>
            {sub && <div style={{ fontSize: 9, color: T.textMuted, marginTop: 2 }}>{sub}</div>}
            {change != null && (
              <div style={{ fontSize: 10, fontWeight: 600, color: changeColor, marginTop: 3, ...MONO }}>
                {arrow} {Math.abs(change).toFixed(1)}% <span style={{ fontWeight: 400, color: T.textMuted }}>7d</span>
              </div>
            )}
          </div>
          {sparklineData && sparklineData.length >= 2 && (
            <div style={{ flexShrink: 0 }}>
              <SparklineSVG data={sparklineData} width={64} height={28} color={changeColor !== T.textMuted ? changeColor : color} />
            </div>
          )}
        </div>
      );
    }

    // ─── Chart constants ─────────────────────────────────────────────
    const DENOMINATOR_OPTIONS = [
      { key: "chaos", label: "Chaos" },
      { key: "divine", label: "Divine" },
      { key: "exalted", label: "Exalted" },
    ];
    const CHART_COLORS = ["#c4a456", "#8bb47a", "#7a9ec4", "#b898a0", "#d4a054", "#c47a7a", "#7ab5a8", "#c9a87a"];
    const TIME_RANGES = [
      { key: "7d", days: 7, label: "7d" },
      { key: "14d", days: 14, label: "14d" },
      { key: "30d", days: 30, label: "30d" },
    ];
    const DEFAULT_CURRENCIES = ["Divine Orb"];

    function FeaturedChart({ history, currencies, rates, oldestHistoryTs }) {
      const chartRef = useRef(null);
      const seriesMapRef = useRef([]);
      const containerRef = useRef(null);
      const markerDataRef = useRef([]);
      const [selectedCurrencies, setSelectedCurrencies] = useState(DEFAULT_CURRENCIES);
      const [denominator, setDenominator] = useState("chaos");
      const [timeRange, setTimeRange] = useState("7d");
      const [markerOverlays, setMarkerOverlays] = useState([]);

      // Compute pixel positions for currency icon markers from chart coordinate API
      const computeOverlayPositions = useCallback(() => {
        if (!chartRef.current || markerDataRef.current.length === 0) {
          setMarkerOverlays([]);
          return;
        }
        const overlays = [];
        markerDataRef.current.forEach(m => {
          const series = seriesMapRef.current[m.seriesIdx];
          if (!series) return;
          try {
            const x = chartRef.current.timeScale().timeToCoordinate(m.time);
            const y = series.priceToCoordinate(m.value);
            if (x !== null && y !== null && !isNaN(x) && !isNaN(y)) {
              overlays.push({ x, y, imgUrl: m.imgUrl, isAbove: m.isAbove, text: m.text });
            }
          } catch(e) {}
        });
        setMarkerOverlays(overlays);
      }, []);

      // Available currencies (those with sparkline data, sorted by volume)
      const availableCurrencies = useMemo(() => {
        if (!currencies || currencies.length === 0) return [];
        return currencies.filter(c => c.sparkline_data && c.sparkline_data.length >= 2)
          .sort((a, b) => (b.volume || 0) - (a.volume || 0));
      }, [currencies]);

      const hasData = availableCurrencies.length > 0 || (history && history.length > 1);

      // Short display name for pills
      const shortName = (name) => name.replace(" Orb", "").replace(" of Kalandra", "");

      // Top currencies for the "Show" row (top 8 by volume)
      const showCurrencies = useMemo(() => {
        return availableCurrencies.slice(0, 8).map(c => c.name);
      }, [availableCurrencies]);

      // Handle currency pill click
      const handleCurrencyClick = (name, e) => {
        if (e.ctrlKey || e.metaKey) {
          // Toggle (multi-select)
          setSelectedCurrencies(prev => {
            if (prev.includes(name)) {
              return prev.length > 1 ? prev.filter(n => n !== name) : prev;
            }
            return [...prev, name];
          });
        } else {
          // Single select
          setSelectedCurrencies([name]);
        }
      };

      // Top 5 by volume
      const handleTop5 = () => {
        const top5 = availableCurrencies.slice(0, 5).map(c => c.name);
        if (top5.length > 0) setSelectedCurrencies(top5);
      };

      // Check if a time range has enough history data
      const hasEnoughHistory = (days) => {
        if (days <= 7) return true; // sparkline always available
        if (!oldestHistoryTs || oldestHistoryTs <= 0) return false;
        const now = Date.now() / 1000;
        return (now - oldestHistoryTs) >= (days - 2) * 86400;
      };

      // Convert divine_value to the selected denomination
      const convertValue = (divineValue, snapshotRates) => {
        const d2c = (snapshotRates && snapshotRates.divine_to_chaos) || (rates && rates.divine_to_chaos) || 68;
        const d2e = (snapshotRates && snapshotRates.divine_to_exalted) || (rates && rates.divine_to_exalted) || 387;
        if (denominator === "chaos") return divineValue * d2c;
        if (denominator === "exalted") return divineValue * d2e;
        return divineValue; // divine
      };

      // Build label string
      const buildLabel = () => {
        const denomName = DENOMINATOR_OPTIONS.find(d => d.key === denominator)?.label || "Chaos";
        if (selectedCurrencies.length === 1) {
          return `${selectedCurrencies[0]} in ${denomName}`;
        }
        return `${selectedCurrencies.length} currencies — relative change`;
      };

      // Create chart once on mount
      useEffect(() => {
        if (!containerRef.current || typeof LightweightCharts === "undefined") return;
        try {
          const chart = LightweightCharts.createChart(containerRef.current, {
            width: containerRef.current.clientWidth,
            height: 260,
            layout: { background: { color: "#0d0b08" }, textColor: "#8c7a5c", fontSize: 11, fontFamily: "'DM Sans', sans-serif" },
            grid: { vertLines: { color: "rgba(58,49,40,0.3)" }, horzLines: { color: "rgba(58,49,40,0.3)" } },
            crosshair: { mode: LightweightCharts.CrosshairMode.Normal, vertLine: { color: "rgba(196,164,86,0.3)", labelBackgroundColor: "#1c1814" }, horzLine: { color: "rgba(196,164,86,0.3)", labelBackgroundColor: "#1c1814" } },
            rightPriceScale: { borderColor: "#3a3128", autoScale: true },
            localization: { priceFormatter: (price) => { const abs = Math.abs(price); if (abs >= 100000) return (price / 1000).toFixed(0) + "k"; if (abs >= 10000) return (price / 1000).toFixed(1) + "k"; if (abs >= 1000) return Math.round(price).toLocaleString(); if (abs >= 10) return Math.round(price).toString(); if (abs >= 1) return price.toFixed(1); return price.toFixed(2); } },
            timeScale: { borderColor: "#3a3128", timeVisible: false, secondsVisible: false, fixLeftEdge: true, fixRightEdge: true, rightOffset: 0 },
            handleScroll: false,
            handleScale: false,
          });
          chartRef.current = chart;

          const handleResize = () => {
            if (containerRef.current && chartRef.current) {
              try { chartRef.current.applyOptions({ width: containerRef.current.clientWidth }); } catch(e) {}
              requestAnimationFrame(() => computeOverlayPositions());
            }
          };
          window.addEventListener("resize", handleResize);
          return () => {
            window.removeEventListener("resize", handleResize);
            try { chart.remove(); } catch(e) {}
            chartRef.current = null;
            seriesMapRef.current = [];
          };
        } catch(e) {
          console.warn("Chart init failed:", e);
        }
      }, []);

      // Update series when selection, denomination, timeRange, or data changes
      useEffect(() => {
        if (!chartRef.current) return;
        try {
          // Remove all existing series
          seriesMapRef.current.forEach(s => {
            try { chartRef.current.removeSeries(s); } catch(e) {}
          });
          seriesMapRef.current = [];

          const isMulti = selectedCurrencies.length > 1;
          const rangeDays = TIME_RANGES.find(r => r.key === timeRange)?.days || 7;
          const useHistory = rangeDays > 7;
          const d2c = (rates && rates.divine_to_chaos) || 68;
          const d2e = (rates && rates.divine_to_exalted) || 387;

          // Switch price formatter between absolute and % change modes
          const absFmt = (price) => { const abs = Math.abs(price); if (abs >= 100000) return (price / 1000).toFixed(0) + "k"; if (abs >= 10000) return (price / 1000).toFixed(1) + "k"; if (abs >= 1000) return Math.round(price).toLocaleString(); if (abs >= 10) return Math.round(price).toString(); if (abs >= 1) return price.toFixed(1); return price.toFixed(2); };
          const pctFmt = (price) => (price >= 0 ? "+" : "") + price.toFixed(1) + "%";
          chartRef.current.applyOptions({ localization: { priceFormatter: isMulti ? pctFmt : absFmt } });

          // Helper: format chart values for markers
          const fmtVal = (v) => {
            if (isMulti) return (v >= 0 ? "+" : "") + v.toFixed(1) + "%";
            const abs = Math.abs(v);
            if (abs >= 100000) return (v / 1000).toFixed(0) + "k";
            if (abs >= 10000) return (v / 1000).toFixed(1) + "k";
            if (abs >= 1000) return Math.round(v).toLocaleString();
            if (abs >= 10) return Math.round(v).toString();
            if (abs >= 1) return v.toFixed(1);
            return v.toFixed(2);
          };

          // Helper: find local peaks and lulls (returns raw data for icon overlays)
          const findPeaksLulls = (data) => {
            if (data.length < 3) return [];
            const markers = [];
            for (let i = 1; i < data.length - 1; i++) {
              const prev = data[i - 1].value, cur = data[i].value, next = data[i + 1].value;
              if (cur > prev && cur > next) {
                markers.push({ time: data[i].time, value: cur, isAbove: true, text: fmtVal(cur) });
              } else if (cur < prev && cur < next) {
                markers.push({ time: data[i].time, value: cur, isAbove: false, text: fmtVal(cur) });
              }
            }
            // Limit to most significant peaks/lulls to avoid clutter
            if (markers.length > 6) {
              const values = markers.map(m => m.value);
              const range = Math.max(...values) - Math.min(...values);
              const threshold = range * 0.15;
              const allVals = data.map(d => d.value);
              const avg = allVals.reduce((a, b) => a + b, 0) / allVals.length;
              return markers.filter(m => Math.abs(m.value - avg) > threshold).slice(0, 6);
            }
            return markers;
          };

          const allRawMarkers = [];

          selectedCurrencies.forEach((currName, idx) => {
            const color = CHART_COLORS[idx % CHART_COLORS.length];
            let series;

            if (isMulti) {
              series = chartRef.current.addLineSeries({
                color: color,
                lineWidth: 2,
                lineType: 2,
                crosshairMarkerVisible: true,
                crosshairMarkerRadius: 2,
                crosshairMarkerBackgroundColor: color,
                title: shortName(currName),
              });
            } else {
              series = chartRef.current.addAreaSeries({
                topColor: color + "66",
                bottomColor: color + "05",
                lineColor: color,
                lineWidth: 2,
                lineType: 2,
                crosshairMarkerVisible: true,
                crosshairMarkerRadius: 2,
                crosshairMarkerBackgroundColor: color,
              });
            }
            seriesMapRef.current.push(series);

            let chartData = [];

            if (!useHistory) {
              // 7d: use poe.ninja sparkline
              if (currencies) {
                const cur = currencies.find(c => c.name === currName);
                if (cur && cur.sparkline_data && cur.sparkline_data.length >= 2) {
                  const now = Math.floor(Date.now() / 1000);
                  const dayStart = now - (now % 86400);
                  const baseVal = cur.divine_value;
                  const totalChange = cur.sparkline_data[cur.sparkline_data.length - 1] || 0;
                  const basePrice = totalChange !== -100 ? baseVal / (1 + totalChange / 100) : baseVal;
                  chartData = cur.sparkline_data.map((pctChange, i) => {
                    const divPrice = basePrice * (1 + (pctChange || 0) / 100);
                    const displayVal = convertValue(divPrice, { divine_to_chaos: d2c, divine_to_exalted: d2e });
                    return {
                      time: dayStart - (cur.sparkline_data.length - 1 - i) * 86400,
                      value: displayVal,
                    };
                  });
                }
              }
            }

            // Use rate_history for 14d/30d, or as fallback for 7d
            if ((useHistory || chartData.length < 2) && history && history.length > 1) {
              const now = Date.now() / 1000;
              const cutoff = now - rangeDays * 86400;
              chartData = history.filter(h => h.ts >= cutoff).map(h => {
                let divVal = 0;
                const hd2c = h.divine_to_chaos || d2c;
                const hd2e = h.divine_to_exalted || d2e;
                // Get divine_value for this currency from history
                if (currName === "Divine Orb") divVal = 1;
                else if (currName === "Exalted Orb") divVal = hd2e > 0 ? 1 / hd2e : 0;
                else if (currName === "Chaos Orb") divVal = hd2c > 0 ? 1 / hd2c : 0;
                else divVal = (h.currencies || {})[currName] || 0;
                if (divVal <= 0) return null;
                // Convert using that snapshot's own rates for period-accurate conversion
                const displayVal = convertValue(divVal, { divine_to_chaos: hd2c, divine_to_exalted: hd2e });
                return { time: h.ts, value: displayVal };
              }).filter(Boolean);
            }

            // Deduplicate and sort
            if (chartData.length > 0) {
              const seen = new Set();
              chartData = chartData.filter(d => {
                if (seen.has(d.time)) return false;
                seen.add(d.time);
                return true;
              });
              chartData.sort((a, b) => a.time - b.time);
              // Normalize to % change when multi-select (so different-valued currencies are comparable)
              if (isMulti && chartData.length >= 2) {
                const firstVal = chartData[0].value;
                if (firstVal > 0) {
                  chartData = chartData.map(d => ({ time: d.time, value: ((d.value / firstVal) - 1) * 100 }));
                }
              }
              series.setData(chartData);
              // Collect peak/lull data for icon overlays
              const cur = currencies?.find(c => c.name === currName);
              const imgUrl = cur?.image_url || "";
              const markers = findPeaksLulls(chartData);
              markers.forEach(m => allRawMarkers.push({ ...m, seriesIdx: idx, imgUrl }));
            } else {
              series.setData([]);
            }
          });

          markerDataRef.current = allRawMarkers;
          if (chartRef.current) chartRef.current.timeScale().fitContent();
          // Compute overlay positions after chart renders
          requestAnimationFrame(() => computeOverlayPositions());
        } catch(e) {
          console.warn("Chart data update failed:", e);
        }
      }, [selectedCurrencies, denominator, timeRange, history, currencies, rates]);

      const isMulti = selectedCurrencies.length > 1;
      const denomLabel = isMulti ? "% change" : (DENOMINATOR_OPTIONS.find(d => d.key === denominator)?.label || "Chaos");

      return (
        <div className="panel" style={{ ...CARD, padding: 0, overflow: "hidden", marginBottom: 12 }}>
          {/* Row 1: SHOW currency pills + Top 5 */}
          <div style={{ padding: "10px 14px 4px", display: "flex", alignItems: "center", gap: 6, flexWrap: "wrap" }}>
            <span style={{ fontSize: 9, fontWeight: 700, color: T.textMuted, letterSpacing: "0.1em", marginRight: 2 }}>SHOW</span>
            {showCurrencies.map((name, idx) => {
              const active = selectedCurrencies.includes(name);
              const colorDot = isMulti && active ? CHART_COLORS[selectedCurrencies.indexOf(name) % CHART_COLORS.length] : null;
              return (
                <button
                  key={name}
                  onClick={(e) => handleCurrencyClick(name, e)}
                  title={`Click to select, Ctrl+Click to multi-select`}
                  style={{
                    ...BTN,
                    padding: "4px 10px",
                    fontSize: 10,
                    background: active ? "rgba(196,164,86,0.2)" : "transparent",
                    border: `1px solid ${active ? T.borderGold : T.border}`,
                    color: active ? T.gold : T.textSecond,
                    display: "flex", alignItems: "center", gap: 4,
                  }}
                >
                  {colorDot && <span style={{ width: 6, height: 6, borderRadius: "50%", background: colorDot, flexShrink: 0 }} />}
                  {shortName(name)}
                </button>
              );
            })}
            <button
              onClick={handleTop5}
              style={{
                ...BTN,
                padding: "4px 10px",
                fontSize: 10,
                background: selectedCurrencies.length === 5 ? "rgba(196,164,86,0.15)" : "transparent",
                border: `1px solid ${T.border}`,
                color: T.textSecond,
                fontStyle: "italic",
              }}
            >
              Top 5
            </button>
          </div>
          {/* Row 2: PRICED IN denomination + time range */}
          <div style={{ padding: "2px 14px 8px", display: "flex", alignItems: "center", gap: 6, flexWrap: "wrap" }}>
            <span style={{ fontSize: 9, fontWeight: 700, color: T.textMuted, letterSpacing: "0.1em", marginRight: 2 }}>PRICED IN</span>
            {DENOMINATOR_OPTIONS.map(opt => {
              const active = denominator === opt.key;
              return (
                <button
                  key={opt.key}
                  onClick={() => setDenominator(opt.key)}
                  style={{
                    ...BTN,
                    padding: "3px 10px",
                    fontSize: 10,
                    background: active ? "rgba(196,164,86,0.2)" : "transparent",
                    border: `1px solid ${active ? T.borderGold : T.border}`,
                    color: active ? T.gold : T.textSecond,
                  }}
                >
                  {opt.label}
                </button>
              );
            })}
            <div style={{ marginLeft: "auto", display: "flex", alignItems: "center", gap: 4 }}>
              {TIME_RANGES.map(tr => {
                const active = timeRange === tr.key;
                const enabled = hasEnoughHistory(tr.days);
                return (
                  <button
                    key={tr.key}
                    onClick={() => enabled && setTimeRange(tr.key)}
                    title={!enabled ? `Need ${tr.days - 2}+ days of history` : `Show ${tr.label} of data`}
                    style={{
                      ...BTN,
                      padding: "3px 8px",
                      fontSize: 10,
                      background: active ? "rgba(196,164,86,0.2)" : "transparent",
                      border: `1px solid ${active ? T.borderGold : T.border}`,
                      color: active ? T.gold : enabled ? T.textSecond : T.textMuted,
                      opacity: enabled ? 1 : 0.4,
                      cursor: enabled ? "pointer" : "not-allowed",
                    }}
                  >
                    {tr.label}
                  </button>
                );
              })}
            </div>
          </div>
          {/* Chart area */}
          <div style={{ position: "relative" }}>
            {/* Y-axis unit label */}
            <div style={{
              position: "absolute", top: 8, left: 10, zIndex: 2,
              fontSize: 9, color: T.textMuted, letterSpacing: "0.05em",
              pointerEvents: "none",
            }}>
              {denomLabel}
            </div>
            {/* Description label */}
            <div style={{
              position: "absolute", top: 8, right: 60, zIndex: 2,
              fontSize: 9, color: T.textMuted, letterSpacing: "0.03em",
              pointerEvents: "none", fontStyle: "italic",
            }}>
              {buildLabel()}
            </div>
            {/* Time range label */}
            <div style={{
              position: "absolute", bottom: 4, right: 12, zIndex: 2,
              fontSize: 9, color: T.textMuted, letterSpacing: "0.05em",
              pointerEvents: "none",
            }}>
              {timeRange} trend
            </div>
            <div ref={containerRef} style={{ width: "100%", height: 260 }}>
              {!hasData && (
                <div style={{ display: "flex", alignItems: "center", justifyContent: "center", height: "100%", color: T.textMuted, fontSize: 12 }}>
                  Waiting for price data...
                </div>
              )}
            </div>
            {/* Currency icon markers at peaks/lulls */}
            {markerOverlays.map((m, i) => (
              <div key={i} style={{
                position: "absolute",
                left: m.x,
                top: m.isAbove ? m.y - 26 : m.y + 4,
                transform: "translateX(-50%)",
                display: "flex", flexDirection: "column", alignItems: "center", gap: 1,
                pointerEvents: "none", zIndex: 3,
              }}>
                {m.isAbove && <span style={{ fontSize: 7, color: T.textSecond, ...MONO, lineHeight: 1, whiteSpace: "nowrap" }}>{m.text}</span>}
                {m.imgUrl ? (
                  <img src={m.imgUrl} alt="" style={{ width: 12, height: 12, objectFit: "contain" }} onError={e => e.target.style.display = "none"} />
                ) : (
                  <span style={{ width: 5, height: 5, borderRadius: "50%", background: T.textSecond, display: "inline-block" }} />
                )}
                {!m.isAbove && <span style={{ fontSize: 7, color: T.textSecond, ...MONO, lineHeight: 1, whiteSpace: "nowrap" }}>{m.text}</span>}
              </div>
            ))}
          </div>
        </div>
      );
    }

    function CurrencyRow({ currency, rates, index }) {
      const { name, divine_value, chaos_value, sparkline_data, sparkline_change, volume, image_url, category } = currency;
      const isUp = sparkline_change > 0;
      const isDown = sparkline_change < 0;
      const changeColor = isUp ? "#4ade80" : isDown ? "#ef4444" : T.textMuted;
      const arrow = isUp ? "\u25B2" : isDown ? "\u25BC" : "";
      const bg = index % 2 === 0 ? "transparent" : "rgba(255,255,255,0.015)";

      // Format value
      let valueStr = "";
      if (divine_value >= 1) valueStr = `${divine_value.toFixed(divine_value >= 10 ? 0 : 1)} div`;
      else if (chaos_value >= 1) valueStr = `${chaos_value.toFixed(chaos_value >= 10 ? 0 : 1)} chaos`;
      else valueStr = `${chaos_value.toFixed(2)} chaos`;

      // Exchange rate string
      let exchangeStr = "";
      if (divine_value > 0 && divine_value < 1) {
        const perDiv = 1 / divine_value;
        exchangeStr = `~${perDiv.toFixed(0)} = 1 Divine`;
      }

      return (
        <div style={{
          display: "grid",
          gridTemplateColumns: "28px 1fr 100px 70px 80px 50px",
          alignItems: "center",
          padding: "6px 10px",
          background: bg,
          gap: 8,
          fontSize: 12,
          transition: "background 0.1s",
          cursor: "default",
        }}
          onMouseEnter={e => e.currentTarget.style.background = "rgba(196,164,86,0.06)"}
          onMouseLeave={e => e.currentTarget.style.background = bg}
        >
          <div style={{ width: 24, height: 24, display: "flex", alignItems: "center", justifyContent: "center" }}>
            {image_url ? (
              <img src={image_url} alt="" style={{ width: 22, height: 22, objectFit: "contain" }} onError={e => e.target.style.display = "none"} />
            ) : (
              <div style={{ width: 22, height: 22, borderRadius: 4, background: T.border }} />
            )}
          </div>
          <div style={{ minWidth: 0 }}>
            <div style={{ color: T.text, fontWeight: 500, whiteSpace: "nowrap", overflow: "hidden", textOverflow: "ellipsis" }}>{name}</div>
            {exchangeStr && <div style={{ fontSize: 9, color: T.textMuted, ...MONO }}>{exchangeStr}</div>}
          </div>
          <div style={{ ...MONO, fontWeight: 600, color: T.gold, textAlign: "right" }}>{valueStr}</div>
          <div style={{ ...MONO, fontWeight: 600, color: changeColor, textAlign: "right", fontSize: 11 }}>
            {sparkline_change !== 0 ? `${arrow} ${Math.abs(sparkline_change).toFixed(1)}%` : "--"}
          </div>
          <div style={{ display: "flex", justifyContent: "center" }}>
            <SparklineSVG data={sparkline_data} width={70} height={20} color={changeColor !== T.textMuted ? changeColor : T.textSecond} />
          </div>
          <div style={{ ...MONO, fontSize: 10, color: T.textMuted, textAlign: "right" }}>
            {volume > 0 ? (volume >= 1000 ? `${(volume/1000).toFixed(1)}k` : volume.toFixed(0)) : "--"}
          </div>
        </div>
      );
    }

    function MarketSignals() {
      return (
        <div className="panel" style={{
          ...CARD,
          padding: "10px 14px",
          display: "flex",
          flexDirection: "column",
          gap: 6,
        }}>
          {/* Header row */}
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
            <span style={{ ...LABEL, fontSize: 9, letterSpacing: 1.2 }}>MARKET SIGNALS</span>
            <span style={{
              fontSize: 9,
              color: T.gold,
              background: "rgba(196,164,86,0.1)",
              border: `1px solid ${T.borderGold}`,
              borderRadius: 4,
              padding: "2px 7px",
              fontWeight: 600,
            }}>@MarketMonkey 🐒</span>
          </div>
          {/* Coming soon body */}
          <div style={{
            fontSize: 11,
            color: T.textMuted,
            fontStyle: "italic",
            textAlign: "center",
            padding: "6px 0 2px",
          }}>
            Coming soon — curated market signals from trusted community analysts on Discord.
          </div>
        </div>
      );
    }

    function MarketsTab() {
      const [data, setData] = useState(null);
      const [loading, setLoading] = useState(true);
      const [filter, setFilter] = useState("all");

      const fetchData = async () => {
        const result = await api("/api/market-data");
        if (result && !result.error) {
          setData(result);
        }
        setLoading(false);
      };

      // Future: fetch market signals when Discord bot is connected
      // const fetchSignals = async () => {
      //   const result = await api("/api/market-signals");
      //   if (result && !result.error) setSignals(result.signals);
      // };

      useEffect(() => {
        fetchData();
        // Poll faster (5s) while waiting for data, then slow down to 60s
        const interval = setInterval(fetchData, hasCurrencies ? 60000 : 5000);
        return () => clearInterval(interval);
      }, [hasCurrencies]);

      const currencies = (data && data.currencies) || [];
      const rates = (data && data.rates) || {};
      const history = (data && data.history) || [];
      const hasCurrencies = currencies.length > 0;

      // Find specific currencies for KPI cards
      const findCurrency = (name) => currencies.find(c => c.name === name) || {};
      const hinekora = findCurrency("Hinekora's Lock");
      const fracturing = findCurrency("Fracturing Orb");
      const omenLight = findCurrency("Omen of Light");
      const omenAbyss = findCurrency("Essence of the Abyss");
      const divToEx = rates.divine_to_exalted || 0;

      // Filter currencies by category
      const filtered = filter === "all"
        ? currencies
        : currencies.filter(c => (c.category || "").toLowerCase() === filter);

      return (
        <div style={{ paddingTop: 12 }}>
          {/* KPI Hero Cards */}
          <div style={{ display: "grid", gridTemplateColumns: "repeat(4, 1fr)", gap: 10, marginBottom: 12 }}>
            <MarketKPICard
              label="Hinekora's Lock"
              value={hinekora.divine_value ? (hinekora.divine_value >= 10 ? `${Math.round(hinekora.divine_value)}` : `${hinekora.divine_value.toFixed(1)}`) : "--"}
              sub="Divine Orbs"
              change={hinekora.sparkline_change}
              sparklineData={hinekora.sparkline_data}
              color="#c084fc"
              iconLeft={hinekora.image_url}
              iconRight={ICON.divine}
            />
            <MarketKPICard
              label="Fracturing Orb"
              value={fracturing.divine_value ? (fracturing.divine_value >= 10 ? `${Math.round(fracturing.divine_value)}` : `${fracturing.divine_value.toFixed(1)}`) : "--"}
              sub="Divine Orbs"
              change={fracturing.sparkline_change}
              sparklineData={fracturing.sparkline_data}
              color="#f59e0b"
              iconLeft={fracturing.image_url}
              iconRight={ICON.divine}
            />
            <MarketKPICard
              label="Omen of Light"
              value={omenLight.divine_value ? (omenLight.divine_value >= 10 ? `${Math.round(omenLight.divine_value)}` : `${omenLight.divine_value.toFixed(1)}`) : "--"}
              sub="Divine Orbs"
              change={omenLight.sparkline_change}
              sparklineData={omenLight.sparkline_data}
              color="#8bb47a"
              iconLeft={omenLight.image_url}
              iconRight={ICON.divine}
            />
            <MarketKPICard
              label="Essence of the Abyss"
              value={omenAbyss.divine_value && divToEx ? `${Math.round(omenAbyss.divine_value * divToEx)}` : "--"}
              sub="Exalted Orbs"
              change={omenAbyss.sparkline_change}
              sparklineData={omenAbyss.sparkline_data}
              color="#7a9ec4"
              iconLeft={omenAbyss.image_url}
              iconRight={ICON.exalted}
            />
          </div>

          {/* Featured Chart */}
          <FeaturedChart history={history} currencies={currencies} rates={rates} oldestHistoryTs={data?.oldest_history_ts || 0} />

          {/* Market Signals */}
          <MarketSignals />

          {/* Exchange Rate Table */}
          <div className="panel" style={{ ...CARD, padding: 0, overflow: "hidden" }}>
            {/* Category filter pills */}
            <div style={{ padding: "10px 14px 6px", display: "flex", gap: 4, flexWrap: "wrap", borderBottom: `1px solid ${T.border}` }}>
              {MARKET_CATEGORIES.map(cat => {
                const active = filter === cat.value;
                return (
                  <button
                    key={cat.value}
                    onClick={() => setFilter(cat.value)}
                    style={{
                      ...BTN,
                      padding: "3px 10px",
                      fontSize: 10,
                      background: active ? "rgba(196,164,86,0.2)" : "transparent",
                      border: `1px solid ${active ? T.borderGold : "transparent"}`,
                      color: active ? T.gold : T.textSecond,
                    }}
                  >
                    {cat.label}
                  </button>
                );
              })}
            </div>
            {/* Table header */}
            <div style={{
              display: "grid",
              gridTemplateColumns: "28px 1fr 100px 70px 80px 50px",
              padding: "6px 10px",
              gap: 8,
              borderBottom: `1px solid ${T.border}`,
            }}>
              <div />
              <div style={{ ...LABEL, fontSize: 8 }}>Currency</div>
              <div style={{ ...LABEL, fontSize: 8, textAlign: "right" }}>Value</div>
              <div style={{ ...LABEL, fontSize: 8, textAlign: "right" }}>7d %</div>
              <div style={{ ...LABEL, fontSize: 8, textAlign: "center" }}>Trend</div>
              <div style={{ ...LABEL, fontSize: 8, textAlign: "right" }}>Vol</div>
            </div>
            {/* Table rows */}
            <div style={{ maxHeight: 400, overflowY: "auto" }}>
              {filtered.map((cur, i) => (
                <CurrencyRow key={cur.name} currency={cur} rates={rates} index={i} />
              ))}
              {filtered.length === 0 && (
                <div style={{ padding: 20, textAlign: "center", color: T.textMuted, fontSize: 12 }}>
                  {!hasCurrencies ? (
                    <div style={{ display: "flex", alignItems: "center", justifyContent: "center", gap: 8 }}>
                      <div style={{ width: 14, height: 14, border: `2px solid ${T.border}`, borderTopColor: T.gold, borderRadius: "50%", animation: "spin 0.8s linear infinite", flexShrink: 0 }} />
                      Fetching exchange rates from poe.ninja...
                    </div>
                  ) : "No items in this category"}
                </div>
              )}
            </div>
          </div>

          {/* Footer */}
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginTop: 8, padding: "0 4px" }}>
            <div style={{ fontSize: 9, color: T.textMuted, fontStyle: "italic" }}>
              Live rates from poe.ninja — refreshed every 15 minutes
            </div>
            <a
              href="https://www.tradingview.com/"
              target="_blank"
              rel="noopener noreferrer"
              style={{ fontSize: 9, color: T.textMuted, textDecoration: "none" }}
              onMouseEnter={e => e.target.style.color = T.textSecond}
              onMouseLeave={e => e.target.style.color = T.textMuted}
            >
              Charts by TradingView
            </a>
          </div>
        </div>
      );
    }

    // -----------------------------------------------------------------------
    // Main App
    // -----------------------------------------------------------------------
    function Dashboard() {
      const [status, setStatus] = useState({ state: "stopped", uptime: 0, stats: { uptime_min: 0, triggers: 0, prices_shown: 0, success_rate: 0, cache_items: 0, last_refresh: "never", divine_to_chaos: 0, divine_to_exalted: 0, mirror_to_divine: 0, calibration_samples: 0 } });
      const [settings, setSettings] = useState({ league: "Fate of the Vaal", no_filter_update: false, auto_start: true, start_with_windows: false, font_size: 14, scan_fps: 8, detection_cooldown: 1.0, overlay_duration: 2.0, cursor_still_radius: 20, cursor_still_frames: 3, filter_strictness: "normal", filter_tier_styles: {}, filter_section_visibility: {}, filter_gear_classes: {}, filter_color_preset: "default", overlay_show_grade: true, overlay_show_price: true, overlay_show_stars: true, overlay_show_mods: false, overlay_show_dps: true, overlay_display_preset: "standard", overlay_tier_styles: {} });
      const [leagues, setLeagues] = useState([{ value: "Fate of the Vaal", label: "Fate of the Vaal" }]);
      const [logs, setLogs] = useState([]);
      const [autoStartDone, setAutoStartDone] = useState(false);
      const [bugModalOpen, setBugModalOpen] = useState(false);
      const [feedbackModal, setFeedbackModal] = useState(null); // null | "feedback" | "feature"
      const [filterUpdating, setFilterUpdating] = useState(false);
      const [activeTab, setActiveTab] = useState("overlay");
      const [watchlistResults, setWatchlistResults] = useState({});
      const [queryStates, setQueryStates] = useState({});
      const [updateInfo, setUpdateInfo] = useState(null);
      const [telemetryStatus, setTelemetryStatus] = useState({ last_upload: null, pending_samples: 0, enabled: false });
      const logRef = useRef(null);
      const autoScrollRef = useRef(true);

      // Auto-scroll log panel
      useEffect(() => {
        if (logRef.current && autoScrollRef.current) {
          logRef.current.scrollTop = logRef.current.scrollHeight;
        }
      }, [logs]);

      // Track if user has scrolled up
      useEffect(() => {
        const el = logRef.current;
        if (!el) return;
        const onScroll = () => {
          const atBottom = el.scrollHeight - el.scrollTop - el.clientHeight < 40;
          autoScrollRef.current = atBottom;
        };
        el.addEventListener("scroll", onScroll);
        return () => el.removeEventListener("scroll", onScroll);
      }, []);

      // WebSocket handler
      const handleWsMessage = useCallback((msg) => {
        switch (msg.type) {
          case "init":
            setStatus({ state: msg.state, uptime: msg.uptime, stats: msg.stats });
            if (msg.settings) setSettings(msg.settings);
            if (msg.log && msg.log.length > 0) {
              setLogs(msg.log);
            }
            if (msg.watchlist_results) setWatchlistResults(msg.watchlist_results);
            if (msg.watchlist_states) setQueryStates(msg.watchlist_states);
            break;
          case "log":
            setLogs(prev => {
              const next = [...prev, { time: msg.time, message: msg.message, color: msg.color }];
              return next.length > 500 ? next.slice(-500) : next;
            });
            break;
          case "status":
            setStatus(prev => ({ ...prev, state: msg.state, uptime: msg.uptime, stats: msg.stats }));
            break;
          case "state_change":
            setStatus(prev => ({ ...prev, state: msg.state }));
            break;
          case "settings":
            if (msg.settings) setSettings(msg.settings);
            break;
          case "watchlist_result":
            if (msg.result) {
              setWatchlistResults(prev => ({ ...prev, [msg.result.query_id]: msg.result }));
            }
            break;
          case "watchlist_state":
            if (msg.states) {
              setQueryStates(msg.states);
            }
            break;
          case "update_available":
            setUpdateInfo({ current: msg.current, latest: msg.latest, url: msg.url, setup_url: msg.setup_url || "" });
            break;
          case "update_progress":
            setUpdateInfo(prev => prev ? { ...prev, progress: msg.percent, installing: msg.installing || false } : prev);
            break;
          case "market_signal":
            // Future: append signal to market signals feed
            break;
          case "app_restart":
            // Server is restarting — force-close the pywebview window so the old process exits
            // (close() just hides to tray, force_close() actually destroys the window)
            if (window.pywebview && window.pywebview.api && window.pywebview.api.force_close) {
              window.pywebview.api.force_close();
            } else if (window.pywebview && window.pywebview.api) {
              window.pywebview.api.close();
            } else {
              window.close();
            }
            break;
        }
      }, []);

      const { connected } = useDashboardSocket(WS_URL, handleWsMessage);

      // Fetch leagues + telemetry status on mount
      useEffect(() => {
        api("/api/leagues").then(data => {
          if (data.leagues && data.leagues.length > 0) {
            setLeagues(data.leagues);
          }
        });
        refreshTelemetryStatus();
      }, []);

      // Auto-start overlay on mount
      useEffect(() => {
        if (autoStartDone) return;
        if (!connected) return;

        setAutoStartDone(true);

        // Small delay to let init message arrive
        const timer = setTimeout(() => {
          setStatus(prev => {
            // Only auto-start if not already running and auto_start is enabled
            if (prev.state !== "running" && prev.state !== "starting") {
              // Check settings from the latest state
              api("/api/settings").then(s => {
                if (s.auto_start !== false) {
                  api("/api/start", "POST");
                }
              });
            }
            return prev;
          });
        }, 500);

        return () => clearTimeout(timer);
      }, [connected, autoStartDone]);

      // Handlers — begin_guard() installs a Win32 hook that silently blocks
      // window resize for 1 second, preventing the pywebview frameless glitch
      const guardedAction = (fn) => { window.pywebview?.api?.begin_guard(); fn(); };
      const handleStart = () => guardedAction(() => api("/api/start", "POST"));
      const handleStop = () => guardedAction(() => api("/api/stop", "POST"));
      const handleRestart = () => guardedAction(() => api("/api/restart", "POST"));

      const handleLeagueChange = (league) => {
        const newSettings = { ...settings, league };
        setSettings(newSettings);
        api("/api/settings", "POST", { league });
      };

      const refreshTelemetryStatus = () => {
        api("/api/telemetry/status").then(data => {
          if (data && !data.error) setTelemetryStatus(data);
        });
      };

      const handleSettingsUpdate = (updates) => {
        const newSettings = { ...settings, ...updates };
        setSettings(newSettings);
        api("/api/settings", "POST", updates).then(() => {
          if ("telemetry_enabled" in updates) refreshTelemetryStatus();
        });
      };

      const handleRestartApp = () => api("/api/restart-app", "POST");

      const handleWatchlistRefresh = (queryId) => {
        api(`/api/watchlist/refresh/${queryId}`, "POST");
      };

      const handleUpdateFilter = async () => {
        setFilterUpdating(true);
        const res = await api("/api/update-filter", "POST");
        setFilterUpdating(false);
        if (res.error) {
          console.error("Filter update failed:", res.error);
        }
      };

      return (
        <div className="app-frame">
          <WindowTitleBar
            wsConnected={connected}
            overlayState={status.state}
          />
          <GoldDivider />
          {updateInfo && (
            <div style={{ maxWidth: 1050, margin: "0 auto", padding: "4px 24px" }}>
              <div style={{ background: "rgba(196,164,86,0.12)", border: `1px solid ${T.gold}`, borderRadius: 8, padding: "8px 14px" }}>
                <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between" }}>
                  <span style={{ color: T.gold, fontSize: 12, fontWeight: 600, display: "flex", alignItems: "center", gap: 6 }}>
                    <span style={{ display: "inline-block", width: 5, height: 5, background: T.gold, transform: "rotate(45deg)", flexShrink: 0 }} />
                    {updateInfo.installing ? "Installing update..." : `Update available: v${updateInfo.latest}`}
                    {!updateInfo.installing && <span style={{ color: T.textSecond, fontWeight: 400, marginLeft: 8 }}>(current: v{updateInfo.current})</span>}
                  </span>
                  <span style={{ display: "flex", gap: 8 }}>
                    {updateInfo.installing ? null : updateInfo.progress != null ? null : updateInfo.setup_url ? (
                      <button onClick={() => api("/api/apply-update", "POST")} style={{ ...BTN, background: T.gold, color: "#0d0b08", padding: "4px 12px", fontSize: 10 }}>Install Update</button>
                    ) : (
                      <a href={updateInfo.url} target="_blank" rel="noopener noreferrer" style={{ ...BTN, background: T.gold, color: "#0d0b08", textDecoration: "none", padding: "4px 12px", fontSize: 10 }}>Download</a>
                    )}
                    {!updateInfo.installing && updateInfo.progress == null && (
                      <button onClick={() => setUpdateInfo(null)} style={{ ...BTN, background: "transparent", border: `1px solid ${T.border}`, color: T.textSecond, padding: "4px 8px", fontSize: 10 }}>Dismiss</button>
                    )}
                  </span>
                </div>
                {updateInfo.progress != null && (
                  <div style={{ marginTop: 6 }}>
                    <div style={{ background: "rgba(255,255,255,0.08)", borderRadius: 4, height: 5, overflow: "hidden" }}>
                      <div style={{ background: T.gold, height: "100%", width: `${updateInfo.progress}%`, borderRadius: 4, transition: "width 0.3s ease" }} />
                    </div>
                    <div style={{ color: T.textSecond, fontSize: 10, marginTop: 3, textAlign: "center" }}>
                      {updateInfo.installing ? "Launching installer..." : `Downloading: ${updateInfo.progress}%`}
                    </div>
                  </div>
                )}
              </div>
            </div>
          )}
          <StatusPanel status={status} />
          <div style={{ maxWidth: 1050, margin: "0 auto", padding: "0 24px" }}>
            <TabBar activeTab={activeTab} onTabChange={setActiveTab} />
          </div>
          <div style={{ flex: 1, overflowY: "auto", scrollbarGutter: "stable", minHeight: 0 }}>
            <div style={{ maxWidth: 1050, margin: "0 auto", padding: "0 24px 16px" }}>
              {activeTab === "overlay" && (
                <>
                  <ScannerStatusCard status={status} onStart={handleStart} onStop={handleStop} onRestart={handleRestart} />
                  <ItemLookupCard />
                  <OverlaySettingsTab settings={settings} onUpdate={handleSettingsUpdate} overlayState={status.state} telemetryStatus={telemetryStatus} onTelemetryUpload={() => { api("/api/telemetry/upload", "POST").then(refreshTelemetryStatus); }} />
                  <LogPanel logs={logs} logRef={logRef} onClear={() => setLogs([])} />
                </>
              )}
              {activeTab === "filter" && (
                <FilterTab
                  settings={settings}
                  onUpdate={handleSettingsUpdate}
                  onUpdateFilter={handleUpdateFilter}
                  filterUpdating={filterUpdating}
                />
              )}
              {activeTab === "watchlist" && (
                <WatchlistTab
                  settings={settings}
                  watchlistResults={watchlistResults}
                  queryStates={queryStates}
                  onSettingsUpdate={handleSettingsUpdate}
                  onRefresh={handleWatchlistRefresh}
                />
              )}
              {activeTab === "markets" && (
                <MarketsTab />
              )}
            </div>
          </div>
          <BrandFooter
            leagues={leagues}
            selectedLeague={settings.league}
            onLeagueChange={handleLeagueChange}
            onBugReport={() => setBugModalOpen(true)}
            onFeedback={() => setFeedbackModal("feedback")}
            onFeatureRequest={() => setFeedbackModal("feature")}
            onRestartApp={handleRestartApp}
          />
          <BugReportModal open={bugModalOpen} onClose={() => setBugModalOpen(false)} />
          <FeedbackModal open={!!feedbackModal} feedbackType={feedbackModal || "feedback"} onClose={() => setFeedbackModal(null)} />
        </div>
      );
    }

    // -----------------------------------------------------------------------
    // Mount
    // -----------------------------------------------------------------------
    ReactDOM.createRoot(document.getElementById("root")).render(<Dashboard />);
  </script>
</body>
</html>
