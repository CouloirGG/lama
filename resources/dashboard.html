<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>POE2 Price Overlay</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap');
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.3} }
    @keyframes spin { to { transform: rotate(360deg); } }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { width: 100%; height: 100%; overflow: hidden; margin: 0; padding: 0; }
    body { background: radial-gradient(ellipse at center, #1a1510 0%, #0d0b08 70%); color: #d4c9a8; font-family: 'DM Sans', 'Segoe UI', system-ui, sans-serif; }
    #root { width: 100%; height: 100%; }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #3a3128; border-radius: 3px; }
    input:focus, select:focus { outline: none; border-color: #c4a456 !important; }
    select option { background: #12100c; color: #d4c9a8; }

    /* POE2 App Frame */
    .app-frame {
      position: relative;
      border: 1px solid #6b5a3e;
      box-shadow:
        inset 0 0 60px rgba(196,164,86,0.04),
        0 0 0 4px #0d0b08,
        0 0 0 5px #3a3128,
        0 0 40px rgba(0,0,0,0.5);
      margin: 8px;
      height: calc(100vh - 16px);
      display: flex;
      flex-direction: column;
      border-radius: 10px;
      overflow: hidden;
    }

    /* Custom window title bar */
    .window-titlebar {
      display: flex;
      align-items: center;
      height: 36px;
      padding: 0 4px 0 12px;
      flex-shrink: 0;
      user-select: none;
    }
    .window-btn {
      width: 36px; height: 28px;
      border: none; background: transparent;
      color: #8c7a5c; cursor: pointer;
      display: inline-flex; align-items: center; justify-content: center;
      font-size: 14px; line-height: 1;
      transition: background 0.15s, color 0.15s;
      border-radius: 4px;
    }
    .window-btn:hover { background: rgba(196,164,86,0.12); color: #c4a456; }
    .window-btn-close:hover { background: rgba(200,50,50,0.4); color: #ff6666; }

    /* Footer branding */
    .app-footer {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 10px;
      padding: 6px 16px;
      flex-shrink: 0;
      user-select: none;
      border-top: 1px solid rgba(107,90,62,0.3);
    }
    .footer-email {
      font-size: 10px;
      color: #5c4f3d;
      text-decoration: none;
      transition: color 0.15s;
      letter-spacing: 0.03em;
    }
    .footer-email:hover { color: #c4a456; }

    /* Couloir flyout */
    @keyframes flyoutIn {
      from { opacity: 0; transform: translateY(8px) scale(0.97); }
      to   { opacity: 1; transform: translateY(0) scale(1); }
    }
    .couloir-flyout {
      position: absolute;
      bottom: calc(100% + 8px);
      right: 0;
      width: 340px;
      background: #141110;
      border: 1px solid #6b5a3e;
      border-radius: 10px;
      box-shadow: 0 -4px 30px rgba(0,0,0,0.6), 0 0 0 1px rgba(196,164,86,0.08);
      padding: 20px;
      animation: flyoutIn 0.25s ease-out;
      z-index: 100;
    }
    .couloir-flyout-link {
      color: #8c7a5c;
      text-decoration: none;
      transition: color 0.15s;
    }
    .couloir-flyout-link:hover { color: #c4a456; }

    /* Gold header divider */
    .gold-divider {
      position: relative; height: 1px;
      background: linear-gradient(90deg, transparent, #6b5a3e 20%, #6b5a3e 80%, transparent);
      margin: 0;
    }
    .gold-divider::after {
      content: ''; position: absolute;
      left: 50%; top: 50%;
      transform: translate(-50%, -50%) rotate(45deg);
      width: 6px; height: 6px;
      background: #c4a456; border: 1px solid #6b5a3e;
    }

    /* Panel corner accents */
    .panel {
      position: relative;
      transition: box-shadow 0.25s ease;
    }
    .panel:hover {
      box-shadow: 0 0 12px rgba(196,164,86,0.08);
    }
    .panel::before, .panel::after {
      content: ''; position: absolute;
      width: 10px; height: 10px;
      pointer-events: none; z-index: 1;
    }
    .panel::before {
      top: -1px; left: -1px;
      border-top: 1.5px solid #6b5a3e;
      border-left: 1.5px solid #6b5a3e;
    }
    .panel::after {
      bottom: -1px; right: -1px;
      border-bottom: 1.5px solid #6b5a3e;
      border-right: 1.5px solid #6b5a3e;
    }

    /* Tab styling */
    .poe-tab {
      position: relative;
      border-radius: 6px 6px 0 0 !important;
      transition: all 0.2s ease !important;
      border: 1px solid transparent !important;
      border-bottom: none !important;
      margin-bottom: -1px;
    }
    .poe-tab:hover { background: rgba(196,164,86,0.06) !important; }
    .poe-tab-active {
      background: rgba(196,164,86,0.15) !important;
      border-color: #3a3128 !important;
      border-bottom: 1px solid #0d0b08 !important;
    }

    /* Button hover effects */
    .btn-gold-hover:hover { box-shadow: 0 0 12px rgba(196,164,86,0.2); }
    .btn-danger-hover:hover { box-shadow: 0 0 12px rgba(168,50,50,0.25); }

    /* Accordion expanded gold accent */
    .accordion-expanded {
      border-left: 2px solid #c4a456 !important;
    }

    /* Shimmer animation */
    @keyframes goldShimmer {
      0%, 100% { box-shadow: inset 0 0 60px rgba(196,164,86,0.04), 0 0 0 4px #0d0b08, 0 0 0 5px #3a3128, 0 0 40px rgba(0,0,0,0.5); }
      50% { box-shadow: inset 0 0 60px rgba(196,164,86,0.07), 0 0 0 4px #0d0b08, 0 0 0 5px #3a3128, 0 0 40px rgba(0,0,0,0.5); }
    }
    .app-frame { animation: goldShimmer 8s ease-in-out infinite; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;

    // -----------------------------------------------------------------------
    // Config
    // -----------------------------------------------------------------------
    const PORT = 8450;
    const API_BASE = `http://127.0.0.1:${PORT}`;
    const WS_URL = `ws://127.0.0.1:${PORT}/ws`;

    // -----------------------------------------------------------------------
    // POE2 Theme
    // -----------------------------------------------------------------------
    const T = {
      bg:          "#0d0b08",
      card:        "#1c1814",
      input:       "#12100c",
      border:      "#3a3128",
      borderGold:  "#6b5a3e",
      text:        "#d4c9a8",
      textSecond:  "#8c7a5c",
      textMuted:   "#5c4f3d",
      gold:        "#c4a456",
      green:       "#4a7c59",
      red:         "#a83232",
      amber:       "#b8860b",
      cyan:        "#6b8f71",
      purple:      "#9b8a6e",
    };

    const MONO = { fontFamily: "'JetBrains Mono', 'Fira Code', 'Cascadia Code', monospace" };
    const LABEL = { fontSize: 10, fontWeight: 700, color: T.textSecond, letterSpacing: "0.1em", textTransform: "uppercase" };
    const FIELD_LABEL = { fontSize: 10, fontWeight: 600, display: "block", marginBottom: 4, letterSpacing: "0.08em", color: T.textSecond };
    const FIELD_INPUT = { width: "100%", background: T.input, border: `1px solid ${T.border}`, borderRadius: 5, color: T.text, padding: "7px 10px", ...MONO, fontSize: 12 };
    const CARD = { background: T.card, border: `1px solid ${T.border}`, borderRadius: 8, padding: 16 };
    const BTN = { border: "none", borderRadius: 6, padding: "8px 18px", fontSize: 12, fontWeight: 600, cursor: "pointer", letterSpacing: "0.04em", transition: "all 0.15s ease" };
    const BTN_GOLD = { ...BTN, background: T.input, border: `1px solid ${T.borderGold}`, color: T.gold };
    const BTN_GOLD_ACTIVE = { ...BTN, background: T.gold, border: `1px solid ${T.gold}`, color: "#0d0b08" };

    const OVERLAY_STATES = {
      stopped: { label: "STOPPED", color: T.textSecond, bg: "rgba(140,122,92,0.1)" },
      starting: { label: "STARTING", color: T.amber, bg: "rgba(184,134,11,0.12)" },
      running: { label: "RUNNING", color: T.green, bg: "rgba(74,124,89,0.15)" },
      error: { label: "ERROR", color: T.red, bg: "rgba(168,50,50,0.12)" },
    };

    // -----------------------------------------------------------------------
    // Filter defaults (mirrors filter_updater.py STYLE_* constants)
    // -----------------------------------------------------------------------
    const DEFAULT_TIER_STYLES = {
      s: { font_size: 45, text_color: "#ff0000", border_color: "#ff0000", bg_color: "#ffffff", sound_enabled: true, sound_id: 6, beam_enabled: true, beam_color: "Red", minimap_enabled: true },
      a: { font_size: 45, text_color: "#ffffff", border_color: "#ffffff", bg_color: "#f5695a", sound_enabled: true, sound_id: 1, beam_enabled: true, beam_color: "Red", minimap_enabled: true },
      b: { font_size: 42, text_color: "#000000", border_color: "#000000", bg_color: "#f5695a", sound_enabled: true, sound_id: 2, beam_enabled: true, beam_color: "Yellow", minimap_enabled: true },
      c: { font_size: 38, text_color: "#000000", border_color: "#000000", bg_color: "#d2a050", sound_enabled: false, sound_id: 0, beam_enabled: false, beam_color: "Red", minimap_enabled: false },
      d: { font_size: 38, text_color: "#000000", border_color: "#000000", bg_color: "#d2a050", sound_enabled: false, sound_id: 0, beam_enabled: false, beam_color: "Red", minimap_enabled: false },
      e: { font_size: 32, text_color: "#c8c8c8", border_color: "#000000", bg_color: "#000000", sound_enabled: false, sound_id: 0, beam_enabled: false, beam_color: "Red", minimap_enabled: false },
      t1: { font_size: 45, text_color: "#ff0000", border_color: "#ff0000", bg_color: "#ffffff", sound_enabled: true, sound_id: 6, beam_enabled: true, beam_color: "Red", minimap_enabled: true },
      t2: { font_size: 45, text_color: "#ffffff", border_color: "#ffffff", bg_color: "#f5695a", sound_enabled: true, sound_id: 1, beam_enabled: true, beam_color: "Red", minimap_enabled: true },
      t3: { font_size: 38, text_color: "#bc6025", border_color: "#bc6025", bg_color: "#000000", sound_enabled: false, sound_id: 0, beam_enabled: true, beam_color: "Brown", minimap_enabled: true },
      hideable: { font_size: 32, text_color: "#c8c8c8", border_color: "#000000", bg_color: "#000000", sound_enabled: false, sound_id: 0, beam_enabled: false, beam_color: "Red", minimap_enabled: true },
    };

    // Gear style defaults per rarity (mirrors filter_updater.py STYLE_GEAR_*)
    const DEFAULT_GEAR_STYLES = {
      gear_rare:   { font_size: 28, text_color: "#dcc864", border_color: "#000000", bg_color: "#000000", sound_enabled: false, sound_id: 0, beam_enabled: false, beam_color: "Red", minimap_enabled: false },
      gear_magic:  { font_size: 28, text_color: "#8888ff", border_color: "#000000", bg_color: "#000000", sound_enabled: false, sound_id: 0, beam_enabled: false, beam_color: "Red", minimap_enabled: false },
      gear_normal: { font_size: 28, text_color: "#c8c8c8", border_color: "#000000", bg_color: "#000000", sound_enabled: false, sound_id: 0, beam_enabled: false, beam_color: "Red", minimap_enabled: false },
    };

    const GEAR_SECTIONS = [
      { id: "gear_rare", label: "Rare Gear" },
      { id: "gear_magic", label: "Magic Gear" },
      { id: "gear_normal", label: "Normal / Endgame Gear" },
    ];

    const GEAR_CLASSES = [
      { category: "Weapons", classes: [
        "Bows", "Crossbows", "One Hand Swords", "Two Hand Swords",
        "One Hand Axes", "Two Hand Axes", "One Hand Maces", "Two Hand Maces",
        "Daggers", "Claws", "Flails", "Spears", "Wands", "Staves", "Sceptres",
      ]},
      { category: "Armour", classes: [
        "Body Armours", "Helmets", "Gloves", "Boots",
        "Shields", "Bucklers", "Foci",
      ]},
      { category: "Accessories", classes: [
        "Rings", "Amulets", "Belts", "Quivers",
      ]},
    ];

    // Uniques shown in Gear card (not Economy)
    const UNIQUE_SECTION = { id: "uniques", label: "Uniques", tiers: ["t1", "t2", "t3", "hideable"], thresholdType: "unique" };

    const ECONOMY_SECTIONS = [
      { id: "currency", label: "Currency", tiers: ["s", "a", "b", "c", "d", "e"], thresholdType: "currency" },
      { id: "currency->emotions", label: "Distilled Emotions", tiers: ["s", "a", "b", "c", "d", "e"], thresholdType: "currency" },
      { id: "currency->catalysts", label: "Breach", tiers: ["s", "a", "b", "c", "d", "e"], thresholdType: "currency" },
      { id: "currency->essence", label: "Essences", tiers: ["s", "a", "b", "c", "d", "e"], thresholdType: "currency" },
      { id: "currency->omen", label: "Omens", tiers: ["s", "a", "b", "c", "d", "e"], thresholdType: "currency" },
      { id: "sockets->general", label: "Runes & Sockets", tiers: ["s", "a", "b", "c", "d", "e"], thresholdType: "currency" },
      { id: "fragments->generic", label: "Fragments", tiers: ["a", "b", "c"], thresholdType: "fragment" },
    ];

    // Base chaos thresholds (mirrors config.py FILTER_*_CHAOS_THRESHOLDS)
    const BASE_THRESHOLDS = {
      currency: { s: 25, a: 5, b: 2, c: 1, d: 1, e: 0 },
      unique:   { t1: 25, t2: 3, t3: 0.5, hideable: 0 },
      fragment: { a: 5, b: 1, c: 0 },
    };
    const STRICTNESS_MULT = { relaxed: 0.5, normal: 1.0, strict: 2.0, very_strict: 4.0 };

    function getEffectiveThreshold(tier, thresholdType, strictness) {
      const mult = STRICTNESS_MULT[strictness] || 1.0;
      const base = BASE_THRESHOLDS[thresholdType];
      if (!base || base[tier] === undefined) return null;
      return base[tier] * mult;
    }

    function formatChaos(val) {
      if (val === 0) return "all";
      if (val >= 1) return `≥${Math.round(val * 10) / 10}c`;
      return `≥${val.toFixed(1)}c`;
    }

    const TIER_LABELS = {
      s: "S Tier", a: "A Tier", b: "B Tier", c: "C Tier", d: "D Tier", e: "E Tier",
      t1: "T1", t2: "T2", t3: "T3", hideable: "Hideable",
    };

    const BEAM_COLORS = ["Red", "Yellow", "Blue", "Orange", "Brown"];
    const SOUND_IDS = Array.from({ length: 17 }, (_, i) => i);

    // Sample item names for style preview
    const TIER_PREVIEW_NAMES = {
      s: "Divine Orb", a: "Exalted Orb", b: "Chaos Orb",
      c: "Regal Orb", d: "Alchemy Orb", e: "Transmutation Orb",
      t1: "Headhunter", t2: "Goldrim", t3: "Unique Helm", hideable: "Cheap Unique",
      gear_rare: "Rare Vaal Axe", gear_magic: "Magic Corsair Sword", gear_normal: "Iron Hat",
    };

    // Sample items for strictness visualization (values chosen to shift tiers visibly)
    const STRICTNESS_SAMPLES = [
      { name: "Exalted Orb",  chaos: 30 },
      { name: "Regal Orb",    chaos: 8 },
      { name: "Chaos Orb",    chaos: 2.5 },
      { name: "Alchemy Orb",  chaos: 1.2 },
      { name: "Transmute",    chaos: 0.3 },
    ];

    function getTierForValue(chaosValue, strictness) {
      const mult = STRICTNESS_MULT[strictness] || 1.0;
      const t = BASE_THRESHOLDS.currency;
      if (chaosValue >= t.s * mult) return "s";
      if (chaosValue >= t.a * mult) return "a";
      if (chaosValue >= t.b * mult) return "b";
      if (chaosValue >= t.c * mult) return "c";
      return "e";
    }

    // -----------------------------------------------------------------------
    // Color presets (applied to tier styles on selection)
    // -----------------------------------------------------------------------
    const COLOR_PRESETS = {
      default: {
        label: "Default",
        desc: "Standard POE2 filter colors",
        tiers: {}, // empty = use DEFAULT_TIER_STYLES as-is
      },
      colorblind: {
        label: "Colorblind Safe",
        desc: "Blue-orange palette (deuteranopia/protanopia)",
        tiers: {
          s:  { text_color: "#ffffff", border_color: "#0066ff", bg_color: "#0055dd" },
          a:  { text_color: "#000000", border_color: "#ff8800", bg_color: "#ff8800" },
          b:  { text_color: "#ffffff", border_color: "#7733cc", bg_color: "#6633aa" },
          c:  { text_color: "#000000", border_color: "#ddbb00", bg_color: "#ddbb00" },
          d:  { text_color: "#ffffff", border_color: "#008888", bg_color: "#007777" },
          e:  { text_color: "#c8c8c8", border_color: "#000000", bg_color: "#000000" },
          t1: { text_color: "#ffffff", border_color: "#0066ff", bg_color: "#0055dd" },
          t2: { text_color: "#000000", border_color: "#ff8800", bg_color: "#ff8800" },
          t3: { text_color: "#bc6025", border_color: "#bc6025", bg_color: "#000000" },
          hideable: { text_color: "#c8c8c8", border_color: "#000000", bg_color: "#000000" },
        },
      },
      high_contrast: {
        label: "High Contrast",
        desc: "Maximum visibility for all tiers",
        tiers: {
          s:  { text_color: "#ffffff", border_color: "#ff0000", bg_color: "#cc0000" },
          a:  { text_color: "#000000", border_color: "#ffaa00", bg_color: "#ffaa00" },
          b:  { text_color: "#000000", border_color: "#00cc00", bg_color: "#00cc00" },
          c:  { text_color: "#ffffff", border_color: "#0088ff", bg_color: "#0066cc" },
          d:  { text_color: "#000000", border_color: "#cc66ff", bg_color: "#aa44dd" },
          e:  { text_color: "#999999", border_color: "#333333", bg_color: "#111111" },
          t1: { text_color: "#ffffff", border_color: "#ff0000", bg_color: "#cc0000" },
          t2: { text_color: "#000000", border_color: "#ffaa00", bg_color: "#ffaa00" },
          t3: { text_color: "#ffffff", border_color: "#0088ff", bg_color: "#0066cc" },
          hideable: { text_color: "#999999", border_color: "#333333", bg_color: "#111111" },
        },
      },
    };

    // Get effective tier style: preset base → user overrides on top
    function getEffectiveTierStyle(tier, tierStyles, colorPreset) {
      const presetColors = COLOR_PRESETS[colorPreset]?.tiers[tier] || {};
      return { ...DEFAULT_TIER_STYLES[tier], ...presetColors, ...(tierStyles[tier] || {}) };
    }

    // -----------------------------------------------------------------------
    // API helper
    // -----------------------------------------------------------------------
    async function api(path, method = "GET", body = null) {
      const opts = { method, headers: { "Content-Type": "application/json" } };
      if (body) opts.body = JSON.stringify(body);
      try {
        const res = await fetch(`${API_BASE}${path}`, opts);
        const raw = await res.text();
        let data = {};
        try { data = raw ? JSON.parse(raw) : {}; } catch { data = { raw }; }
        if (!res.ok) return { error: data?.error || data?.detail || `HTTP ${res.status}`, ...data };
        return data;
      } catch (e) {
        return { error: e.message };
      }
    }

    // -----------------------------------------------------------------------
    // WebSocket hook
    // -----------------------------------------------------------------------
    function useDashboardSocket(url, onMessage) {
      const wsRef = useRef(null);
      const [connected, setConnected] = useState(false);
      const reconnectRef = useRef(null);
      const disconnectTimerRef = useRef(null);
      const onMessageRef = useRef(onMessage);
      onMessageRef.current = onMessage;

      const connect = useCallback(() => {
        if (wsRef.current?.readyState === WebSocket.OPEN) return;
        const ws = new WebSocket(url);
        wsRef.current = ws;
        ws.onopen = () => {
          if (disconnectTimerRef.current) { clearTimeout(disconnectTimerRef.current); disconnectTimerRef.current = null; }
          setConnected(true);
          if (reconnectRef.current) { clearTimeout(reconnectRef.current); reconnectRef.current = null; }
        };
        ws.onmessage = (evt) => { try { onMessageRef.current(JSON.parse(evt.data)); } catch (e) { console.error("WS parse:", e); } };
        ws.onclose = () => {
          if (!disconnectTimerRef.current) {
            disconnectTimerRef.current = setTimeout(() => { setConnected(false); disconnectTimerRef.current = null; }, 800);
          }
          reconnectRef.current = setTimeout(connect, 2000);
        };
        ws.onerror = () => ws.close();
      }, [url]);

      useEffect(() => { connect(); return () => { wsRef.current?.close(); if (reconnectRef.current) clearTimeout(reconnectRef.current); if (disconnectTimerRef.current) clearTimeout(disconnectTimerRef.current); }; }, [connect]);
      return { connected };
    }

    // -----------------------------------------------------------------------
    // Time formatting
    // -----------------------------------------------------------------------
    function formatUptime(seconds) {
      if (!seconds || seconds <= 0) return "0s";
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      const s = seconds % 60;
      if (h > 0) return `${h}h ${m}m`;
      if (m > 0) return `${m}m ${s}s`;
      return `${s}s`;
    }

    // -----------------------------------------------------------------------
    // Gold Divider
    // -----------------------------------------------------------------------
    function GoldDivider({ style: extraStyle }) {
      return <div className="gold-divider" style={{ marginBottom: 20, ...extraStyle }} />;
    }

    // -----------------------------------------------------------------------
    // Flavor text constants
    // -----------------------------------------------------------------------
    const WATCHLIST_QUOTES = [
      "Still sane, Exile?",
      "The trade board awaits...",
      "Fortune favors the bold, Exile.",
      "What are you searching for?",
    ];
    const TAB_SUBTITLES = {
      overlay: "Your Eyes in Wraeclast",
      filter: "Separate Treasure from Trash",
      watchlist: "The Trade Board",
    };

    // -----------------------------------------------------------------------
    // Window Title Bar (frameless mode)
    // -----------------------------------------------------------------------
    function WindowTitleBar({ wsConnected, overlayState, onStart, onStop, onRestart }) {
      const minimize = () => window.pywebview?.api?.minimize();
      const toggleMax = () => window.pywebview?.api?.toggle_maximize();
      const close = () => window.pywebview?.api?.close();
      const st = OVERLAY_STATES[overlayState] || OVERLAY_STATES.stopped;
      const isRunning = overlayState === "running" || overlayState === "starting";

      return (
        <div className="window-titlebar pywebview-drag-region" style={{ height: 36 }}>
          <div style={{ fontSize: 13, fontWeight: 700, color: T.gold, textShadow: "0 0 12px rgba(196,164,86,0.3)" }}>
            POE2 Price Overlay
          </div>
          <div style={{ display: "flex", alignItems: "center", gap: 6, marginLeft: 10 }}>
            <div style={{
              display: "inline-flex", alignItems: "center", gap: 4,
              fontSize: 9, fontWeight: 600, color: wsConnected ? T.green : T.red,
            }}>
              <span style={{ width: 5, height: 5, borderRadius: "50%", background: wsConnected ? T.green : T.red, animation: wsConnected ? "none" : "pulse 1.5s infinite" }} />
              {wsConnected ? "Connected" : "Reconnecting"}
            </div>
            <div style={{
              display: "inline-flex", alignItems: "center", gap: 4,
              background: st.bg, borderRadius: 10, padding: "1px 8px",
              fontSize: 9, fontWeight: 700, color: st.color, letterSpacing: "0.04em",
            }}>
              <span style={{ width: 5, height: 5, borderRadius: "50%", background: st.color, animation: overlayState === "running" ? "pulse 2s infinite" : "none" }} />
              {st.label}
            </div>
          </div>
          <div style={{ flex: 1 }} />
          <div style={{ display: "flex", alignItems: "center", gap: 4, marginRight: 8 }}>
            {!isRunning ? (
              <button onClick={onStart} className="btn-gold-hover" style={{
                border: "none", borderRadius: 4, padding: "3px 12px", fontSize: 10, fontWeight: 600,
                cursor: "pointer", background: T.green, color: "#fff",
              }}>&#9654; Start</button>
            ) : (
              <button onClick={onStop} className="btn-danger-hover" style={{
                border: "none", borderRadius: 4, padding: "3px 12px", fontSize: 10, fontWeight: 600,
                cursor: "pointer", background: T.red, color: "#fff",
              }}>&#9632; Stop</button>
            )}
            <Tooltip text="Restart overlay">
              <button onClick={onRestart} disabled={!isRunning} style={{
                border: "none", borderRadius: 4, padding: "3px 8px", fontSize: 10, fontWeight: 600,
                cursor: isRunning ? "pointer" : "default",
                background: "transparent", color: isRunning ? T.textSecond : T.border,
              }}>&#8635;</button>
            </Tooltip>
          </div>
          <div style={{ display: "flex", gap: 0 }}>
            <button className="window-btn" onClick={minimize}>&#8211;</button>
            <button className="window-btn" onClick={toggleMax}>&#9633;</button>
            <button className="window-btn window-btn-close" onClick={close}>&#10005;</button>
          </div>
        </div>
      );
    }

    // Brand Footer
    // -----------------------------------------------------------------------
    function BrandFooter({ leagues, selectedLeague, onLeagueChange, onBugReport, onFeedback, onFeatureRequest, onRestartApp }) {
      const [flyoutOpen, setFlyoutOpen] = useState(false);
      const flyoutRef = useRef(null);

      useEffect(() => {
        if (!flyoutOpen) return;
        const handleClick = (e) => {
          if (flyoutRef.current && !flyoutRef.current.contains(e.target)) setFlyoutOpen(false);
        };
        document.addEventListener("mousedown", handleClick);
        return () => document.removeEventListener("mousedown", handleClick);
      }, [flyoutOpen]);

      return (
        <div className="app-footer" style={{ position: "relative" }} ref={flyoutRef}>
          <select
            value={selectedLeague || "Fate of the Vaal"}
            onChange={(e) => onLeagueChange(e.target.value)}
            style={{
              background: T.input, border: `1px solid ${T.border}`, borderRadius: 4,
              color: T.textSecond, padding: "3px 8px", fontSize: 10, ...MONO,
              appearance: "auto", cursor: "pointer",
            }}
          >
            {(leagues || []).map(lg => (
              <option key={lg.value} value={lg.value}>{lg.label}</option>
            ))}
          </select>
          <Tooltip text="Send bug report with logs to Discord">
            <button onClick={onBugReport} style={{
              background: "transparent", border: "none", color: T.textSecond,
              fontSize: 10, cursor: "pointer", padding: "2px 6px", letterSpacing: "0.04em",
              transition: "color 0.15s",
            }} onMouseEnter={e => e.target.style.color = T.amber} onMouseLeave={e => e.target.style.color = T.textSecond}>Bug Report</button>
          </Tooltip>
          <Tooltip text="Send us feedback or suggestions">
            <button onClick={onFeedback} style={{
              background: "transparent", border: "none", color: T.textSecond,
              fontSize: 10, cursor: "pointer", padding: "2px 6px", letterSpacing: "0.04em",
              transition: "color 0.15s",
            }} onMouseEnter={e => e.target.style.color = T.gold} onMouseLeave={e => e.target.style.color = T.textSecond}>Feedback</button>
          </Tooltip>
          <Tooltip text="Request a new feature">
            <button onClick={onFeatureRequest} style={{
              background: "transparent", border: "none", color: T.textSecond,
              fontSize: 10, cursor: "pointer", padding: "2px 6px", letterSpacing: "0.04em",
              transition: "color 0.15s",
            }} onMouseEnter={e => e.target.style.color = T.cyan} onMouseLeave={e => e.target.style.color = T.textSecond}>Feature Request</button>
          </Tooltip>
          <Tooltip text="Restart the entire app (server + overlay)">
            <button onClick={onRestartApp} style={{
              background: "transparent", border: "none", color: T.textSecond,
              fontSize: 10, cursor: "pointer", padding: "2px 6px", letterSpacing: "0.04em",
              transition: "color 0.15s",
            }} onMouseEnter={e => e.target.style.color = T.text} onMouseLeave={e => e.target.style.color = T.textSecond}>Restart App</button>
          </Tooltip>
          <div style={{ flex: 1 }} />
          <a className="footer-email" href="mailto:hello@couloir.gg">hello@couloir.gg</a>
          <span style={{ fontSize: 11, fontWeight: 800, color: "#5c4f3d", letterSpacing: "0.08em", textTransform: "uppercase" }}>
            Couloir
          </span>
          <img
            src="/img/couloir_avatar.png"
            alt="Couloir"
            onClick={() => setFlyoutOpen(!flyoutOpen)}
            style={{
              width: 22, height: 22, borderRadius: 4, cursor: "pointer",
              filter: flyoutOpen
                ? "sepia(0.3) saturate(1.5) brightness(1.0) hue-rotate(-5deg)"
                : "sepia(0.6) saturate(1.2) brightness(0.8) hue-rotate(-5deg)",
              opacity: flyoutOpen ? 1 : 0.7,
              transition: "filter 0.2s, opacity 0.2s",
            }}
          />
          {flyoutOpen && (
            <div className="couloir-flyout">
              {/* Header */}
              <div style={{ display: "flex", alignItems: "center", gap: 12, marginBottom: 14 }}>
                <img
                  src="/img/couloir_avatar.png"
                  alt="Couloir"
                  style={{
                    width: 40, height: 40, borderRadius: 6,
                    filter: "sepia(0.4) saturate(1.4) brightness(0.85) hue-rotate(-5deg)",
                  }}
                />
                <div>
                  <div style={{ fontSize: 15, fontWeight: 800, color: T.gold, letterSpacing: "0.06em" }}>
                    Who We Are
                  </div>
                  <div style={{ fontSize: 10, color: T.textMuted, marginTop: 1 }}>indie studio</div>
                </div>
              </div>

              {/* Divider */}
              <div style={{
                height: 1, margin: "0 0 14px",
                background: `linear-gradient(90deg, ${T.borderGold}, transparent)`,
              }} />

              {/* Body */}
              <div style={{ fontSize: 12, color: T.textSecond, lineHeight: 1.65 }}>
                <span style={{ color: T.gold }}>Couloir</span> is a small indie studio that builds
                open-source games, developer tools, and player-focused software. We believe the best software is free,
                transparent, and community-driven.
              </div>
              <div style={{ fontSize: 12, color: T.textSecond, lineHeight: 1.65, marginTop: 10 }}>
                This tool exists because we love this game, its community, and especially
                GGG — we know how hard it is to build games and ship every feature players
                want. We took the ideas we loved from other tools and put them in one place,
                for free. It's <span style={{ color: T.text, fontWeight: 600 }}>GPLv3</span> —
                the code is yours. Fork it, improve it, break it, whatever.
                No tracking, no telemetry, no third-party ads. <span style={{ color: T.text, fontWeight: 600 }}>Ever.</span>
              </div>
              <div style={{ fontSize: 12, color: T.textSecond, lineHeight: 1.65, marginTop: 10 }}>
                If it supports GGG's goals and helps players, we hit the mark. If it saves
                you time or currency, consider supporting us so we can keep building.
              </div>

              {/* Divider */}
              <div style={{
                height: 1, margin: "14px 0",
                background: `linear-gradient(90deg, ${T.borderGold}, transparent)`,
              }} />

              {/* Links */}
              <div style={{ display: "flex", flexDirection: "column", gap: 6, fontSize: 11 }}>
                <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
                  <span>&#9924;</span>
                  <span style={{ color: T.textSecond }}>Built by <span style={{ color: T.text, fontWeight: 600 }}>Cal Schuss</span> & friends</span>
                </div>
                <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
                  <span>&#9993;</span>
                  <a className="couloir-flyout-link" href="mailto:hello@couloir.gg">hello@couloir.gg</a>
                </div>
                <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
                  <span>&#127760;</span>
                  <a className="couloir-flyout-link" href="https://couloir.gg" target="_blank" rel="noopener noreferrer">couloir.gg</a>
                </div>
              </div>

              {/* Credits */}
              <div style={{
                height: 1, margin: "14px 0 10px",
                background: `linear-gradient(90deg, ${T.borderGold}, transparent)`,
              }} />
              <div style={{ fontSize: 10, color: T.textMuted, lineHeight: 1.6 }}>
                <div style={{ fontWeight: 600, color: T.textSecond, marginBottom: 4, letterSpacing: "0.06em", textTransform: "uppercase", fontSize: 9 }}>Thanks To</div>
                <span style={{ color: T.textSecond }}>GGG</span> for Path of Exile 2{" "}
                &middot; <span style={{ color: T.textSecond }}>poe.ninja</span> for market data{" "}
                &middot; <span style={{ color: T.textSecond }}>NeverSink</span> for filter foundations{" "}
                &middot; <span style={{ color: T.textSecond }}>RePoE</span> for mod tier data{" "}
                &middot; The POE2 community for testing & feedback
              </div>
            </div>
          )}
        </div>
      );
    }

    // Header
    // -----------------------------------------------------------------------
    function Header({ wsConnected, overlayState }) {
      const st = OVERLAY_STATES[overlayState] || OVERLAY_STATES.stopped;
      return (
        <div>
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", padding: "16px 0" }}>
            <div style={{ display: "flex", alignItems: "center", gap: 12 }}>
              <div style={{ fontSize: 18, fontWeight: 700, color: T.gold, textShadow: "0 0 12px rgba(196,164,86,0.3)" }}>POE2 Price Overlay</div>
              <div style={{
                display: "inline-flex", alignItems: "center", gap: 6,
                background: wsConnected ? "rgba(74,124,89,0.15)" : "rgba(168,50,50,0.1)",
                border: `1px solid ${wsConnected ? T.green + "44" : T.red + "44"}`,
                borderRadius: 20, padding: "3px 10px", fontSize: 10, fontWeight: 600,
                color: wsConnected ? T.green : T.red,
              }}>
                <span style={{ width: 6, height: 6, borderRadius: "50%", background: wsConnected ? T.green : T.red, animation: wsConnected ? "none" : "pulse 1.5s infinite" }} />
                {wsConnected ? "Connected" : "Reconnecting"}
              </div>
            </div>
            <div style={{
              display: "inline-flex", alignItems: "center", gap: 6,
              background: st.bg, border: `1px solid ${st.color}44`,
              borderRadius: 20, padding: "4px 14px", fontSize: 11, fontWeight: 700,
              color: st.color, letterSpacing: "0.06em",
            }}>
              <span style={{ width: 7, height: 7, borderRadius: "50%", background: st.color, animation: overlayState === "running" ? "pulse 2s infinite" : "none" }} />
              {st.label}
            </div>
          </div>
          <GoldDivider />
        </div>
      );
    }

    // -----------------------------------------------------------------------
    // Tooltip wrapper
    // -----------------------------------------------------------------------
    function Tooltip({ text, children }) {
      const [pos, setPos] = useState(null);
      const ref = useRef(null);

      const handleEnter = () => {
        if (ref.current) {
          const rect = ref.current.getBoundingClientRect();
          const above = rect.top > 50;
          setPos({
            left: rect.left + rect.width / 2,
            top: above ? rect.top - 6 : rect.bottom + 6,
            above,
          });
        }
      };

      return (
        <div ref={ref} onMouseEnter={handleEnter} onMouseLeave={() => setPos(null)} style={{ position: "relative" }}>
          {children}
          {pos && text && (
            <div style={{
              position: "fixed",
              left: pos.left,
              top: pos.above ? "auto" : pos.top,
              bottom: pos.above ? `calc(100vh - ${pos.top}px)` : "auto",
              transform: "translateX(-50%)",
              background: T.card, border: `1px solid ${T.borderGold}`, borderRadius: 6,
              padding: "6px 10px", fontSize: 11, color: T.textSecond, whiteSpace: "nowrap",
              zIndex: 9999, pointerEvents: "none",
              boxShadow: "0 4px 12px rgba(0,0,0,0.6)",
            }}>{text}</div>
          )}
        </div>
      );
    }

    // -----------------------------------------------------------------------
    // StatCard
    // -----------------------------------------------------------------------
    function CurrencyIcon({ src, size = 24 }) {
      return <img src={src} alt="" style={{ width: size, height: size, objectFit: "contain", imageRendering: "auto", verticalAlign: "middle" }} />;
    }

    function StatCard({ label, value, sub, color, tooltip, iconLeft, iconRight }) {
      const card = (
        <div className="panel" style={{ ...CARD, padding: 10, textAlign: "center", minWidth: 0 }}>
          <div style={{ ...LABEL, marginBottom: 4, fontSize: 9 }}>{label}</div>
          <div style={{ ...MONO, fontSize: 18, fontWeight: 700, color: color || T.text, lineHeight: 1.2, display: "flex", alignItems: "center", justifyContent: "center", gap: 5 }}>
            {iconLeft && <CurrencyIcon src={iconLeft} size={22} />}
            <span>{value}</span>
            {iconRight && <CurrencyIcon src={iconRight} size={22} />}
          </div>
          {sub && <div style={{ fontSize: 9, color: T.textMuted, marginTop: 2 }}>{sub}</div>}
        </div>
      );
      return tooltip ? <Tooltip text={tooltip}>{card}</Tooltip> : card;
    }

    // -----------------------------------------------------------------------
    // StatusPanel
    // -----------------------------------------------------------------------
    // Currency icon paths (served by /img/ endpoint)
    const ICON = {
      divine: "/img/divine_orb.png",
      exalted: "/img/exalted_orb.png",
      chaos: "/img/chaos_orb.png",
    };

    function StatusPanel({ status }) {
      const { stats, uptime, state } = status;
      const isRunning = state === "running";

      const d2c = stats.divine_to_chaos || 0;
      const d2e = stats.divine_to_exalted || 0;
      const e2c = d2e > 0 ? (d2c / d2e) : 0;
      const m2d = stats.mirror_to_divine || 0;
      const calSamples = stats.calibration_samples || 0;

      const refreshColor = stats.last_refresh === "never" ? T.textSecond : T.green;

      return (
        <div style={{ maxWidth: 1050, margin: "0 auto", padding: "0 24px" }}>
          {/* Market KPIs — compact single row */}
          <div style={{ display: "grid", gridTemplateColumns: "repeat(5, 1fr)", gap: 10, marginBottom: 8 }}>
            <StatCard label="1 Divine" value={d2e > 0 ? `${d2e.toFixed(0)}` : "--"} sub={d2e > 0 ? "Exalted" : null} color={T.gold} iconLeft={ICON.divine} iconRight={ICON.exalted} tooltip="1 Divine Orb = X Exalted Orbs" />
            <StatCard label="1 Divine" value={d2c > 0 ? `${d2c.toFixed(0)}` : "--"} sub={d2c > 0 ? "Chaos" : null} color={T.gold} iconLeft={ICON.divine} iconRight={ICON.chaos} tooltip="1 Divine Orb = X Chaos Orbs" />
            <StatCard label="1 Exalted" value={e2c > 0 ? `${e2c.toFixed(2)}` : "--"} sub={e2c > 0 ? "Chaos" : null} color={T.amber} iconLeft={ICON.exalted} iconRight={ICON.chaos} tooltip="1 Exalted Orb = X Chaos Orbs" />
            <StatCard label="1 Mirror" value={m2d > 0 ? `${m2d.toFixed(0)}` : "--"} sub={m2d > 0 ? "Divine" : null} color="#c084fc" iconRight={ICON.divine} tooltip="1 Mirror of Kalandra = X Divine Orbs" />
            <StatCard label="Last Refresh" value={stats.last_refresh === "never" ? "--" : stats.last_refresh} color={refreshColor} tooltip="When price data was last fetched (refreshes every 15 min)" />
          </div>
          {/* Health stats — compact inline strip */}
          <div style={{ display: "flex", alignItems: "center", gap: 16, marginBottom: 6, padding: "4px 0" }}>
            <Tooltip text="Number of item tooltips scanned via Ctrl+C">
              <span style={{ fontSize: 10, color: T.textMuted, ...MONO, cursor: "default" }}>Scans: <span style={{ color: T.textSecond, fontWeight: 600 }}>{stats.triggers}</span></span>
            </Tooltip>
            <Tooltip text="Percentage of scans that found a price">
              <span style={{ fontSize: 10, color: T.textMuted, ...MONO, cursor: "default" }}>Hit Rate: <span style={{ color: stats.success_rate >= 50 ? T.green : stats.success_rate > 0 ? T.amber : T.textSecond, fontWeight: 600 }}>{stats.success_rate}%</span></span>
            </Tooltip>
            <Tooltip text="Calibration data points for score-to-price estimation">
              <span style={{ fontSize: 10, color: T.textMuted, ...MONO, cursor: "default" }}>Calibration: <span style={{ color: calSamples >= 1000 ? T.green : calSamples > 0 ? T.amber : T.textSecond, fontWeight: 600 }}>{calSamples > 0 ? calSamples.toLocaleString() : "--"}</span></span>
            </Tooltip>
            <Tooltip text="Time since overlay was started">
              <span style={{ fontSize: 10, color: T.textMuted, ...MONO, cursor: "default" }}>Uptime: <span style={{ color: isRunning ? T.green : T.textSecond, fontWeight: 600 }}>{formatUptime(uptime)}</span></span>
            </Tooltip>
            <span style={{ marginLeft: "auto", fontSize: 9, color: T.textMuted, fontStyle: "italic" }}>
              Prices are estimates — always verify before trading
            </span>
          </div>
        </div>
      );
    }

    // -----------------------------------------------------------------------
    // Bug Report Modal
    // -----------------------------------------------------------------------
    function BugReportModal({ open, onClose }) {
      const [title, setTitle] = useState("");
      const [desc, setDesc] = useState("");
      const [sending, setSending] = useState(false);
      const [result, setResult] = useState(null);

      if (!open) return null;

      const handleSend = async () => {
        setSending(true);
        setResult(null);
        const res = await api("/api/bug-report", "POST", { title, description: desc });
        setSending(false);
        if (res.error) {
          setResult({ ok: false, msg: res.error });
        } else {
          setResult({ ok: true, msg: "Report sent!" });
          setTimeout(() => { onClose(); setTitle(""); setDesc(""); setResult(null); }, 1200);
        }
      };

      return (
        <div style={{
          position: "fixed", inset: 0, background: "rgba(0,0,0,0.7)", zIndex: 1000,
          display: "flex", alignItems: "center", justifyContent: "center",
        }} onClick={onClose}>
          <div style={{
            background: T.card, border: `1px solid ${T.borderGold}`, borderRadius: 10,
            padding: 24, width: 420, maxWidth: "90vw",
          }} onClick={e => e.stopPropagation()}>
            <div style={{ fontSize: 16, fontWeight: 700, marginBottom: 16, color: T.gold }}>Bug Report</div>

            <label style={FIELD_LABEL}>Title</label>
            <input
              value={title}
              onChange={e => setTitle(e.target.value)}
              placeholder="Brief summary..."
              style={{ ...FIELD_INPUT, marginBottom: 12 }}
              autoFocus
              onKeyDown={e => e.key === "Enter" && document.getElementById("bug-desc")?.focus()}
            />

            <label style={FIELD_LABEL}>What happened?</label>
            <textarea
              id="bug-desc"
              value={desc}
              onChange={e => setDesc(e.target.value)}
              placeholder="Describe the issue..."
              rows={4}
              style={{ ...FIELD_INPUT, resize: "vertical", marginBottom: 8 }}
              onKeyDown={e => { if (e.ctrlKey && e.key === "Enter") handleSend(); }}
            />

            <div style={{ fontSize: 10, color: T.textMuted, marginBottom: 16 }}>
              Logs + system info attached automatically. Sent to Discord.
            </div>

            {result && (
              <div style={{ fontSize: 12, fontWeight: 600, marginBottom: 12, color: result.ok ? T.green : T.red }}>
                {result.msg}
              </div>
            )}

            <div style={{ display: "flex", gap: 10, justifyContent: "flex-end" }}>
              <button onClick={onClose} style={{ ...BTN, background: T.input, border: `1px solid ${T.border}`, color: T.textSecond }}>Cancel</button>
              <button onClick={handleSend} disabled={sending} style={{
                ...BTN_GOLD_ACTIVE, opacity: sending ? 0.5 : 1,
              }}>{sending ? "Sending..." : "Send Report"}</button>
            </div>
          </div>
        </div>
      );
    }

    // -----------------------------------------------------------------------
    // Feedback Modal (feedback + feature requests → Discord)
    // -----------------------------------------------------------------------
    function FeedbackModal({ open, onClose, feedbackType }) {
      const [title, setTitle] = useState("");
      const [desc, setDesc] = useState("");
      const [sending, setSending] = useState(false);
      const [result, setResult] = useState(null);

      if (!open) return null;

      const isFeature = feedbackType === "feature";
      const heading = isFeature ? "Feature Request" : "Send Feedback";
      const placeholder = isFeature
        ? "Describe the feature you'd like to see..."
        : "Tell us what's on your mind...";

      const handleSend = async () => {
        setSending(true);
        setResult(null);
        const res = await api("/api/feedback", "POST", { type: feedbackType, title, description: desc });
        setSending(false);
        if (res.error) {
          setResult({ ok: false, msg: res.error });
        } else {
          setResult({ ok: true, msg: isFeature ? "Request submitted!" : "Feedback sent!" });
          setTimeout(() => { onClose(); setTitle(""); setDesc(""); setResult(null); }, 1200);
        }
      };

      return (
        <div style={{
          position: "fixed", inset: 0, background: "rgba(0,0,0,0.7)", zIndex: 1000,
          display: "flex", alignItems: "center", justifyContent: "center",
        }} onClick={onClose}>
          <div style={{
            background: T.card, border: `1px solid ${T.borderGold}`, borderRadius: 10,
            padding: 24, width: 420, maxWidth: "90vw",
          }} onClick={e => e.stopPropagation()}>
            <div style={{ fontSize: 16, fontWeight: 700, marginBottom: 16, color: isFeature ? T.cyan : T.gold }}>
              {heading}
            </div>

            <label style={FIELD_LABEL}>Title</label>
            <input
              value={title}
              onChange={e => setTitle(e.target.value)}
              placeholder={isFeature ? "Feature name..." : "Brief summary..."}
              style={{ ...FIELD_INPUT, marginBottom: 12 }}
              autoFocus
              onKeyDown={e => e.key === "Enter" && document.getElementById("feedback-desc")?.focus()}
            />

            <label style={FIELD_LABEL}>{isFeature ? "What would this do?" : "Details"}</label>
            <textarea
              id="feedback-desc"
              value={desc}
              onChange={e => setDesc(e.target.value)}
              placeholder={placeholder}
              rows={4}
              style={{ ...FIELD_INPUT, resize: "vertical", marginBottom: 8 }}
              onKeyDown={e => { if (e.ctrlKey && e.key === "Enter") handleSend(); }}
            />

            <div style={{ fontSize: 10, color: T.textMuted, marginBottom: 16 }}>
              Sent to our Discord. We read everything.
            </div>

            {result && (
              <div style={{ fontSize: 12, fontWeight: 600, marginBottom: 12, color: result.ok ? T.green : T.red }}>
                {result.msg}
              </div>
            )}

            <div style={{ display: "flex", gap: 10, justifyContent: "flex-end" }}>
              <button onClick={onClose} style={{ ...BTN, background: T.input, border: `1px solid ${T.border}`, color: T.textSecond }}>Cancel</button>
              <button onClick={handleSend} disabled={sending || !title.trim()} style={{
                ...BTN_GOLD_ACTIVE, opacity: (sending || !title.trim()) ? 0.5 : 1,
              }}>{sending ? "Sending..." : "Submit"}</button>
            </div>
          </div>
        </div>
      );
    }

    // -----------------------------------------------------------------------
    // ControlBar (legacy — controls now in title bar + footer)
    // -----------------------------------------------------------------------
    function ControlBar({ overlayState, settings, leagues, onStart, onStop, onRestart, onLeagueChange, onBugReport, onRestartApp }) {
      const isRunning = overlayState === "running" || overlayState === "starting";
      const selectedLeague = settings.league || "Fate of the Vaal";

      return (
        <div className="panel" style={{ ...CARD, display: "flex", alignItems: "center", gap: 12, marginBottom: 20, flexWrap: "wrap" }}>
          <button
            onClick={onStart}
            disabled={isRunning}
            className={!isRunning ? "btn-gold-hover" : ""}
            style={{
              ...BTN,
              background: isRunning ? T.input : T.green,
              color: isRunning ? T.textMuted : "#fff",
              cursor: isRunning ? "default" : "pointer",
              border: `1px solid ${isRunning ? T.border : T.green}`,
            }}
          >Start</button>
          <button
            onClick={onStop}
            disabled={!isRunning}
            className={isRunning ? "btn-danger-hover" : ""}
            style={{
              ...BTN,
              background: !isRunning ? T.input : T.red,
              color: !isRunning ? T.textMuted : "#fff",
              cursor: !isRunning ? "default" : "pointer",
              border: `1px solid ${!isRunning ? T.border : T.red}`,
            }}
          >Stop</button>
          <button
            onClick={onRestart}
            disabled={!isRunning}
            style={{
              ...BTN,
              background: !isRunning ? T.input : "transparent",
              color: !isRunning ? T.textMuted : T.gold,
              cursor: !isRunning ? "default" : "pointer",
              border: `1px solid ${!isRunning ? T.border : T.borderGold}`,
            }}
          >Restart</button>

          <div style={{ width: 1, height: 24, background: T.border }} />

          <Tooltip text="Send a bug report with logs to Discord">
            <button
              onClick={onBugReport}
              className="btn-gold-hover"
              style={{ ...BTN, background: T.amber, color: "#000", border: `1px solid ${T.amber}` }}
            >Report Bug</button>
          </Tooltip>

          <Tooltip text="Restart the entire app (server + overlay)">
            <button
              onClick={onRestartApp}
              style={{ ...BTN, background: "transparent", color: T.textSecond, border: `1px solid ${T.border}` }}
            >Restart App</button>
          </Tooltip>

          <div style={{ marginLeft: "auto", display: "flex", alignItems: "center", gap: 8 }}>
            <span style={{ ...LABEL, marginBottom: 0 }}>League</span>
            <select
              value={selectedLeague}
              onChange={(e) => onLeagueChange(e.target.value)}
              style={{
                ...FIELD_INPUT, width: "auto", minWidth: 180, padding: "6px 10px",
                appearance: "auto",
              }}
            >
              {leagues.map(lg => (
                <option key={lg.value} value={lg.value}>{lg.label}</option>
              ))}
            </select>
          </div>
        </div>
      );
    }

    // -----------------------------------------------------------------------
    // TabBar
    // -----------------------------------------------------------------------
    function TabBar({ activeTab, onTabChange }) {
      const tabs = [
        { id: "overlay", label: "Overlay" },
        { id: "filter", label: "Loot Filter" },
        { id: "watchlist", label: "Watchlist" },
      ];

      return (
        <div style={{ display: "flex", gap: 2, marginBottom: 0, borderBottom: `1px solid ${T.border}` }}>
          {tabs.map(tab => {
            const active = activeTab === tab.id;
            return (
              <button
                key={tab.id}
                className={`poe-tab ${active ? "poe-tab-active" : ""}`}
                onClick={() => onTabChange(tab.id)}
                style={{
                  background: active ? "rgba(196,164,86,0.15)" : "transparent",
                  border: "none",
                  color: active ? T.gold : T.textSecond,
                  padding: "10px 24px 8px", fontSize: 13, fontWeight: 600,
                  cursor: "pointer", letterSpacing: "0.04em",
                  borderRadius: "6px 6px 0 0",
                }}
              >
                <div>{tab.label}</div>
                <div style={{ fontSize: 8, color: active ? T.textSecond : T.textMuted, marginTop: 2, fontWeight: 400, letterSpacing: "0.06em" }}>
                  {TAB_SUBTITLES[tab.id]}
                </div>
              </button>
            );
          })}
        </div>
      );
    }

    // -----------------------------------------------------------------------
    // OverlaySettingsTab (consolidated overlay + detection settings)
    // -----------------------------------------------------------------------
    function OverlaySettingsTab({ settings, onUpdate, overlayState }) {
      const isRunning = overlayState === "running";

      const Field = ({ label, field, type = "number", step, min, max, helpText }) => (
        <div>
          <label style={FIELD_LABEL}>{label}</label>
          <input
            type={type}
            value={settings[field] ?? ""}
            onChange={(e) => {
              const val = type === "number" ? parseFloat(e.target.value) : e.target.value;
              onUpdate({ [field]: val });
            }}
            step={step}
            min={min}
            max={max}
            style={FIELD_INPUT}
          />
          {helpText && <div style={{ fontSize: 10, color: T.textMuted, marginTop: 3 }}>{helpText}</div>}
        </div>
      );

      return (
        <div style={{ marginTop: 12, marginBottom: 12 }}>
          {/* Toggles row */}
          <div style={{ display: "flex", alignItems: "center", gap: 20, marginBottom: 12 }}>
            <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
              <Toggle value={settings.auto_start !== false} onChange={(v) => onUpdate({ auto_start: v })} size="small" />
              <span style={{ fontSize: 11, color: T.textSecond }}>Auto-start overlay on launch</span>
            </div>
            {isRunning && (
              <span style={{ fontSize: 10, color: T.amber, fontWeight: 500, marginLeft: "auto" }}>
                Restart to apply setting changes
              </span>
            )}
          </div>
          {/* Display & Detection settings — two grouped columns */}
          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 12 }}>
            <div className="panel" style={{ ...CARD, padding: 12 }}>
              <div style={{ ...LABEL, marginBottom: 8 }}>Display</div>
              <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "10px 16px" }}>
                <Field label="Font Size" field="font_size" min={8} max={24} step={1} helpText="Text size (px)" />
                <Field label="Duration" field="overlay_duration" min={0.5} max={10} step={0.5} helpText="Seconds shown" />
              </div>
            </div>
            <div className="panel" style={{ ...CARD, padding: 12 }}>
              <div style={{ ...LABEL, marginBottom: 8 }}>Detection</div>
              <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "10px 16px" }}>
                <Field label="Scan FPS" field="scan_fps" min={1} max={30} step={1} helpText="Checks per second" />
                <Field label="Cooldown" field="detection_cooldown" min={0.1} max={5} step={0.1} helpText="Seconds between" />
                <Field label="Still Radius" field="cursor_still_radius" min={5} max={50} step={1} helpText="Max px movement" />
                <Field label="Still Frames" field="cursor_still_frames" min={1} max={10} step={1} helpText="Frames to wait" />
              </div>
            </div>
          </div>
        </div>
      );
    }

    // -----------------------------------------------------------------------
    // StrictnessSelector
    // -----------------------------------------------------------------------
    function StrictnessSelector({ value, onChange, colorPreset, tierStyles }) {
      const presets = [
        { id: "relaxed", label: "Relaxed", desc: "Show more items" },
        { id: "normal", label: "Normal", desc: "Default" },
        { id: "strict", label: "Strict", desc: "Higher value only" },
        { id: "very_strict", label: "Very Strict", desc: "Top items only" },
      ];

      return (
        <div style={{ marginBottom: 20 }}>
          <div style={{ ...LABEL, marginBottom: 10 }}>Strictness</div>
          <div style={{ display: "flex", gap: 8 }}>
            {presets.map(p => {
              const active = value === p.id;
              return (
                <button
                  key={p.id}
                  onClick={() => onChange(p.id)}
                  style={{
                    ...BTN,
                    flex: 1,
                    background: active ? T.gold : T.input,
                    color: active ? "#0d0b08" : T.textSecond,
                    border: `1px solid ${active ? T.gold : T.border}`,
                    padding: "8px 12px",
                  }}
                >
                  <div style={{ fontWeight: 600, fontSize: 12 }}>{p.label}</div>
                  <div style={{ fontSize: 9, opacity: 0.7, marginTop: 2 }}>{p.desc}</div>
                </button>
              );
            })}
          </div>

          {/* Dynamic sample items — items shift tiers as strictness changes */}
          <div style={{
            marginTop: 12, padding: "10px 14px",
            background: T.input, border: `1px solid ${T.border}`, borderRadius: 6,
          }}>
            <div style={{ fontSize: 9, color: T.textMuted, letterSpacing: "0.08em", textTransform: "uppercase", marginBottom: 8 }}>
              How items are classified at {presets.find(p => p.id === value)?.label || "Normal"}
            </div>
            <div style={{ display: "flex", gap: 12, flexWrap: "wrap" }}>
              {STRICTNESS_SAMPLES.map(item => {
                const tier = getTierForValue(item.chaos, value);
                const s = getEffectiveTierStyle(tier, tierStyles || {}, colorPreset || "default");
                const scaledFont = Math.max(9, Math.round(s.font_size * 0.32));
                return (
                  <div key={item.name} style={{ display: "flex", flexDirection: "column", alignItems: "center", gap: 2 }}>
                    <div style={{
                      display: "inline-flex", alignItems: "center",
                      padding: "1px 8px",
                      backgroundColor: s.bg_color || "#000",
                      border: `2px solid ${s.border_color || "#000"}`,
                      borderRadius: 2,
                      color: s.text_color || "#fff",
                      fontSize: scaledFont,
                      fontWeight: 600,
                      fontFamily: "'JetBrains Mono', monospace",
                      whiteSpace: "nowrap", lineHeight: 1.4,
                      transition: "all 0.2s ease",
                    }}>{item.name}</div>
                    <div style={{ display: "flex", gap: 4, alignItems: "center" }}>
                      <span style={{ fontSize: 9, color: T.gold, fontWeight: 600 }}>{TIER_LABELS[tier]}</span>
                      <span style={{ fontSize: 9, color: T.textMuted, ...MONO, display: "inline-flex", alignItems: "center", gap: 1 }}>~{item.chaos}<CurrencyIcon src={ICON.chaos} size={9} /></span>
                    </div>
                  </div>
                );
              })}
            </div>

            {/* Threshold reference row */}
            <div style={{ display: "flex", gap: 8, flexWrap: "wrap", marginTop: 10, paddingTop: 8, borderTop: `1px solid ${T.border}33` }}>
              {["s", "a", "b", "c", "e"].map(tier => {
                const threshold = getEffectiveThreshold(tier, "currency", value);
                return (
                  <span key={tier} style={{ fontSize: 9, color: T.textMuted, ...MONO, display: "inline-flex", alignItems: "center", gap: 2 }}>
                    {TIER_LABELS[tier]}: {threshold === 0 ? "all" : (<><CurrencyIcon src={ICON.chaos} size={11} /> {formatChaos(threshold).replace(/^≥/, "")}</>)}
                  </span>
                );
              })}
            </div>
          </div>
        </div>
      );
    }

    // -----------------------------------------------------------------------
    // Toggle component (reusable)
    // -----------------------------------------------------------------------
    function Toggle({ value, onChange, size = "normal" }) {
      const w = size === "small" ? 28 : 36;
      const h = size === "small" ? 16 : 20;
      const dot = size === "small" ? 12 : 16;
      const goldDot = size === "small" ? 4 : 5;
      return (
        <div
          onClick={() => onChange(!value)}
          style={{
            width: w, height: h, borderRadius: h / 2, cursor: "pointer",
            background: value ? T.gold : T.border,
            position: "relative", transition: "background 0.2s",
            flexShrink: 0,
          }}
        >
          <div style={{
            width: dot, height: dot, borderRadius: "50%", background: T.text,
            position: "absolute", top: (h - dot) / 2,
            left: value ? w - dot - (h - dot) / 2 : (h - dot) / 2,
            transition: "left 0.2s",
            display: "flex", alignItems: "center", justifyContent: "center",
          }}>
            {value && <div style={{ width: goldDot, height: goldDot, borderRadius: "50%", background: T.gold }} />}
          </div>
        </div>
      );
    }

    // -----------------------------------------------------------------------
    // StylePreview — mimics a POE2 ground label with current style settings
    // -----------------------------------------------------------------------
    function StylePreview({ style: s, label }) {
      // Scale font: filter uses 18-45, preview scales to ~40% for compact display
      const scaledFont = Math.max(9, Math.round(s.font_size * 0.38));

      return (
        <div style={{ display: "flex", flexDirection: "column", alignItems: "flex-start", gap: 3 }}>
          <div style={{
            display: "inline-flex", alignItems: "center",
            padding: "1px 8px",
            backgroundColor: s.bg_color || "#000",
            border: `2px solid ${s.border_color || "#000"}`,
            borderRadius: 2,
            color: s.text_color || "#fff",
            fontSize: scaledFont,
            fontWeight: 600,
            fontFamily: "'JetBrains Mono', monospace",
            whiteSpace: "nowrap",
            lineHeight: 1.4,
            minWidth: 60,
          }}>
            {label}
          </div>
          <div style={{ display: "flex", gap: 4, alignItems: "center", height: 12 }}>
            {s.sound_enabled && (
              <Tooltip text={`Sound #${s.sound_id}`}>
                <span style={{ fontSize: 10, cursor: "default" }}>&#128264;</span>
              </Tooltip>
            )}
            {s.beam_enabled && (
              <Tooltip text={`${s.beam_color} beam`}>
                <span style={{
                  display: "inline-block", width: 3, height: 10, borderRadius: 1,
                  background: s.beam_color === "Red" ? "#ff4444" : s.beam_color === "Yellow" ? "#ffdd44" :
                    s.beam_color === "Blue" ? "#4488ff" : s.beam_color === "Orange" ? "#ff8844" :
                    s.beam_color === "Brown" ? "#aa7744" : "#888",
                  boxShadow: `0 0 4px ${s.beam_color === "Red" ? "#ff4444" : s.beam_color === "Yellow" ? "#ffdd44" :
                    s.beam_color === "Blue" ? "#4488ff" : s.beam_color === "Orange" ? "#ff8844" :
                    s.beam_color === "Brown" ? "#aa7744" : "#888"}`,
                }} />
              </Tooltip>
            )}
            {s.minimap_enabled && (
              <Tooltip text="Minimap icon">
                <span style={{ fontSize: 8, color: T.textSecond }}>&#9670;</span>
              </Tooltip>
            )}
          </div>
        </div>
      );
    }

    // -----------------------------------------------------------------------
    // TierRow — per-tier controls within a section accordion
    // -----------------------------------------------------------------------
    function TierRow({ tier, style: tierStyle, onChange, thresholdType, strictness, colorPreset }) {
      const s = getEffectiveTierStyle(tier, { [tier]: tierStyle }, colorPreset || "default");

      const updateField = (field, val) => {
        onChange({ ...tierStyle, [field]: val });
      };

      const threshold = thresholdType ? getEffectiveThreshold(tier, thresholdType, strictness || "normal") : null;
      const cellStyle = { display: "flex", alignItems: "center", gap: 6, minWidth: 0 };
      const miniLabel = { fontSize: 9, color: T.textMuted, letterSpacing: "0.05em", textTransform: "uppercase" };

      return (
        <div style={{
          display: "grid",
          gridTemplateColumns: "55px minmax(80px, auto) 60px 1fr 1fr 1fr 50px",
          gap: 10, alignItems: "center",
          padding: "8px 0",
          borderBottom: `1px solid ${T.border}22`,
        }}>
          {/* Tier label + threshold */}
          <div>
            <div style={{ fontWeight: 600, fontSize: 12, color: T.gold }}>{TIER_LABELS[tier] || tier}</div>
            {threshold !== null && (
              <div style={{ fontSize: 9, color: T.textMuted, ...MONO, display: "flex", alignItems: "center", gap: 2 }}>
                {threshold === 0 ? "all" : (<><CurrencyIcon src={ICON.chaos} size={10} /> {formatChaos(threshold).replace(/^≥/, "")}</>)}
              </div>
            )}
          </div>

          {/* Preview */}
          <StylePreview style={s} label={TIER_PREVIEW_NAMES[tier] || "Item"} />

          {/* Font size */}
          <div>
            <input
              type="number" min={18} max={45} value={s.font_size}
              onChange={e => updateField("font_size", parseInt(e.target.value) || 32)}
              style={{ ...FIELD_INPUT, width: 52, padding: "4px 6px", fontSize: 11, textAlign: "center" }}
            />
          </div>

          {/* Sound */}
          <div style={cellStyle}>
            <Toggle size="small" value={s.sound_enabled} onChange={v => updateField("sound_enabled", v)} />
            <select
              value={s.sound_id}
              onChange={e => updateField("sound_id", parseInt(e.target.value))}
              disabled={!s.sound_enabled}
              style={{ ...FIELD_INPUT, width: 52, padding: "3px 4px", fontSize: 10, opacity: s.sound_enabled ? 1 : 0.4 }}
            >
              {SOUND_IDS.map(id => <option key={id} value={id}>#{id}</option>)}
            </select>
            <span style={miniLabel}>Sound</span>
          </div>

          {/* Beam */}
          <div style={cellStyle}>
            <Toggle size="small" value={s.beam_enabled} onChange={v => updateField("beam_enabled", v)} />
            <select
              value={s.beam_color}
              onChange={e => updateField("beam_color", e.target.value)}
              disabled={!s.beam_enabled}
              style={{ ...FIELD_INPUT, width: 70, padding: "3px 4px", fontSize: 10, opacity: s.beam_enabled ? 1 : 0.4 }}
            >
              {BEAM_COLORS.map(c => <option key={c} value={c}>{c}</option>)}
            </select>
            <span style={miniLabel}>Beam</span>
          </div>

          {/* Colors */}
          <div style={{ display: "flex", gap: 4, alignItems: "center" }}>
            <Tooltip text="Text color">
              <input type="color" value={s.text_color} onChange={e => updateField("text_color", e.target.value)}
                style={{ width: 24, height: 24, border: `1px solid ${T.border}`, borderRadius: 3, cursor: "pointer", padding: 0, background: "transparent" }} />
            </Tooltip>
            <Tooltip text="Border color">
              <input type="color" value={s.border_color} onChange={e => updateField("border_color", e.target.value)}
                style={{ width: 24, height: 24, border: `1px solid ${T.border}`, borderRadius: 3, cursor: "pointer", padding: 0, background: "transparent" }} />
            </Tooltip>
            <Tooltip text="Background color">
              <input type="color" value={s.bg_color} onChange={e => updateField("bg_color", e.target.value)}
                style={{ width: 24, height: 24, border: `1px solid ${T.border}`, borderRadius: 3, cursor: "pointer", padding: 0, background: "transparent" }} />
            </Tooltip>
            <span style={miniLabel}>Colors</span>
          </div>

          {/* Minimap */}
          <div style={{ display: "flex", alignItems: "center", gap: 4 }}>
            <Toggle size="small" value={s.minimap_enabled} onChange={v => updateField("minimap_enabled", v)} />
            <span style={miniLabel}>Map</span>
          </div>
        </div>
      );
    }

    // -----------------------------------------------------------------------
    // SectionRow — accordion for one economy category
    // -----------------------------------------------------------------------
    function SectionRow({ section, visible, tierStyles, onVisibilityChange, onTierStyleChange, strictness, colorPreset }) {
      const [expanded, setExpanded] = useState(false);

      return (
        <div className={expanded ? "accordion-expanded" : ""} style={{ border: `1px solid ${T.border}`, borderRadius: 6, marginBottom: 8, overflow: "hidden", transition: "border-color 0.2s" }}>
          {/* Header row */}
          <div
            style={{
              display: "flex", alignItems: "center", gap: 10, padding: "10px 14px",
              background: expanded ? T.input : "transparent",
              cursor: "pointer", userSelect: "none",
            }}
            onClick={() => setExpanded(!expanded)}
          >
            <Toggle size="small" value={visible !== false}
              onChange={(v) => { onVisibilityChange(v); }}
            />
            <div style={{ flex: 1, fontWeight: 600, fontSize: 13, color: visible !== false ? T.text : T.textMuted }}>
              {section.label}
            </div>
            <div style={{ fontSize: 10, color: T.textMuted }}>{section.tiers.length} tiers</div>
            <div style={{
              fontSize: 11, color: T.textSecond,
              transform: expanded ? "rotate(180deg)" : "rotate(0deg)",
              transition: "transform 0.15s",
            }}>&#9660;</div>
          </div>

          {/* Expanded tier controls */}
          {expanded && (
            <div style={{ padding: "4px 14px 10px", borderTop: `1px solid ${T.border}` }}>
              {/* Column headers */}
              <div style={{
                display: "grid",
                gridTemplateColumns: "55px minmax(80px, auto) 60px 1fr 1fr 1fr 50px",
                gap: 10, padding: "4px 0 6px",
                fontSize: 9, color: T.textMuted, letterSpacing: "0.08em", textTransform: "uppercase",
              }}>
                <div>Tier</div>
                <div>Preview</div>
                <div>Font</div>
                <div>Sound</div>
                <div>Beam</div>
                <div>Colors</div>
                <div>Map</div>
              </div>

              {section.tiers.map(tier => (
                <TierRow
                  key={tier}
                  tier={tier}
                  style={tierStyles[tier] || {}}
                  onChange={(newStyle) => onTierStyleChange(tier, newStyle)}
                  thresholdType={section.thresholdType}
                  strictness={strictness}
                  colorPreset={colorPreset}
                />
              ))}
            </div>
          )}
        </div>
      );
    }

    // -----------------------------------------------------------------------
    // GearRow — accordion with style controls + per-class toggles
    // -----------------------------------------------------------------------
    function GearRow({ section, visible, style: gearStyle, classVisibility, onVisibilityChange, onStyleChange, onClassToggle }) {
      const [expanded, setExpanded] = useState(false);
      const s = { ...(DEFAULT_GEAR_STYLES[section.id] || DEFAULT_GEAR_STYLES.gear_rare), ...gearStyle };

      const updateField = (field, val) => {
        onStyleChange({ ...gearStyle, [field]: val });
      };

      const cellStyle = { display: "flex", alignItems: "center", gap: 6, minWidth: 0 };
      const miniLabel = { fontSize: 9, color: T.textMuted, letterSpacing: "0.05em", textTransform: "uppercase" };

      const hiddenCount = GEAR_CLASSES.reduce((sum, cat) =>
        sum + cat.classes.filter(c => classVisibility[c] === false).length, 0);

      return (
        <div className={expanded ? "accordion-expanded" : ""} style={{ border: `1px solid ${T.border}`, borderRadius: 6, marginBottom: 8, overflow: "hidden", transition: "border-color 0.2s" }}>
          {/* Header row */}
          <div
            style={{
              display: "flex", alignItems: "center", gap: 10, padding: "10px 14px",
              background: expanded ? T.input : "transparent",
              cursor: "pointer", userSelect: "none",
            }}
            onClick={() => setExpanded(!expanded)}
          >
            <div onClick={e => e.stopPropagation()}>
              <Toggle size="small" value={visible !== false}
                onChange={(v) => onVisibilityChange(v)} />
            </div>
            <div style={{ fontWeight: 600, fontSize: 13, color: visible !== false ? T.text : T.textMuted, minWidth: 160 }}>
              {section.label}
            </div>
            {hiddenCount > 0 && (
              <div style={{ fontSize: 10, color: T.amber, fontWeight: 500 }}>
                {hiddenCount} class{hiddenCount > 1 ? "es" : ""} hidden
              </div>
            )}
            <div style={{ flex: 1 }} />
            <div style={{
              fontSize: 11, color: T.textSecond,
              transform: expanded ? "rotate(180deg)" : "rotate(0deg)",
              transition: "transform 0.15s",
            }}>&#9660;</div>
          </div>

          {/* Expanded content */}
          {expanded && (
            <div style={{ borderTop: `1px solid ${T.border}`, padding: "12px 14px" }}>
              {/* Style controls row */}
              <div style={{
                display: "grid",
                gridTemplateColumns: "minmax(80px, auto) 60px 1fr 1fr 1fr 50px",
                gap: 10, alignItems: "center",
                padding: "0 0 12px",
                borderBottom: `1px solid ${T.border}22`,
                marginBottom: 12,
              }}>
                <div>
                  <div style={miniLabel}>Preview</div>
                  <StylePreview style={s} label={TIER_PREVIEW_NAMES[section.id] || "Item"} />
                </div>
                <div>
                  <div style={miniLabel}>Font</div>
                  <input
                    type="number" min={18} max={45} value={s.font_size}
                    onChange={e => updateField("font_size", parseInt(e.target.value) || 28)}
                    style={{ ...FIELD_INPUT, width: 52, padding: "4px 6px", fontSize: 11, textAlign: "center" }}
                  />
                </div>

                <div style={cellStyle}>
                  <Toggle size="small" value={s.sound_enabled} onChange={v => updateField("sound_enabled", v)} />
                  <select
                    value={s.sound_id}
                    onChange={e => updateField("sound_id", parseInt(e.target.value))}
                    disabled={!s.sound_enabled}
                    style={{ ...FIELD_INPUT, width: 52, padding: "3px 4px", fontSize: 10, opacity: s.sound_enabled ? 1 : 0.4 }}
                  >
                    {SOUND_IDS.map(id => <option key={id} value={id}>#{id}</option>)}
                  </select>
                  <span style={miniLabel}>Sound</span>
                </div>

                <div style={cellStyle}>
                  <Toggle size="small" value={s.beam_enabled} onChange={v => updateField("beam_enabled", v)} />
                  <select
                    value={s.beam_color}
                    onChange={e => updateField("beam_color", e.target.value)}
                    disabled={!s.beam_enabled}
                    style={{ ...FIELD_INPUT, width: 70, padding: "3px 4px", fontSize: 10, opacity: s.beam_enabled ? 1 : 0.4 }}
                  >
                    {BEAM_COLORS.map(c => <option key={c} value={c}>{c}</option>)}
                  </select>
                  <span style={miniLabel}>Beam</span>
                </div>

                <div style={{ display: "flex", gap: 4, alignItems: "center" }}>
                  <Tooltip text="Text color">
                    <input type="color" value={s.text_color} onChange={e => updateField("text_color", e.target.value)}
                      style={{ width: 24, height: 24, border: `1px solid ${T.border}`, borderRadius: 3, cursor: "pointer", padding: 0, background: "transparent" }} />
                  </Tooltip>
                  <Tooltip text="Border color">
                    <input type="color" value={s.border_color} onChange={e => updateField("border_color", e.target.value)}
                      style={{ width: 24, height: 24, border: `1px solid ${T.border}`, borderRadius: 3, cursor: "pointer", padding: 0, background: "transparent" }} />
                  </Tooltip>
                  <Tooltip text="Background color">
                    <input type="color" value={s.bg_color} onChange={e => updateField("bg_color", e.target.value)}
                      style={{ width: 24, height: 24, border: `1px solid ${T.border}`, borderRadius: 3, cursor: "pointer", padding: 0, background: "transparent" }} />
                  </Tooltip>
                </div>

                <div style={{ display: "flex", alignItems: "center", gap: 4 }}>
                  <Toggle size="small" value={s.minimap_enabled} onChange={v => updateField("minimap_enabled", v)} />
                  <span style={miniLabel}>Map</span>
                </div>
              </div>

              {/* Per-class toggles */}
              {GEAR_CLASSES.map(cat => (
                <div key={cat.category} style={{ marginBottom: 10 }}>
                  <div style={{ fontSize: 10, fontWeight: 600, color: T.textSecond, letterSpacing: "0.06em", marginBottom: 6 }}>{cat.category}</div>
                  <div style={{ display: "flex", flexWrap: "wrap", gap: "4px 12px" }}>
                    {cat.classes.map(cls => {
                      const isVisible = classVisibility[cls] !== false;
                      return (
                        <label key={cls} style={{
                          display: "flex", alignItems: "center", gap: 5, cursor: "pointer",
                          fontSize: 11, color: isVisible ? T.text : T.textMuted,
                          padding: "3px 0", minWidth: 140,
                        }}>
                          <input
                            type="checkbox"
                            checked={isVisible}
                            onChange={e => onClassToggle(cls, e.target.checked)}
                            style={{ accentColor: T.gold, cursor: "pointer" }}
                          />
                          {cls}
                        </label>
                      );
                    })}
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      );
    }

    // -----------------------------------------------------------------------
    // FilterTab
    // -----------------------------------------------------------------------
    function FilterTab({ settings, onUpdate, onUpdateFilter, filterUpdating }) {
      const strictness = settings.filter_strictness || "normal";
      const tierStyles = settings.filter_tier_styles || {};
      const sectionVisibility = settings.filter_section_visibility || {};
      const gearClasses = settings.filter_gear_classes || {};
      const colorPreset = settings.filter_color_preset || "default";

      const handleStrictnessChange = (val) => {
        onUpdate({ filter_strictness: val });
      };

      const handleSectionVisibility = (sectionId, visible) => {
        onUpdate({ filter_section_visibility: { ...sectionVisibility, [sectionId]: visible } });
      };

      const handleTierStyleChange = (tier, style) => {
        onUpdate({ filter_tier_styles: { ...tierStyles, [tier]: style } });
      };

      const handleGearClassToggle = (gearId, className, visible) => {
        const current = gearClasses[gearId] || {};
        onUpdate({ filter_gear_classes: { ...gearClasses, [gearId]: { ...current, [className]: visible } } });
      };

      const handleColorPreset = (presetId) => {
        const preset = COLOR_PRESETS[presetId];
        if (!preset) return;
        const newStyles = { ...tierStyles };
        if (presetId === "default") {
          // Clear color overrides, keep sound/beam/minimap/font settings
          for (const tier of Object.keys(newStyles)) {
            if (!newStyles[tier]) continue;
            const { text_color, border_color, bg_color, ...rest } = newStyles[tier];
            newStyles[tier] = Object.keys(rest).length > 0 ? rest : undefined;
          }
          // Remove undefined entries
          for (const k of Object.keys(newStyles)) { if (!newStyles[k]) delete newStyles[k]; }
        } else {
          // Apply preset colors on top of existing settings
          for (const [tier, colors] of Object.entries(preset.tiers)) {
            newStyles[tier] = { ...(tierStyles[tier] || {}), ...colors };
          }
        }
        onUpdate({ filter_tier_styles: newStyles, filter_color_preset: presetId });
      };

      return (
        <div>
          <div style={{ fontSize: 10, color: T.textMuted, fontStyle: "italic", padding: "8px 0 4px", borderBottom: `1px solid ${T.border}22`, marginBottom: 12 }}>
            Filter tiers are based on poe.ninja market data and may not reflect real-time prices. Strictness thresholds are chaos-based estimates.
          </div>
          {/* Strictness + Color Preset */}
          <div className="panel" style={{ ...CARD, marginBottom: 20 }}>
            <StrictnessSelector value={strictness} onChange={handleStrictnessChange} colorPreset={colorPreset} tierStyles={tierStyles} />

            {/* Color preset selector */}
            <div style={{ marginBottom: 16 }}>
              <div style={{ ...LABEL, marginBottom: 10 }}>Color Preset</div>
              <div style={{ display: "flex", gap: 8 }}>
                {Object.entries(COLOR_PRESETS).map(([id, preset]) => {
                  const active = colorPreset === id;
                  return (
                    <button
                      key={id}
                      onClick={() => handleColorPreset(id)}
                      style={{
                        ...BTN,
                        background: active ? T.gold : T.input,
                        color: active ? "#0d0b08" : T.textSecond,
                        border: `1px solid ${active ? T.gold : T.border}`,
                        padding: "6px 14px",
                      }}
                    >
                      <div style={{ fontWeight: 600, fontSize: 11 }}>{preset.label}</div>
                      <div style={{ fontSize: 9, opacity: 0.7, marginTop: 1 }}>{preset.desc}</div>
                    </button>
                  );
                })}
              </div>
              {/* Mini preview of preset colors */}
              <div style={{ display: "flex", gap: 6, marginTop: 8 }}>
                {["s", "a", "b", "c", "d", "e"].map(tier => {
                  const s = getEffectiveTierStyle(tier, tierStyles, colorPreset);
                  return (
                    <div key={tier} style={{
                      padding: "1px 6px", borderRadius: 2,
                      backgroundColor: s.bg_color, border: `2px solid ${s.border_color}`,
                      color: s.text_color, fontSize: 9, fontWeight: 600,
                      fontFamily: "'JetBrains Mono', monospace", lineHeight: 1.5,
                    }}>{TIER_LABELS[tier]}</div>
                  );
                })}
              </div>
            </div>

            {/* Auto-update toggle */}
            <div style={{ display: "flex", alignItems: "center", gap: 10 }}>
              <Toggle value={settings.no_filter_update || false}
                onChange={(v) => onUpdate({ no_filter_update: v })} />
              <div>
                <span style={{ fontSize: 12, fontWeight: 500, color: T.text }}>Disable auto-updates</span>
                <div style={{ fontSize: 10, color: T.textMuted }}>Don't auto-update loot filter on overlay startup</div>
              </div>
            </div>
          </div>

          {/* Gear & Uniques */}
          <div className="panel" style={{ ...CARD, marginBottom: 20 }}>
            <div style={{ ...LABEL, marginBottom: 12 }}>Gear & Uniques</div>

            {/* Uniques — tier accordion like economy sections */}
            <SectionRow
              section={UNIQUE_SECTION}
              visible={sectionVisibility[UNIQUE_SECTION.id]}
              tierStyles={tierStyles}
              onVisibilityChange={(v) => handleSectionVisibility(UNIQUE_SECTION.id, v)}
              onTierStyleChange={handleTierStyleChange}
              strictness={strictness}
              colorPreset={colorPreset}
            />

            {/* Gear categories — accordion with class toggles */}
            {GEAR_SECTIONS.map(section => (
              <GearRow
                key={section.id}
                section={section}
                visible={sectionVisibility[section.id]}
                style={tierStyles[section.id] || {}}
                classVisibility={gearClasses[section.id] || {}}
                onVisibilityChange={(v) => handleSectionVisibility(section.id, v)}
                onStyleChange={(style) => handleTierStyleChange(section.id, style)}
                onClassToggle={(cls, vis) => handleGearClassToggle(section.id, cls, vis)}
              />
            ))}
          </div>

          {/* Economy section accordions */}
          <div className="panel" style={{ ...CARD, marginBottom: 20 }}>
            <div style={{ ...LABEL, marginBottom: 12 }}>Economy Sections</div>
            {ECONOMY_SECTIONS.map(section => (
              <SectionRow
                key={section.id}
                section={section}
                visible={sectionVisibility[section.id]}
                tierStyles={tierStyles}
                onVisibilityChange={(v) => handleSectionVisibility(section.id, v)}
                onTierStyleChange={handleTierStyleChange}
                strictness={strictness}
                colorPreset={colorPreset}
              />
            ))}
          </div>

          {/* Update button */}
          <div className="panel" style={{ ...CARD }}>
            <div style={{ display: "flex", alignItems: "center", gap: 12 }}>
              <Tooltip text="Update loot filter tiers from current prices + your customizations">
                <button
                  onClick={onUpdateFilter}
                  disabled={filterUpdating}
                  className="btn-gold-hover"
                  style={{
                    ...BTN_GOLD_ACTIVE,
                    opacity: filterUpdating ? 0.5 : 1,
                    cursor: filterUpdating ? "default" : "pointer",
                    padding: "10px 28px",
                  }}
                >{filterUpdating ? "Updating..." : "Update Filter Now"}</button>
              </Tooltip>
              <div style={{ fontSize: 11, color: T.textMuted }}>
                Applies strictness, section visibility, and tier styling to your .filter file
              </div>
            </div>
          </div>
        </div>
      );
    }

    // -----------------------------------------------------------------------
    // Watchlist — BaseTypeDropdown
    // -----------------------------------------------------------------------
    function BaseTypeDropdown({ categories, value, onChange }) {
      const [search, setSearch] = useState("");
      const [open, setOpen] = useState(false);
      const ref = useRef(null);

      useEffect(() => {
        const handler = (e) => { if (ref.current && !ref.current.contains(e.target)) setOpen(false); };
        document.addEventListener("mousedown", handler);
        return () => document.removeEventListener("mousedown", handler);
      }, []);

      const matches = [];
      if (search.length >= 1) {
        const lower = search.toLowerCase();
        for (const cat of categories) {
          for (const entry of cat.entries) {
            const label = entry.name ? `${entry.name} ${entry.type}` : entry.type;
            if (label.toLowerCase().includes(lower)) {
              matches.push({ label, type: entry.type, name: entry.name, category: cat.label });
              if (matches.length >= 30) break;
            }
          }
          if (matches.length >= 30) break;
        }
      }

      return (
        <div ref={ref} style={{ position: "relative" }}>
          <input
            value={search || value || ""}
            onChange={(e) => { setSearch(e.target.value); setOpen(true); if (!e.target.value) onChange("", ""); }}
            onFocus={() => { if (search.length >= 1) setOpen(true); }}
            placeholder="Search base types..."
            style={FIELD_INPUT}
          />
          {open && matches.length > 0 && (
            <div style={{
              position: "absolute", top: "100%", left: 0, right: 0, zIndex: 200,
              background: T.card, border: `1px solid ${T.borderGold}`, borderRadius: 6,
              maxHeight: 250, overflowY: "auto", marginTop: 2,
              boxShadow: "0 8px 24px rgba(0,0,0,0.7)",
            }}>
              {matches.map((m, i) => (
                <div key={i}
                  onClick={() => { onChange(m.type, m.name || ""); setSearch(m.label); setOpen(false); }}
                  style={{
                    padding: "6px 12px", cursor: "pointer", fontSize: 12,
                    borderBottom: `1px solid ${T.border}22`,
                    color: T.text,
                  }}
                  onMouseEnter={(e) => e.target.style.background = T.input}
                  onMouseLeave={(e) => e.target.style.background = "transparent"}
                >
                  <span>{m.label}</span>
                  <span style={{ float: "right", fontSize: 10, color: T.textMuted }}>{m.category}</span>
                </div>
              ))}
            </div>
          )}
        </div>
      );
    }

    // -----------------------------------------------------------------------
    // Watchlist — StatFilterAutocomplete
    // -----------------------------------------------------------------------
    function StatFilterAutocomplete({ stats, filters, onChange }) {
      const [search, setSearch] = useState("");
      const [open, setOpen] = useState(false);
      const ref = useRef(null);

      useEffect(() => {
        const handler = (e) => { if (ref.current && !ref.current.contains(e.target)) setOpen(false); };
        document.addEventListener("mousedown", handler);
        return () => document.removeEventListener("mousedown", handler);
      }, []);

      const matches = [];
      if (search.length >= 2) {
        const lower = search.toLowerCase();
        const usedIds = new Set(filters.map(f => f.id));
        for (const stat of stats) {
          if (usedIds.has(stat.id)) continue;
          if (stat.text.toLowerCase().includes(lower)) {
            matches.push(stat);
            if (matches.length >= 20) break;
          }
        }
      }

      const addFilter = (stat) => {
        if (filters.length >= 5) return;
        onChange([...filters, { id: stat.id, text: stat.text, min: "", max: "" }]);
        setSearch("");
        setOpen(false);
      };

      const removeFilter = (idx) => {
        onChange(filters.filter((_, i) => i !== idx));
      };

      const updateFilter = (idx, field, value) => {
        const updated = [...filters];
        updated[idx] = { ...updated[idx], [field]: value };
        onChange(updated);
      };

      return (
        <div>
          {/* Existing filters */}
          {filters.map((f, i) => (
            <div key={f.id} style={{
              display: "flex", alignItems: "center", gap: 8, marginBottom: 6,
              background: T.input, border: `1px solid ${T.border}`, borderRadius: 5, padding: "5px 10px",
            }}>
              <span style={{ flex: 1, fontSize: 11, color: T.text, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>
                {f.text}
              </span>
              <input
                type="number" placeholder="min" value={f.min}
                onChange={(e) => updateFilter(i, "min", e.target.value)}
                style={{ ...FIELD_INPUT, width: 60, padding: "3px 6px", fontSize: 11, textAlign: "center" }}
              />
              <input
                type="number" placeholder="max" value={f.max}
                onChange={(e) => updateFilter(i, "max", e.target.value)}
                style={{ ...FIELD_INPUT, width: 60, padding: "3px 6px", fontSize: 11, textAlign: "center" }}
              />
              <button onClick={() => removeFilter(i)} style={{
                background: "transparent", border: "none", color: T.red, cursor: "pointer",
                fontSize: 14, fontWeight: 700, padding: "0 4px", lineHeight: 1,
              }}>×</button>
            </div>
          ))}

          {/* Search input */}
          {filters.length < 5 && (
            <div ref={ref} style={{ position: "relative" }}>
              <input
                value={search}
                onChange={(e) => { setSearch(e.target.value); setOpen(true); }}
                onFocus={() => { if (search.length >= 2) setOpen(true); }}
                placeholder="Search stat filters... (min 2 chars)"
                style={FIELD_INPUT}
              />
              {open && matches.length > 0 && (
                <div style={{
                  position: "absolute", top: "100%", left: 0, right: 0, zIndex: 200,
                  background: T.card, border: `1px solid ${T.borderGold}`, borderRadius: 6,
                  maxHeight: 200, overflowY: "auto", marginTop: 2,
                  boxShadow: "0 8px 24px rgba(0,0,0,0.7)",
                }}>
                  {matches.map((stat) => (
                    <div key={stat.id}
                      onClick={() => addFilter(stat)}
                      style={{
                        padding: "6px 12px", cursor: "pointer", fontSize: 11,
                        borderBottom: `1px solid ${T.border}22`, color: T.text,
                      }}
                      onMouseEnter={(e) => e.target.style.background = T.input}
                      onMouseLeave={(e) => e.target.style.background = "transparent"}
                    >
                      <span>{stat.text}</span>
                      <span style={{ float: "right", fontSize: 9, color: T.textMuted }}>{stat.type}</span>
                    </div>
                  ))}
                </div>
              )}
            </div>
          )}
        </div>
      );
    }

    // -----------------------------------------------------------------------
    // Watchlist — WatchlistQueryEditor
    // -----------------------------------------------------------------------
    function WatchlistQueryEditor({ query, tradeStats, tradeItems, onSave, onCancel }) {
      const [label, setLabel] = useState(query?.label || "");
      const [itemName, setItemName] = useState(query?.item_name || "");
      const [baseType, setBaseType] = useState(query?.base_type || "");
      const [rarity, setRarity] = useState(query?.rarity || "any");
      const [ilvlMin, setIlvlMin] = useState(query?.ilvl_min || "");
      const [qualityMin, setQualityMin] = useState(query?.quality_min || "");
      const [socketsMin, setSocketsMin] = useState(query?.sockets_min || "");
      const [onlineOnly, setOnlineOnly] = useState(query?.online_only !== false);
      const [statFilters, setStatFilters] = useState(query?.stat_filters || []);

      const buildQueryBody = () => {
        const q = { status: { option: onlineOnly ? "online" : "any" } };
        const filters = {};

        if (itemName) q.name = itemName;
        if (baseType) q.type = baseType;

        // Rarity filter
        if (rarity !== "any") {
          filters.type_filters = { filters: { rarity: { option: rarity === "unique" ? "unique" : rarity } } };
        }

        // Equipment filters
        const equipFilters = {};
        if (socketsMin) equipFilters.rune_sockets = { min: parseInt(socketsMin) };
        if (Object.keys(equipFilters).length > 0) {
          filters.equipment_filters = { filters: equipFilters };
        }

        // Misc filters
        const miscFilters = {};
        if (ilvlMin) miscFilters.ilvl = { min: parseInt(ilvlMin) };
        if (qualityMin) miscFilters.quality = { min: parseInt(qualityMin) };
        if (Object.keys(miscFilters).length > 0) {
          filters.misc_filters = { filters: miscFilters };
        }

        if (Object.keys(filters).length > 0) q.filters = filters;

        // Stat filters
        if (statFilters.length > 0) {
          const statGroup = { type: "and", filters: [] };
          for (const sf of statFilters) {
            const val = {};
            if (sf.min !== "" && sf.min !== undefined) val.min = parseFloat(sf.min);
            if (sf.max !== "" && sf.max !== undefined) val.max = parseFloat(sf.max);
            if (Object.keys(val).length > 0) {
              statGroup.filters.push({ id: sf.id, value: val });
            } else {
              statGroup.filters.push({ id: sf.id });
            }
          }
          q.stats = [statGroup];
        }

        return { query: q, sort: { price: "asc" } };
      };

      const handleSave = () => {
        const body = buildQueryBody();
        onSave({
          id: query?.id || crypto.randomUUID(),
          label: label || "Untitled Query",
          enabled: query?.enabled !== false,
          item_name: itemName,
          base_type: baseType,
          rarity,
          ilvl_min: ilvlMin,
          quality_min: qualityMin,
          sockets_min: socketsMin,
          online_only: onlineOnly,
          stat_filters: statFilters,
          body,
        });
      };

      return (
        <div style={{ padding: "12px 0" }}>
          {/* Row 1: Label */}
          <div style={{ marginBottom: 10 }}>
            <label style={FIELD_LABEL}>Label</label>
            <input value={label} onChange={(e) => setLabel(e.target.value)} placeholder="e.g. Headhunter, ilvl 82 bases..."
              style={FIELD_INPUT} autoFocus />
          </div>

          {/* Row 2: Item Name + Base Type */}
          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 12, marginBottom: 10 }}>
            <div>
              <label style={FIELD_LABEL}>Item Name (for uniques)</label>
              <input value={itemName} onChange={(e) => setItemName(e.target.value)} placeholder="e.g. Headhunter"
                style={FIELD_INPUT} />
            </div>
            <div>
              <label style={FIELD_LABEL}>Base Type</label>
              <BaseTypeDropdown categories={tradeItems} value={baseType}
                onChange={(type, name) => { setBaseType(type); if (name && !itemName) setItemName(name); }} />
            </div>
          </div>

          {/* Row 3: Rarity, ilvl, Quality, Sockets */}
          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr 1fr", gap: 12, marginBottom: 10 }}>
            <div>
              <label style={FIELD_LABEL}>Rarity</label>
              <select value={rarity} onChange={(e) => setRarity(e.target.value)} style={{ ...FIELD_INPUT, appearance: "auto" }}>
                <option value="any">Any</option>
                <option value="unique">Unique</option>
                <option value="rare">Rare</option>
                <option value="magic">Magic</option>
                <option value="normal">Normal</option>
              </select>
            </div>
            <div>
              <label style={FIELD_LABEL}>Min Item Level</label>
              <input type="number" value={ilvlMin} onChange={(e) => setIlvlMin(e.target.value)} placeholder="--"
                min={1} max={100} style={FIELD_INPUT} />
            </div>
            <div>
              <label style={FIELD_LABEL}>Min Quality</label>
              <input type="number" value={qualityMin} onChange={(e) => setQualityMin(e.target.value)} placeholder="--"
                min={0} max={30} style={FIELD_INPUT} />
            </div>
            <div>
              <label style={FIELD_LABEL}>Min Sockets</label>
              <input type="number" value={socketsMin} onChange={(e) => setSocketsMin(e.target.value)} placeholder="--"
                min={1} max={3} style={FIELD_INPUT} />
            </div>
          </div>

          {/* Row 4: Online toggle */}
          <div style={{ display: "flex", alignItems: "center", gap: 10, marginBottom: 14 }}>
            <Toggle value={onlineOnly} onChange={setOnlineOnly} size="small" />
            <span style={{ fontSize: 12, color: T.text }}>Online only</span>
          </div>

          {/* Row 5: Stat Filters */}
          <div style={{ marginBottom: 14 }}>
            <label style={FIELD_LABEL}>Stat Filters (up to 5)</label>
            <StatFilterAutocomplete stats={tradeStats} filters={statFilters} onChange={setStatFilters} />
          </div>

          {/* Row 6: Save / Cancel */}
          <div style={{ display: "flex", gap: 10, justifyContent: "flex-end" }}>
            <button onClick={onCancel} style={{ ...BTN, background: T.input, border: `1px solid ${T.border}`, color: T.textSecond }}>Cancel</button>
            <button onClick={handleSave} style={BTN_GOLD_ACTIVE}>Save Query</button>
          </div>
        </div>
      );
    }

    // -----------------------------------------------------------------------
    // Watchlist — WatchlistListingsTable
    // -----------------------------------------------------------------------
    function WatchlistListingsTable({ listings, tradeUrl }) {
      const [copiedIdx, setCopiedIdx] = useState(null);

      if (!listings || listings.length === 0) return null;

      const copyWhisper = (whisper, idx) => {
        navigator.clipboard.writeText(whisper).then(() => {
          setCopiedIdx(idx);
          setTimeout(() => setCopiedIdx(null), 1200);
        }).catch(() => {});
      };

      const formatTime = (indexed) => {
        if (!indexed) return "--";
        try {
          const d = new Date(indexed);
          const now = new Date();
          const diffMs = now - d;
          const diffH = Math.floor(diffMs / 3600000);
          if (diffH < 1) return `${Math.floor(diffMs / 60000)}m ago`;
          if (diffH < 24) return `${diffH}h ago`;
          return `${Math.floor(diffH / 24)}d ago`;
        } catch { return "--"; }
      };

      return (
        <div style={{ maxHeight: 220, overflowY: "auto" }}>
          <table style={{ width: "100%", borderCollapse: "collapse", fontSize: 11, ...MONO }}>
            <thead>
              <tr style={{ borderBottom: `1px solid ${T.border}`, color: T.textMuted, fontSize: 9, letterSpacing: "0.06em", textTransform: "uppercase" }}>
                <th style={{ textAlign: "left", padding: "4px 6px", fontWeight: 600 }}>Price</th>
                <th style={{ textAlign: "left", padding: "4px 6px", fontWeight: 600 }}>Item</th>
                <th style={{ textAlign: "left", padding: "4px 6px", fontWeight: 600 }}>Account</th>
                <th style={{ textAlign: "left", padding: "4px 6px", fontWeight: 600 }}>Listed</th>
                <th style={{ textAlign: "right", padding: "4px 6px", fontWeight: 600 }}>Actions</th>
              </tr>
            </thead>
            <tbody>
              {listings.map((l, i) => (
                <tr key={i} style={{ borderBottom: `1px solid ${T.border}22` }}>
                  <td style={{ padding: "4px 6px", color: T.gold, fontWeight: 600, whiteSpace: "nowrap" }}>
                    <span style={{ display: "inline-flex", alignItems: "center", gap: 3 }}>
                      {l.price && l.price.toLowerCase().includes("divine") && <CurrencyIcon src={ICON.divine} size={14} />}
                      {l.price && l.price.toLowerCase().includes("exalted") && <CurrencyIcon src={ICON.exalted} size={14} />}
                      {l.price && l.price.toLowerCase().includes("chaos") && <CurrencyIcon src={ICON.chaos} size={14} />}
                      {l.price ? l.price.replace(/\s*(divine|exalted|chaos)\s*/gi, " ").trim() : "--"}
                    </span>
                  </td>
                  <td style={{ padding: "4px 6px", color: T.text, maxWidth: 140, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>
                    {l.item_name || "--"}
                  </td>
                  <td style={{ padding: "4px 6px", color: T.textSecond, maxWidth: 100, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>{l.account}</td>
                  <td style={{ padding: "4px 6px", color: T.textMuted, whiteSpace: "nowrap" }}>{formatTime(l.indexed)}</td>
                  <td style={{ padding: "4px 6px", textAlign: "right", whiteSpace: "nowrap" }}>
                    <div style={{ display: "inline-flex", gap: 4 }}>
                      {tradeUrl && (
                        <Tooltip text="Open on trade site to visit hideout">
                          <a href={tradeUrl} target="_blank" rel="noopener noreferrer" style={{
                            ...BTN, padding: "2px 8px", fontSize: 10, textDecoration: "none",
                            background: T.input, color: T.gold,
                            border: `1px solid ${T.borderGold}`,
                            display: "inline-block",
                          }}>Buy</a>
                        </Tooltip>
                      )}
                      {l.whisper && (
                        <Tooltip text="Copy whisper message to clipboard">
                          <button onClick={() => copyWhisper(l.whisper, i)} style={{
                            ...BTN, padding: "2px 8px", fontSize: 10,
                            background: copiedIdx === i ? T.green : T.input,
                            color: copiedIdx === i ? "#fff" : T.textSecond,
                            border: `1px solid ${copiedIdx === i ? T.green : T.border}`,
                          }}>{copiedIdx === i ? "Copied" : "Whisper"}</button>
                        </Tooltip>
                      )}
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      );
    }

    // -----------------------------------------------------------------------
    // Watchlist — WatchlistQueryCard
    // -----------------------------------------------------------------------
    // -----------------------------------------------------------------------
    // Watchlist — QueryStatusBadge
    // -----------------------------------------------------------------------
    function QueryStatusBadge({ queryState }) {
      const st = queryState?.state || "idle";
      const [countdown, setCountdown] = useState("");

      useEffect(() => {
        if (st !== "cooldown" || !queryState?.next_poll) { setCountdown(""); return; }
        const tick = () => {
          const remaining = Math.max(0, Math.floor(queryState.next_poll - Date.now() / 1000));
          if (remaining <= 0) { setCountdown("Soon"); return; }
          const m = Math.floor(remaining / 60);
          const s = remaining % 60;
          setCountdown(`${m}:${s.toString().padStart(2, "0")}`);
        };
        tick();
        const iv = setInterval(tick, 1000);
        return () => clearInterval(iv);
      }, [st, queryState?.next_poll]);

      const configs = {
        querying: { label: "Querying...", color: T.amber, bg: "rgba(184,134,11,0.15)", animate: true },
        cooldown: { label: countdown ? `Next: ${countdown}` : "Cooldown", color: T.cyan, bg: "rgba(107,143,113,0.12)", animate: false },
        idle:     { label: "Idle", color: T.textMuted, bg: "rgba(92,79,61,0.1)", animate: false },
        error:    { label: "Error", color: T.red, bg: "rgba(168,50,50,0.12)", animate: false },
        disabled: { label: "Disabled", color: T.textMuted, bg: "rgba(92,79,61,0.08)", animate: false },
      };
      const c = configs[st] || configs.idle;

      return (
        <div style={{
          display: "inline-flex", alignItems: "center", gap: 5,
          background: c.bg, border: `1px solid ${c.color}33`,
          borderRadius: 12, padding: "2px 8px", fontSize: 10, fontWeight: 600,
          color: c.color, whiteSpace: "nowrap",
        }}>
          <span style={{
            width: 5, height: 5, borderRadius: "50%", background: c.color,
            animation: c.animate ? "pulse 1.2s infinite" : "none",
            flexShrink: 0,
          }} />
          {c.label}
        </div>
      );
    }

    function WatchlistQueryCard({ query, result, queryState, tradeStats, tradeItems, onUpdate, onDelete, onRefresh }) {
      const [editing, setEditing] = useState(false);

      const r = result || {};
      const hasResult = !!r.last_checked;
      const hasError = !!r.error;
      const lastChecked = r.last_checked ? new Date(r.last_checked * 1000).toLocaleTimeString() : "";
      const isDisabled = query.enabled === false;

      const priceRange = r.price_low && r.price_high
        ? (r.price_low === r.price_high ? r.price_low : `${r.price_low} — ${r.price_high}`)
        : null;

      const handleSave = (updated) => {
        onUpdate(updated);
        setEditing(false);
      };

      return (
        <div className="panel" style={{
          ...CARD, padding: 0, overflow: "hidden",
          opacity: isDisabled ? 0.6 : 1,
          display: "flex", flexDirection: "column", height: "100%",
        }}>
          {/* Header row */}
          <div style={{
            display: "flex", alignItems: "center", gap: 8, padding: "10px 12px",
            borderBottom: `1px solid ${T.border}`,
            background: T.input,
          }}>
            <div onClick={(e) => e.stopPropagation()}>
              <Toggle size="small" value={query.enabled !== false}
                onChange={(v) => onUpdate({ ...query, enabled: v })} />
            </div>

            <div style={{ flex: 1, minWidth: 0 }}>
              <div style={{ fontWeight: 600, fontSize: 13, color: isDisabled ? T.textMuted : T.text, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>
                {query.label || "Untitled Query"}
              </div>
            </div>

            {r.trade_url && (
              <Tooltip text="Open on trade site">
                <a href={r.trade_url} target="_blank" rel="noopener noreferrer" style={{
                  color: T.cyan, fontSize: 14, textDecoration: "none", lineHeight: 1,
                  display: "inline-flex", alignItems: "center",
                }}>&#8599;</a>
              </Tooltip>
            )}

            <Tooltip text="Refresh now">
              <button onClick={() => onRefresh(query.id)} style={{
                ...BTN, padding: "3px 7px", fontSize: 12, background: "transparent",
                border: `1px solid ${T.border}`, color: T.textSecond, lineHeight: 1,
              }}>&#8635;</button>
            </Tooltip>
            <Tooltip text="Edit query">
              <button onClick={() => setEditing(!editing)} style={{
                ...BTN, padding: "3px 7px", fontSize: 11, background: editing ? T.gold + "22" : "transparent",
                border: `1px solid ${editing ? T.gold : T.border}`, color: editing ? T.gold : T.textSecond, lineHeight: 1,
              }}>&#9998;</button>
            </Tooltip>
            <Tooltip text="Delete query">
              <button onClick={() => onDelete(query.id)} className="btn-danger-hover" style={{
                ...BTN, padding: "3px 7px", fontSize: 12, background: "transparent",
                border: `1px solid ${T.border}`, color: T.red, lineHeight: 1,
              }}>&#10005;</button>
            </Tooltip>
          </div>

          {/* Editor */}
          {editing && (
            <div style={{ padding: "8px 12px 12px", borderBottom: `1px solid ${T.border}` }}>
              <WatchlistQueryEditor
                query={query}
                tradeStats={tradeStats}
                tradeItems={tradeItems}
                onSave={handleSave}
                onCancel={() => setEditing(false)}
              />
            </div>
          )}

          {/* Price summary + status badge — always visible */}
          {!editing && (
            <div style={{ padding: "8px 12px", display: "flex", alignItems: "center", gap: 10, borderBottom: `1px solid ${T.border}22` }}>
              <div style={{ flex: 1, minWidth: 0 }}>
                {priceRange ? (
                  <div style={{ fontSize: 14, fontWeight: 700, color: T.gold, ...MONO, display: "flex", alignItems: "center", gap: 4 }}>
                    {priceRange.toLowerCase().includes("divine") && <CurrencyIcon src={ICON.divine} size={16} />}
                    {priceRange.toLowerCase().includes("exalted") && <CurrencyIcon src={ICON.exalted} size={16} />}
                    {priceRange.toLowerCase().includes("chaos") && <CurrencyIcon src={ICON.chaos} size={16} />}
                    {priceRange.replace(/\s*(divine|exalted|chaos)\s*/gi, " ").trim()}
                  </div>
                ) : hasError ? (
                  <div style={{ fontSize: 12, fontWeight: 600, color: T.red }}>{r.error}</div>
                ) : hasResult ? (
                  <div style={{ fontSize: 12, color: T.textMuted, ...MONO }}>No results</div>
                ) : (
                  <div style={{ fontSize: 12, color: T.textMuted }}>Waiting for first poll...</div>
                )}
                {hasResult && r.total !== undefined && (
                  <div style={{ fontSize: 10, color: T.textMuted }}>
                    {r.total} listed{lastChecked && ` · checked ${lastChecked}`}
                  </div>
                )}
              </div>
              <QueryStatusBadge queryState={queryState} />
            </div>
          )}

          {/* Listings — always expanded when available */}
          {!editing && r.listings && r.listings.length > 0 && (
            <div style={{ padding: "0 12px 8px", flex: 1, minHeight: 0 }}>
              <WatchlistListingsTable listings={r.listings} tradeUrl={r.trade_url} />
            </div>
          )}
        </div>
      );
    }

    // -----------------------------------------------------------------------
    // Watchlist — WatchlistTab
    // -----------------------------------------------------------------------
    function WatchlistTab({ settings, watchlistResults, queryStates, onSettingsUpdate, onRefresh }) {
      const [tradeStats, setTradeStats] = useState([]);
      const [tradeItems, setTradeItems] = useState([]);
      const [loaded, setLoaded] = useState(false);
      const [addingSlot, setAddingSlot] = useState(null); // index of slot being added to

      const queries = settings.watchlist_queries || [];
      const pollInterval = settings.watchlist_poll_interval || 300;
      const TOTAL_SLOTS = 6;

      // Lazy-load trade data on first render
      useEffect(() => {
        if (loaded) return;
        setLoaded(true);
        Promise.all([
          api("/api/trade-data/stats"),
          api("/api/trade-data/items"),
        ]).then(([stats, items]) => {
          if (Array.isArray(stats)) setTradeStats(stats);
          if (Array.isArray(items)) setTradeItems(items);
        });
      }, [loaded]);

      const saveQueries = (newQueries) => {
        onSettingsUpdate({ watchlist_queries: newQueries });
      };

      const handleUpdate = (updated) => {
        const newQueries = queries.map(q => q.id === updated.id ? updated : q);
        saveQueries(newQueries);
      };

      const handleDelete = (id) => {
        saveQueries(queries.filter(q => q.id !== id));
      };

      const handleAdd = (newQuery) => {
        saveQueries([...queries, newQuery]);
        setAddingSlot(null);
      };

      const handlePollIntervalChange = (val) => {
        const clamped = Math.max(60, Math.min(3600, parseInt(val) || 300));
        onSettingsUpdate({ watchlist_poll_interval: clamped });
      };

      // Build slots: active queries first, then empty slots, then "adding" slot if any
      const slots = [];
      for (let i = 0; i < TOTAL_SLOTS; i++) {
        if (i < queries.length) {
          slots.push({ type: "query", query: queries[i] });
        } else if (addingSlot === i) {
          slots.push({ type: "adding" });
        } else {
          slots.push({ type: "empty", index: i });
        }
      }

      return (
        <div>
          <div style={{ fontSize: 10, color: T.textMuted, fontStyle: "italic", padding: "8px 0 4px", borderBottom: `1px solid ${T.border}22`, marginBottom: 12 }}>
            Watchlist prices are from the trade API and reflect current listings, not completed sales. Prices may include price-fixers.
          </div>
          {/* Settings row */}
          <div className="panel" style={{ ...CARD, marginBottom: 16, display: "flex", alignItems: "center", gap: 16 }}>
            <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
              <span style={FIELD_LABEL}>Poll Interval</span>
              <select value={pollInterval} onChange={(e) => handlePollIntervalChange(e.target.value)}
                style={{ ...FIELD_INPUT, width: "auto", minWidth: 120, padding: "5px 10px", appearance: "auto" }}>
                <option value={60}>1 minute</option>
                <option value={120}>2 minutes</option>
                <option value={300}>5 minutes</option>
                <option value={600}>10 minutes</option>
                <option value={900}>15 minutes</option>
              </select>
            </div>
            <div style={{ flex: 1 }} />
            <div style={{ fontSize: 11, color: T.textMuted }}>
              {queries.length} / {TOTAL_SLOTS} queries
            </div>
          </div>

          {/* 6-slot grid */}
          <div style={{
            display: "grid",
            gridTemplateColumns: "repeat(2, 1fr)",
            gap: 12,
          }}>
            {slots.map((slot, idx) => {
              if (slot.type === "query") {
                return (
                  <WatchlistQueryCard
                    key={slot.query.id}
                    query={slot.query}
                    result={watchlistResults[slot.query.id]}
                    queryState={queryStates[slot.query.id]}
                    tradeStats={tradeStats}
                    tradeItems={tradeItems}
                    onUpdate={handleUpdate}
                    onDelete={handleDelete}
                    onRefresh={onRefresh}
                  />
                );
              } else if (slot.type === "adding") {
                return (
                  <div key={`add-${idx}`} style={{ ...CARD, padding: 12 }}>
                    <div style={{ fontWeight: 600, fontSize: 13, marginBottom: 8, color: T.gold }}>New Query</div>
                    <WatchlistQueryEditor
                      query={null}
                      tradeStats={tradeStats}
                      tradeItems={tradeItems}
                      onSave={handleAdd}
                      onCancel={() => setAddingSlot(null)}
                    />
                  </div>
                );
              } else {
                // Empty slot with rotating POE2 quote
                const quote = WATCHLIST_QUOTES[(idx - queries.length) % WATCHLIST_QUOTES.length];
                return (
                  <div
                    key={`empty-${idx}`}
                    onClick={() => { if (queries.length < TOTAL_SLOTS) setAddingSlot(slot.index); }}
                    style={{
                      border: `2px dashed ${T.border}`,
                      borderRadius: 8,
                      display: "flex", alignItems: "center", justifyContent: "center",
                      minHeight: 120,
                      cursor: queries.length < TOTAL_SLOTS ? "pointer" : "default",
                      transition: "border-color 0.15s, background 0.15s",
                    }}
                    onMouseEnter={(e) => { e.currentTarget.style.borderColor = T.borderGold; e.currentTarget.style.background = T.card; }}
                    onMouseLeave={(e) => { e.currentTarget.style.borderColor = T.border; e.currentTarget.style.background = "transparent"; }}
                  >
                    <div style={{ textAlign: "center" }}>
                      <div style={{ fontSize: 24, color: T.textMuted, lineHeight: 1 }}>+</div>
                      <div style={{ fontSize: 11, color: T.textMuted, marginTop: 6, fontStyle: "italic" }}>{quote}</div>
                    </div>
                  </div>
                );
              }
            })}
          </div>
        </div>
      );
    }

    // -----------------------------------------------------------------------
    // LogPanel
    // -----------------------------------------------------------------------
    function LogPanel({ logs, logRef, onClear }) {
      const [copyLabel, setCopyLabel] = useState("COPY");
      const [collapsed, setCollapsed] = useState(true);

      const copyLogs = () => {
        const text = logs.map(l => `${l.time || ""} ${l.message}`.trim()).join("\n");
        navigator.clipboard.writeText(text).then(() => {
          setCopyLabel("COPIED!");
          setTimeout(() => setCopyLabel("COPY"), 1500);
        }).catch(() => {
          const ta = document.createElement("textarea");
          ta.value = text;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand("copy");
          document.body.removeChild(ta);
          setCopyLabel("COPIED!");
          setTimeout(() => setCopyLabel("COPY"), 1500);
        });
      };

      return (
        <div className="panel" style={{ ...CARD, padding: 12, marginTop: 0, marginBottom: 0 }}>
          <div
            style={{
              display: "flex", justifyContent: "space-between", alignItems: "center",
              cursor: "pointer", userSelect: "none",
            }}
            onClick={() => setCollapsed(!collapsed)}
          >
            <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
              <span style={LABEL}>Console Output</span>
              {logs.length > 0 && (
                <span style={{ fontSize: 10, color: T.textMuted, ...MONO }}>{logs.length} lines</span>
              )}
            </div>
            <div style={{ display: "flex", alignItems: "center", gap: 10 }}>
              {!collapsed && (
                <>
                  <button onClick={(e) => { e.stopPropagation(); copyLogs(); }} disabled={logs.length === 0} style={{
                    background: "transparent", border: "none", fontSize: 10, fontWeight: 600,
                    cursor: logs.length > 0 ? "pointer" : "default", letterSpacing: "0.06em",
                    color: copyLabel === "COPIED!" ? T.green : (logs.length > 0 ? T.gold : T.border),
                    transition: "color 0.15s",
                  }}>{copyLabel}</button>
                  <button onClick={(e) => { e.stopPropagation(); onClear(); }} disabled={logs.length === 0} style={{
                    background: "transparent", border: "none", color: logs.length > 0 ? T.textMuted : T.border,
                    fontSize: 10, fontWeight: 600, cursor: logs.length > 0 ? "pointer" : "default", letterSpacing: "0.06em",
                  }}>CLEAR</button>
                </>
              )}
              <div style={{
                fontSize: 11, color: T.textSecond,
                transform: collapsed ? "rotate(0deg)" : "rotate(180deg)",
                transition: "transform 0.15s",
              }}>&#9660;</div>
            </div>
          </div>
          {!collapsed && (
            <div ref={logRef} style={{
              background: T.input, border: `1px solid ${T.border}`, borderRadius: 6,
              ...MONO, fontSize: 11.5, lineHeight: 1.7, height: 280, overflowY: "auto", padding: "12px 16px",
              marginTop: 8,
            }}>
              {logs.length === 0 && <div style={{ color: T.textMuted, fontStyle: "italic" }}>The Atlas is quiet... for now.</div>}
              {logs.map((log, i) => (
                <div key={i} style={{ color: log.color || T.textSecond }}>
                  <span style={{ color: T.textMuted }}>{log.time}</span>{" "}
                  {log.message}
                </div>
              ))}
            </div>
          )}
        </div>
      );
    }

    // -----------------------------------------------------------------------
    // Main App
    // -----------------------------------------------------------------------
    function Dashboard() {
      const [status, setStatus] = useState({ state: "stopped", uptime: 0, stats: { uptime_min: 0, triggers: 0, prices_shown: 0, success_rate: 0, cache_items: 0, last_refresh: "never", divine_to_chaos: 0, divine_to_exalted: 0, mirror_to_divine: 0, calibration_samples: 0 } });
      const [settings, setSettings] = useState({ league: "Fate of the Vaal", no_filter_update: false, auto_start: true, font_size: 14, scan_fps: 8, detection_cooldown: 1.0, overlay_duration: 2.0, cursor_still_radius: 20, cursor_still_frames: 3, filter_strictness: "normal", filter_tier_styles: {}, filter_section_visibility: {}, filter_gear_classes: {}, filter_color_preset: "default" });
      const [leagues, setLeagues] = useState([{ value: "Fate of the Vaal", label: "Fate of the Vaal" }]);
      const [logs, setLogs] = useState([]);
      const [autoStartDone, setAutoStartDone] = useState(false);
      const [bugModalOpen, setBugModalOpen] = useState(false);
      const [feedbackModal, setFeedbackModal] = useState(null); // null | "feedback" | "feature"
      const [filterUpdating, setFilterUpdating] = useState(false);
      const [activeTab, setActiveTab] = useState("overlay");
      const [watchlistResults, setWatchlistResults] = useState({});
      const [queryStates, setQueryStates] = useState({});
      const [updateInfo, setUpdateInfo] = useState(null);
      const logRef = useRef(null);
      const autoScrollRef = useRef(true);

      // Auto-scroll log panel
      useEffect(() => {
        if (logRef.current && autoScrollRef.current) {
          logRef.current.scrollTop = logRef.current.scrollHeight;
        }
      }, [logs]);

      // Track if user has scrolled up
      useEffect(() => {
        const el = logRef.current;
        if (!el) return;
        const onScroll = () => {
          const atBottom = el.scrollHeight - el.scrollTop - el.clientHeight < 40;
          autoScrollRef.current = atBottom;
        };
        el.addEventListener("scroll", onScroll);
        return () => el.removeEventListener("scroll", onScroll);
      }, []);

      // WebSocket handler
      const handleWsMessage = useCallback((msg) => {
        switch (msg.type) {
          case "init":
            setStatus({ state: msg.state, uptime: msg.uptime, stats: msg.stats });
            if (msg.settings) setSettings(msg.settings);
            if (msg.log && msg.log.length > 0) {
              setLogs(msg.log);
            }
            if (msg.watchlist_results) setWatchlistResults(msg.watchlist_results);
            if (msg.watchlist_states) setQueryStates(msg.watchlist_states);
            break;
          case "log":
            setLogs(prev => {
              const next = [...prev, { time: msg.time, message: msg.message, color: msg.color }];
              return next.length > 500 ? next.slice(-500) : next;
            });
            break;
          case "status":
            setStatus(prev => ({ ...prev, state: msg.state, uptime: msg.uptime, stats: msg.stats }));
            break;
          case "state_change":
            setStatus(prev => ({ ...prev, state: msg.state }));
            break;
          case "settings":
            if (msg.settings) setSettings(msg.settings);
            break;
          case "watchlist_result":
            if (msg.result) {
              setWatchlistResults(prev => ({ ...prev, [msg.result.query_id]: msg.result }));
            }
            break;
          case "watchlist_state":
            if (msg.states) {
              setQueryStates(msg.states);
            }
            break;
          case "update_available":
            setUpdateInfo({ current: msg.current, latest: msg.latest, url: msg.url, setup_url: msg.setup_url || "" });
            break;
          case "update_progress":
            setUpdateInfo(prev => prev ? { ...prev, progress: msg.percent, installing: msg.installing || false } : prev);
            break;
          case "app_restart":
            // Server is restarting — close the pywebview window so the old process exits cleanly
            if (window.pywebview && window.pywebview.api) {
              window.pywebview.api.close();
            } else {
              window.close();
            }
            break;
        }
      }, []);

      const { connected } = useDashboardSocket(WS_URL, handleWsMessage);

      // Fetch leagues on mount
      useEffect(() => {
        api("/api/leagues").then(data => {
          if (data.leagues && data.leagues.length > 0) {
            setLeagues(data.leagues);
          }
        });
      }, []);

      // Auto-start overlay on mount
      useEffect(() => {
        if (autoStartDone) return;
        if (!connected) return;

        setAutoStartDone(true);

        // Small delay to let init message arrive
        const timer = setTimeout(() => {
          setStatus(prev => {
            // Only auto-start if not already running and auto_start is enabled
            if (prev.state !== "running" && prev.state !== "starting") {
              // Check settings from the latest state
              api("/api/settings").then(s => {
                if (s.auto_start !== false) {
                  api("/api/start", "POST");
                }
              });
            }
            return prev;
          });
        }, 500);

        return () => clearTimeout(timer);
      }, [connected, autoStartDone]);

      // Handlers
      const handleStart = () => api("/api/start", "POST");
      const handleStop = () => api("/api/stop", "POST");
      const handleRestart = () => api("/api/restart", "POST");

      const handleLeagueChange = (league) => {
        const newSettings = { ...settings, league };
        setSettings(newSettings);
        api("/api/settings", "POST", { league });
      };

      const handleSettingsUpdate = (updates) => {
        const newSettings = { ...settings, ...updates };
        setSettings(newSettings);
        api("/api/settings", "POST", updates);
      };

      const handleRestartApp = () => api("/api/restart-app", "POST");

      const handleWatchlistRefresh = (queryId) => {
        api(`/api/watchlist/refresh/${queryId}`, "POST");
      };

      const handleUpdateFilter = async () => {
        setFilterUpdating(true);
        const res = await api("/api/update-filter", "POST");
        setFilterUpdating(false);
        if (res.error) {
          console.error("Filter update failed:", res.error);
        }
      };

      return (
        <div className="app-frame">
          <WindowTitleBar
            wsConnected={connected}
            overlayState={status.state}
            onStart={handleStart}
            onStop={handleStop}
            onRestart={handleRestart}
          />
          <GoldDivider />
          {updateInfo && (
            <div style={{ maxWidth: 1050, margin: "0 auto", padding: "4px 24px" }}>
              <div style={{ background: "rgba(196,164,86,0.12)", border: `1px solid ${T.gold}`, borderRadius: 8, padding: "8px 14px" }}>
                <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between" }}>
                  <span style={{ color: T.gold, fontSize: 12, fontWeight: 600, display: "flex", alignItems: "center", gap: 6 }}>
                    <span style={{ display: "inline-block", width: 5, height: 5, background: T.gold, transform: "rotate(45deg)", flexShrink: 0 }} />
                    {updateInfo.installing ? "Installing update..." : `Update available: v${updateInfo.latest}`}
                    {!updateInfo.installing && <span style={{ color: T.textSecond, fontWeight: 400, marginLeft: 8 }}>(current: v{updateInfo.current})</span>}
                  </span>
                  <span style={{ display: "flex", gap: 8 }}>
                    {updateInfo.installing ? null : updateInfo.progress != null ? null : updateInfo.setup_url ? (
                      <button onClick={() => api("/api/apply-update", "POST")} style={{ ...BTN, background: T.gold, color: "#0d0b08", padding: "4px 12px", fontSize: 10 }}>Install Update</button>
                    ) : (
                      <a href={updateInfo.url} target="_blank" rel="noopener noreferrer" style={{ ...BTN, background: T.gold, color: "#0d0b08", textDecoration: "none", padding: "4px 12px", fontSize: 10 }}>Download</a>
                    )}
                    {!updateInfo.installing && updateInfo.progress == null && (
                      <button onClick={() => setUpdateInfo(null)} style={{ ...BTN, background: "transparent", border: `1px solid ${T.border}`, color: T.textSecond, padding: "4px 8px", fontSize: 10 }}>Dismiss</button>
                    )}
                  </span>
                </div>
                {updateInfo.progress != null && (
                  <div style={{ marginTop: 6 }}>
                    <div style={{ background: "rgba(255,255,255,0.08)", borderRadius: 4, height: 5, overflow: "hidden" }}>
                      <div style={{ background: T.gold, height: "100%", width: `${updateInfo.progress}%`, borderRadius: 4, transition: "width 0.3s ease" }} />
                    </div>
                    <div style={{ color: T.textSecond, fontSize: 10, marginTop: 3, textAlign: "center" }}>
                      {updateInfo.installing ? "Launching installer..." : `Downloading: ${updateInfo.progress}%`}
                    </div>
                  </div>
                )}
              </div>
            </div>
          )}
          <StatusPanel status={status} />
          <div style={{ maxWidth: 1050, margin: "0 auto", padding: "0 24px" }}>
            <TabBar activeTab={activeTab} onTabChange={setActiveTab} />
          </div>
          <div style={{ flex: 1, overflowY: "auto", scrollbarGutter: "stable", minHeight: 0 }}>
            <div style={{ maxWidth: 1050, margin: "0 auto", padding: "0 24px 16px" }}>
              {activeTab === "overlay" && (
                <>
                  <OverlaySettingsTab settings={settings} onUpdate={handleSettingsUpdate} overlayState={status.state} />
                  <LogPanel logs={logs} logRef={logRef} onClear={() => setLogs([])} />
                </>
              )}
              {activeTab === "filter" && (
                <FilterTab
                  settings={settings}
                  onUpdate={handleSettingsUpdate}
                  onUpdateFilter={handleUpdateFilter}
                  filterUpdating={filterUpdating}
                />
              )}
              {activeTab === "watchlist" && (
                <WatchlistTab
                  settings={settings}
                  watchlistResults={watchlistResults}
                  queryStates={queryStates}
                  onSettingsUpdate={handleSettingsUpdate}
                  onRefresh={handleWatchlistRefresh}
                />
              )}
            </div>
          </div>
          <BrandFooter
            leagues={leagues}
            selectedLeague={settings.league}
            onLeagueChange={handleLeagueChange}
            onBugReport={() => setBugModalOpen(true)}
            onFeedback={() => setFeedbackModal("feedback")}
            onFeatureRequest={() => setFeedbackModal("feature")}
            onRestartApp={handleRestartApp}
          />
          <BugReportModal open={bugModalOpen} onClose={() => setBugModalOpen(false)} />
          <FeedbackModal open={!!feedbackModal} feedbackType={feedbackModal || "feedback"} onClose={() => setFeedbackModal(null)} />
        </div>
      );
    }

    // -----------------------------------------------------------------------
    // Mount
    // -----------------------------------------------------------------------
    ReactDOM.createRoot(document.getElementById("root")).render(<Dashboard />);
  </script>
</body>
</html>
